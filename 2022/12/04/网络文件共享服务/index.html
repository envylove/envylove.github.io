<!DOCTYPE html><html lang="zh-CN" data-default-color-scheme="auto"><head><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.ico"><link rel="icon" href="/img/favicon.ico"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests"><meta name="theme-color" content="#2f4154"><meta name="author" content="yuankun"><meta name="keywords" content="hexo,theme,fluid,linux,ops,运维,分享"><meta name="description" content="Network File System 网络文件系统，基于内核的文件系统。Sun 公司开发，通过使用 NFS，用户和程序可以像访问本地文件一样访问远端系统上的文件"><meta property="og:type" content="article"><meta property="og:title" content="网络文件共享服务"><meta property="og:url" content="https://itshare.work/2022/12/04/%E7%BD%91%E7%BB%9C%E6%96%87%E4%BB%B6%E5%85%B1%E4%BA%AB%E6%9C%8D%E5%8A%A1/index.html"><meta property="og:site_name" content="echops-懂运维的测试"><meta property="og:description" content="Network File System 网络文件系统，基于内核的文件系统。Sun 公司开发，通过使用 NFS，用户和程序可以像访问本地文件一样访问远端系统上的文件"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://itshare.work/banner_img/default.png"><meta property="article:published_time" content="2022-12-04T04:03:44.000Z"><meta property="article:modified_time" content="2022-12-16T14:57:05.620Z"><meta property="article:author" content="yuankun"><meta property="article:tag" content="Linux从入门到放弃"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image" content="https://itshare.work/banner_img/default.png"><title>网络文件共享服务 - echops-懂运维的测试</title><link rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css"><link rel="stylesheet" href="/css/main.css"><link id="highlight-css" rel="stylesheet" href="/css/highlight.css"><link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css"><link rel="stylesheet" href="/css/tbdzj.css"><script id="fluid-configs">var Fluid=window.Fluid||{};Fluid.ctx=Object.assign({},Fluid.ctx);var CONFIG={hostname:"itshare.work",root:"/",version:"1.9.3",typing:{enable:!1,typeSpeed:70,cursorChar:" ",loop:!0,scope:[]},anchorjs:{enable:!0,element:"h1,h2,h3,h4,h5,h6",placement:"left",visible:"hover",icon:""},progressbar:{enable:!0,height_px:3,color:"#29d",options:{showSpinner:!1,trickleSpeed:100}},code_language:{enable:!0,default:"text"},copy_btn:!0,image_caption:{enable:!0},image_zoom:{enable:!0,img_url_replace:["",""]},toc:{enable:!0,placement:"right",headingSelector:"h1,h2,h3,h4,h5,h6",collapseDepth:0},lazyload:{enable:!0,loading_img:"/img/loading.gif",onlypost:!1,offset_factor:2},web_analytics:{enable:!0,follow_dnt:!0,baidu:null,google:null,gtag:null,tencent:{sid:null,cid:null},woyaola:null,cnzz:null,leancloud:{app_id:"hQDROocUhxVs3CipuQjO33sY-gzGzoHsz",app_key:"CHcmi9bz6KRRaChFJVSY14g1",server_url:"https://hqdroocu.lc-cn-n1-shared.com",path:"window.location.pathname",ignore_local:!0}},search_path:"/local-search.xml"};if(CONFIG.web_analytics.follow_dnt){var dntVal=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack;Fluid.ctx.dnt=dntVal&&(dntVal.startsWith("1")||dntVal.startsWith("yes")||dntVal.startsWith("on"))}</script><script src="/js/utils.js"></script><script src="/js/color-schema.js"></script><meta name="generator" content="Hexo 6.3.0"></head><body><header><div class="header-inner" style="height:70vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/"><strong>Echops</strong> </a><button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/"><i class="iconfont icon-home-fill"></i> 首页</a></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" target="_self" href="javascript:;" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><i class="iconfont icon-books"></i> 文章</a><div class="dropdown-menu" aria-labelledby="navbarDropdown"><a class="dropdown-item" href="/archives/"><i class="iconfont icon-archive-fill"></i> 归档 </a><a class="dropdown-item" href="/categories/"><i class="iconfont icon-category-fill"></i> 分类 </a><a class="dropdown-item" href="/tags/"><i class="iconfont icon-tags-fill"></i> 标签</a></div></li><li class="nav-item"><a class="nav-link" href="/about/"><i class="iconfont icon-user-fill"></i> 关于</a></li><li class="nav-item"><a class="nav-link" href="/links/"><i class="iconfont icon-link-fill"></i> 友链</a></li><li class="nav-item" id="search-btn"><a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">&nbsp;<i class="iconfont icon-search"></i>&nbsp;</a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a></li></ul></div></div></nav><div id="banner" class="banner" parallax="true" style="background:url(/../banner_img/wallhaven-x8ye3z.jpg) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="banner-text text-center fade-in-up"><div class="h2"><span id="subtitle">网络文件共享服务</span></div><div class="mt-3"><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2022-12-04 12:03" pubdate>2022年12月4日 中午</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 20k 字 </span><span class="post-meta mr-2"><i class="iconfont icon-clock-fill"></i> 164 分钟 </span><span id="leancloud-page-views-container" class="post-meta" style="display:none"><i class="iconfont icon-eye" aria-hidden="true"></i> <span id="leancloud-page-views"></span> 次</span></div></div></div></div></div></div></header><main><div class="container-fluid nopadding-x"><div class="row nomargin-x"><div class="side-col d-none d-lg-block col-lg-2"></div><div class="col-lg-8 nopadding-x-md"><div class="container nopadding-x-md" id="board-ctn"><div id="board"><article class="post-content mx-auto"><h1 style="display:none">网络文件共享服务</h1><p class="note note-info">本文最后更新于：2022年12月16日 晚上</p><div class="markdown-body"><h1 id="NFS服务"><a href="#NFS服务" class="headerlink" title="NFS服务"></a>NFS服务</h1><h2 id="NFS工作原理"><a href="#NFS工作原理" class="headerlink" title="NFS工作原理"></a>NFS工作原理</h2><p><img src="/../image.assets/1670127215657.png" srcset="/img/loading.gif" lazyload alt="1670127215657"></p><p>NFS：Network File System 网络文件系统，基于内核的文件系统。Sun 公司开发，通过使用 NFS，用户和程序可以像访问本地文件一样访问远端系统上的文件，基于RPC（Remote Procedure CallProtocol 远程过程调用）实现。<br>RPC采用C&#x2F;S模式，客户机请求程序调用进程发送一个有进程参数的调用信息到服务进程，然后等待应答信息。在服务器端，进程保持睡眠状态直到调用信息到达为止。当一个调用信息到达，服务器获得进程参数，计算结果，发送答复信息，然后等待下一个调用信息，最后，客户端调用进程接收答复信息，获得进程结果，然后调用执行继续进行。</p><p><img src="/../image.assets/1670127252975.png" srcset="/img/loading.gif" lazyload alt="1670127252975"></p><p>NFS优势：节省本地存储空间，将常用的数据,如：&#x2F;home目录，存放在NFS服务器上且可以通过网络访<br>问，本地终端将可减少自身存储空间的使用。</p><h2 id="NFS软件介绍"><a href="#NFS软件介绍" class="headerlink" title="NFS软件介绍"></a>NFS软件介绍</h2><p>软件包：nfs-utils（包括服务器和客户端相关工具，CentOS8 最小化安装时默认没有安装），nfs-common(Ubuntu中包名)<br>相关软件包：rpcbind（必须），tcp_wrappers<br>Kernel支持：nfs.ko<br>端口：2049(nfsd), 其它端口由portmap(111)分配<br>NFS服务主要进程：</p><ul><li>rpc.nfsd 最主要的NFS进程，管理客户端是否可登录</li><li>rpc.mountd 挂载和卸载NFS文件系统，包括权限管理</li><li>rpc.lockd 非必要，管理文件锁，避免同时写出错</li><li>rpc.statd 非必要，检查文件一致性，可修复文件</li></ul><p>说明：CentOS 6 开始portmap进程由rpcbind代替<br>日志：&#x2F;var&#x2F;lib&#x2F;nfs&#x2F;<br>NFS配置文件</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs text">/etc/exports<br>/etc/exports.d/*.exports<br></code></pre></td></tr></table></figure><p>常用选项</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs text">默认选项：(ro,sync,root_squash,no_all_squash)<br>ro,rw 只读和读写<br>async 异步，数据变化后不立即写磁盘，先写入到缓冲区中，过一段时间再写入磁盘，性能高,安全性低<br>sync（1.0.0后为默认）同步，数据在请求时立即写入共享存储磁盘,性能低,安全性高<br>root_squash （默认）远程root映射为nfsnobody,UID为65534，CentOS8 为nobody,CentOS<br>7以前的版本为nfsnobody<br>no_root_squash 远程root映射成NFS服务器的root用户<br>all_squash 所有远程用户(包括root)都变成nfsnobody,CentOS8 为nobody<br>no_all_squash （默认）保留共享文件的UID和GID<br>anonuid和anongid 指明匿名用户映射为特定用户UID和组GID，而非nobody,可配合all_squash使<br>用<br></code></pre></td></tr></table></figure><h2 id="NFS工具"><a href="#NFS工具" class="headerlink" title="NFS工具"></a>NFS工具</h2><h3 id="rpcinfo"><a href="#rpcinfo" class="headerlink" title="rpcinfo"></a>rpcinfo</h3><p>rpcinfo 工具可以查看RPC相关信息<br>查看注册在指定主机的RPC程序</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs text">rpcinfo -p hostname<br></code></pre></td></tr></table></figure><p>查看RPC注册程序</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs text">rpcinfo -s hostname<br></code></pre></td></tr></table></figure><h3 id="exportfs"><a href="#exportfs" class="headerlink" title="exportfs"></a>exportfs</h3><p>exportfs:可用于管理NFS导出的文件系统<br>常见选项</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs text">-v #查看本机所有NFS共享<br>-r #重读配置文件，并共享目录<br>-a #输出本机所有共享<br>-au #停止本机所有共享<br></code></pre></td></tr></table></figure><h3 id="showmount"><a href="#showmount" class="headerlink" title="showmount"></a>showmount</h3><p>常见用法：</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs text">#查看远程主机的NFS共享<br>showmount -e hostname<br></code></pre></td></tr></table></figure><h3 id="mount-nfs"><a href="#mount-nfs" class="headerlink" title="mount.nfs"></a>mount.nfs</h3><p>客户端NFS挂载<br>NFS相关的挂载选项：man 5 nfs</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs text">fg #（默认）前台挂载<br>bg #后台挂载<br>hard #（默认）持续请求<br>soft #非持续请求<br>intr #和hard配合，请求可中断<br>rsize #和wsize 一次读和写数据最大字节数，rsize=32768<br>_netdev #无网络服务时不挂载NFS资源<br>vers #指定版本，客户端centos8默认4.2 ，centos7默认4.1 centos6默认4.0<br></code></pre></td></tr></table></figure><p>提示：基于安全考虑，建议使用 nosuid,<em>netdev,noexec 挂载选项</em></p><h1 id="实战案例"><a href="#实战案例" class="headerlink" title="实战案例"></a>实战案例</h1><p><img src="/../image.assets/1670246134779.png" srcset="/img/loading.gif" lazyload alt="1670246134779"></p><ul><li>NFS服务器安装软件</li></ul><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs text">yum install -y nfs-utils<br><br># 启动rpcbind<br>systemctl start rpcbind<br><br># 启动nfs-server<br>systemctl start nfs-server<br></code></pre></td></tr></table></figure><ul><li>NFS服务器创建共享文件</li></ul><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs text"># 共享根目录下的share目录<br>mkdir /share<br></code></pre></td></tr></table></figure><ul><li>添加uid和gid为300的用户nfs-upload</li></ul><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs text">[root@centos7-master ~]# groupadd -g 300 nfs-upload<br>[root@centos7-master ~]# useradd -u 300 -g 300 nfs-upload<br>[root@centos7-master ~]# <br>#修改所属组权限<br>[root@centos7-master share]# chown -R 300:300 /share<br></code></pre></td></tr></table></figure><ul><li>修改NFS服务器配置文件</li></ul><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs text">[root@centos7-master ~]# vim /etc/exports<br># 加入如下内容，*表示任何人，rw表示读写<br>/share/ 192.168.179.*(rw,anongid=300,anonuid=300)<br></code></pre></td></tr></table></figure><ul><li>重新加载配置</li></ul><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs text"># 重新加载配置文件<br>[root@centos7-master ~]# exportfs -r<br>[root@centos7-master ~]# exportfs -v<br>/share        	192.168.179.*(sync,wdelay,hide,no_subtree_check,anonuid=300,anongid=300,sec=sys,rw,secure,root_squash,no_all_squash)<br>[root@centos7-master ~]# <br></code></pre></td></tr></table></figure><ul><li>客户端安装软件</li></ul><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs text">yum install -y nfs-utils<br><br># 启动rpcbind<br>systemctl start rpcbind<br><br># 启动nfs-server<br>systemctl start nfs-server<br></code></pre></td></tr></table></figure><ul><li>添加用户和组</li></ul><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs text">[root@centos7-slave /]# groupadd -g 300 nfs-upload<br>[root@centos7-slave /]# useradd -u 300 -g 300 nfs-upload<br></code></pre></td></tr></table></figure><ul><li>在客户端挂载，挂载&#x2F;nfsshare目录下</li></ul><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs text"># 创建目录<br>mkdir /nfsshare<br># 查看服务器端可挂载点<br>[root@centos7-slave ~]# showmount -e 192.168.179.170<br>Export list for 192.168.179.170:<br>/share *<br>[root@centos7-slave nfsshare]# <br><br># 挂载方式1，关机重启会失效<br>[root@centos7-slave ~]# mount 192.168.179.170:/share/ /nfsshare<br><br># 方式二修改配置文件，关机重启不失效<br>[root@centos7-slave ~]# vim /etc/fstab <br># 加入如下内容<br>192.168.179.170:/share                    /nfsshare  nfs     defaults,_netdev 0 0<br># 使配置文件生效<br>[root@centos7-slave nfsshare]# mount -a<br>[root@centos7-slave nfsshare]# <br></code></pre></td></tr></table></figure><ul><li>测试</li></ul><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs text"># 在客户端上查看/nfsshare的内容<br>[root@centos7-slave nfsshare]# ll<br>total 8<br>-rw-r--r-- 1 nfs-upload nfs-upload  5 Dec  5 23:14 a.xtx<br>drwxr-xr-x 2 nfs-upload nfs-upload  6 Dec  5 23:17 newfile<br>-rw-r--r-- 1 nfs-upload nfs-upload 17 Dec  5 23:11 test.log<br>[root@centos7-slave nfsshare]# <br><br># 在服务器端查看/share目录<br>[root@centos7-master share]# ll<br>total 8<br>-rw-r--r-- 1 nfs-upload nfs-upload  5 Dec  5 23:14 a.xtx<br>drwxr-xr-x 2 nfs-upload nfs-upload  6 Dec  5 23:17 newfile<br>-rw-r--r-- 1 nfs-upload nfs-upload 17 Dec  5 23:11 test.log<br>[root@centos7-master share]#<br></code></pre></td></tr></table></figure><h1 id="数据的实时同步"><a href="#数据的实时同步" class="headerlink" title="数据的实时同步"></a>数据的实时同步</h1><h3 id="实时同步技术介绍"><a href="#实时同步技术介绍" class="headerlink" title="实时同步技术介绍"></a>实时同步技术介绍</h3><p>实现实时同步的方法</p><ul><li>inotify + rsync 方式实现数据同步</li><li>sersync ：前金山公司周洋（花椒直播）在 inotify 软件基础上进行开发的，功能更加强大</li></ul><p>工作原理：</p><ul><li>要利用监控服务（inotify），监控同步数据服务器目录中信息的变化</li><li>发现目录中数据产生变化，就利用rsync服务推送到备份服务器上</li></ul><p>inotify：<br>异步的文件系统事件监控机制，利用事件驱动机制，而无须通过诸如cron等的轮询机制来获取事件，linux内核从2.6.13起支持 inotify，通过inotify可以监控文件系统中添加、删除，修改、移动等各种事件</p><p><strong>实现inotify软件：</strong></p><ul><li>inotify-tools</li><li>sersync</li><li>lrsyncd</li></ul><p><strong>inotify+rsync使用方式</strong></p><ul><li>inotify 对同步数据目录信息的监控</li><li>rsync 完成对数据的同步</li><li>利用脚本进行结合</li></ul><h3 id="实现-inotify"><a href="#实现-inotify" class="headerlink" title="实现 inotify"></a>实现 inotify</h3><p>内核是否支持inotify<br>Linux支持inotify的内核最小版本为 2.6.13，参看man 7 inotify</p><p><strong>inotify 内核参数说明：</strong></p><ul><li>max_queued_events：inotify 事件队列最大长度，如值太小会出现 Event Queue Overflow 错<br>误，默认值：16384, 生产环境建议调大,比如:327679</li><li>max_user_instances：每个用户创建inotify实例最大值，默认值：128</li><li>max_user_watches：可以监视的文件的总数量（inotifywait 单进程），默认值：8192,建议调大</li></ul><h4 id="inotify-tools工具"><a href="#inotify-tools工具" class="headerlink" title="inotify-tools工具"></a>inotify-tools工具</h4><p>inotify-tools参考文档：<a target="_blank" rel="noopener" href="https://github.com/rvoicilas/inotify-tools/wiki">https://github.com/rvoicilas/inotify-tools/wiki</a><br>安装inotify-tools：基于epel源</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs text">yum install epel-release<br>yum -y install inotify-tools<br></code></pre></td></tr></table></figure><p><strong>inotify-tools包主要工具：</strong></p><ul><li>inotifywait： 在被监控的文件或目录上等待特定文件系统事件（open ，close，delete等）发生，<br>常用于实时同步的目录监控</li><li>inotifywatch：收集被监控的文件系统使用的统计数据，指文件系统事件发生的次数统计</li></ul><p>inotifywait 命令<br>格式:</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs text">inotifywait [ options ] file1 [ file2 ] [ file3 ] [ ... ]<br></code></pre></td></tr></table></figure><p>常用选项</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs text">-m, --monitor 始终保持事件监听<br>-d, --daemon 以守护进程方式执行，和-m相似，配合-o使用<br>-r, --recursive 递归监控目录数据信息变化<br>-q, --quiet 输出少量事件信息<br>--exclude &lt;pattern&gt; 指定排除文件或目录，使用扩展的正则表达式匹配的模式实现<br>--excludei &lt;pattern&gt; 和exclude相似，不区分大小写<br>-o, --outfile &lt;file&gt; 打印事件到文件中，相当于标准正确输出，注意：使用绝对路径<br>-s, --syslogOutput 发送错误到syslog相当于标准错误输出<br>--timefmt &lt;fmt&gt; 指定时间输出格式<br>--format &lt;fmt&gt; 指定的输出格式；即实际监控输出内容<br>-e<br></code></pre></td></tr></table></figure><p><strong>inotifywait 的–timefmt 时间格式</strong><br>参考 man 3 strftime</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs text">%Y #年份信息，包含世纪信息<br>%y #年份信息，不包括世纪信息<br>%m #显示月份，范围 01-12<br>%d #每月的第几天，范围是 01-31<br>%H #小时信息，使用 24小时制，范围 00-23<br>%M #分钟，范围 00-59<br>%S #秒，范例 0-60<br></code></pre></td></tr></table></figure><p>范例：</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs text">--timefmt &quot;%Y-%m-%d %H:%M:%S&quot;<br></code></pre></td></tr></table></figure><p><strong>inotifywait 的 –format 格式定义</strong></p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs text">%T #输出时间格式中定义的时间格式信息，通过 --timefmt option 语法格式指定时间信息<br>%w #事件出现时，监控文件或目录的名称信息，相当于dirname<br>%f #事件出现时，将显示监控目录下触发事件的文件或目录信息，否则为空，相当于basename<br>%e #显示发生的事件信息，不同的事件默认用逗号分隔<br>%Xe #显示发生的事件信息，不同的事件指定用X进行分隔<br></code></pre></td></tr></table></figure><p>范例</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs text">--format &quot;%T %w%f event: %;e&quot;<br>--format &#x27;%T %w %f&#x27;<br></code></pre></td></tr></table></figure><p>inotifywait -e 选项指定的事件类型</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs text">create #文件或目录创建<br>delete #文件或目录被删除<br>modify #文件或目录内容被写入<br>attrib #文件或目录属性改变<br>close_write #文件或目录关闭，在写入模式打开之后关闭的<br>close_nowrite #文件或目录关闭，在只读模式打开之后关闭的<br>close #文件或目录关闭，不管读或是写模式<br>open #文件或目录被打开<br>lsdir #浏览目录内容<br>moved_to #文件或目录被移动到监控的目录中<br>moved_from #文件或目录从监控的目录中被移动<br>move #文件或目录不管移动到或是移出监控目录都触发事件<br>access #文件或目录内容被读取<br>delete_self #文件或目录被删除，目录本身被删除<br>unmount #取消挂载<br></code></pre></td></tr></table></figure><p>范例</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs text">-e create,delete,moved_to,close_write,attrib<br></code></pre></td></tr></table></figure><p>范例：使用inotifywait</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs text"># 监控一次事件<br>[root@centos7 /]# inotifywait /data/www/<br>Setting up watches.<br>Watches established.<br>/data/www/ CREATE,ISDIR html<br>[root@centos7 /]# <br><br># 持续前台监控<br>[root@centos7 /]# inotifywait -mrq /data/www --exclude=&quot;.*\.swx|\.swp&quot;<br>/data/www/ OPEN,ISDIR <br>/data/www/ CLOSE_NOWRITE,CLOSE,ISDIR <br>/data/www/ CREATE mysql.log<br>/data/www/ OPEN mysql.log<br>/data/www/ ATTRIB mysql.log<br>/data/www/ CLOSE_WRITE,CLOSE mysql.log<br>/data/www/ OPEN,ISDIR <br>/data/www/ CLOSE_NOWRITE,CLOSE,ISDIR <br>/data/www/ MODIFY mysql.log<br>/data/www/ OPEN mysql.log<br>/data/www/ MODIFY mysql.log<br>/data/www/ CLOSE_WRITE,CLOSE mysql.log<br>/data/www/ OPEN,ISDIR <br>/data/www/ CLOSE_NOWRITE,CLOSE,ISDIR <br>/data/www/ OPEN mysql.log<br>/data/www/ ACCESS mysql.log<br>/data/www/ CLOSE_NOWRITE,CLOSE mysql.log<br><br>#持续后台监控，并记录日志<br>inotifywait -o /root/inotify.log -drq /data/www --timefmt &quot;%Y-%m-%d %H:%M:%S&quot; --<br>format &quot;%T %w%f event: %e&quot;<br>#持续前台监控特定事件<br>inotifywait -mrq /data/www --timefmt &quot;%F %H:%M:%S&quot; --format &quot;%T %w%f event:<br>%;e&quot; -e create,delete,moved_to,close_write,attrib<br></code></pre></td></tr></table></figure><h2 id="rsync-服务"><a href="#rsync-服务" class="headerlink" title="rsync 服务"></a>rsync 服务</h2><p>rsync 常用于做为 linux系统下的数据镜像备份工具，实现远程同步，支持本地复制，或者与其他SSH、<br>rsync主机同步数据，支持增量备份，配合任务计划，rsync能实现定时或间隔同步，配合inotify或<br>sersync，可以实现触发式的实时数据同步<br>官方网站: <a target="_blank" rel="noopener" href="http://rsync.samba.org/">http://rsync.samba.org/</a></p><p>软件包：rsync，rsync-daemon（CentOS 8）<br>服务文件：&#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;rsyncd.service<br>配置文件：&#x2F;etc&#x2F;rsyncd.conf<br>端口：873&#x2F;tcp</p><h4 id="rsync命令"><a href="#rsync命令" class="headerlink" title="rsync命令"></a>rsync命令</h4><p>rsync 格式</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs text">#Local:<br>rsync [OPTION...] SRC... [DEST]<br>#Access via remote shell:<br>Pull:<br>rsync [OPTION...] [USER@]HOST:SRC... [DEST]<br>Push:<br>rsync [OPTION...] SRC... [USER@]HOST:DEST<br>#Access via rsync daemon:<br>Pull:<br>rsync [OPTION...] [USER@]HOST::SRC... [DEST]<br>rsync [OPTION...] rsync://[USER@]HOST[:PORT]/SRC... [DEST]<br>Push:<br>rsync [OPTION...] SRC... [USER@]HOST::DEST<br>rsync [OPTION...] SRC... rsync://[USER@]HOST[:PORT]/DEST<br>The &#x27;:&#x27; usages connect via remote shell, while &#x27;::&#x27; &amp; &#x27;rsync://&#x27; usages connect<br>to an rsync daemon, and require SRC or DEST to start with a module name.<br></code></pre></td></tr></table></figure><p>rsync有三种工作方式：</p><ol><li>本地文件系统上实现同步。命令行语法格式为上述”Local”段的格式。</li><li>本地主机使用远程shell和远程主机通信。命令行语法格式为上述”Access via remote shell”段的格<br>式。</li><li>本地主机通过网络套接字连接远程主机上的rsync daemon。命令行语法格式为上述”Access via<br>rsync daemon”段的格式。<br>前两者的本质是通过本地或远程shell，而第3种方式则是让远程主机上运行rsyncd服务，使其监听在一<br>个端口上，等待客户端的连接。<br>常见选项：</li></ol><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs text">-v：显示rsync过程中详细信息。可以使用&quot;-vvvv&quot;获取更详细信息。<br>-P：显示文件传输的进度信息。(实际上&quot;-P&quot;=&quot;--partial --progress&quot;，其中的&quot;--progress&quot;才是显<br>示进度信息的)。<br>-n --dry-run ：仅测试传输，而不实际传输。常和&quot;-vvvv&quot;配合使用来查看rsync是如何工作的。<br>-a --archive ：归档模式，表示递归传输并保持文件属性。等同于&quot;-rtopgDl&quot;。<br>-r --recursive：递归到目录中去。<br>-t --times：保持mtime属性。强烈建议任何时候都加上&quot;-t&quot;，否则目标文件mtime会设置为系统时间，导<br>致下次更新<br>：检查出mtime不同从而导致增量传输无效。<br>-o --owner：保持owner属性(属主)。<br>-g --group：保持group属性(属组)。<br>-p --perms：保持perms属性(权限，不包括特殊权限)<br>-D ：是&quot;--device --specials&quot;选项的组合，即也拷贝设备文件和特殊文件。<br>-l --links：如果文件是软链接文件，则拷贝软链接本身而非软链接所指向的对象<br>-z ：传输时进行压缩提高效率<br>-R --relative：使用相对路径。意味着将命令行中指定的全路径而非路径最尾部的文件名发送给服务端，<br>包括它们的属性。用法见下文示例。<br>--size-only ：默认算法是检查文件大小和mtime不同的文件，使用此选项将只检查文件大小。<br>-u --update ：仅在源mtime比目标已存在文件的mtime新时才拷贝。注意，该选项是接收端判断的，不会<br>影响删除行为。<br>-d --dirs ：以不递归的方式拷贝目录本身。默认递归时，如果源为&quot;dir1/file1&quot;，则不会拷贝dir1<br>目录，使用该选项将拷贝dir1但不拷贝file1。<br>--max-size ：限制rsync传输的最大文件大小。可以使用单位后缀，还可以是一个小数值(例如：&quot;--<br>max-size=1.5m&quot;)<br>--min-size ：限制rsync传输的最小文件大小。这可以用于禁止传输小文件或那些垃圾文件。<br>--exclude ：指定排除规则来排除不需要传输的文件。<br>--delete ：以SRC为主，对DEST进行同步。多则删之，少则补之。注意&quot;--delete&quot;是在接收端执行<br>的，所以它是在<br>：exclude/include规则生效之后才执行的。<br>-b --backup ：对目标上已存在的文件做一个备份，备份的文件名后默认使用&quot;~&quot;做后缀。<br>--backup-dir：指定备份文件的保存路径。不指定时默认和待备份文件保存在同一目录下。<br>-e ：指定所要使用的远程shell程序，默认为ssh。<br>--port ：连接daemon时使用的端口号，默认为873端口。<br>--password-file：daemon模式时的密码文件，可以从中读取密码实现非交互式。注意，这不是远程shell<br>认证的密码，而是rsync模块认证的密码。<br>-W --whole-file：rsync将不再使用增量传输，而是全量传输。在网络带宽高于磁盘带宽时，该选项比增<br>量传输更高效。<br>--existing ：要求只更新目标端已存在的文件，目标端还不存在的文件不传输。注意，使用相对路径时如<br>果上层目录不存在也不会传输。<br>--ignore-existing：要求只更新目标端不存在的文件。和&quot;--existing&quot;结合使用有特殊功能，见下文示<br>例。<br>--remove-source-files：要求删除源端已经成功传输的文件<br></code></pre></td></tr></table></figure><p>范例：两种格式访问 rsync daemon 服务</p><p><img src="/../image.assets/1670396738139.png" srcset="/img/loading.gif" lazyload alt="1670396738139"></p><ul><li>环境</li></ul><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs text">data-server:192.168.179.171(数据服务器)<br>backup-server:192.168.179.165(备份服务器)<br></code></pre></td></tr></table></figure><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs text">#在备份服务器启动 rsync 进程<br>[root@centos8-backup ~]#rsync --daemon<br>Failed to parse config file: /etc/rsyncd.conf<br>[root@centos8-backup ~]#touch /etc/rsyncd.conf<br>[root@centos8-backup ~]#rsync --daemon<br>[root@centos8-backup /]# cat /etc/rsyncd.conf <br>[backup]<br>path = /web/www/<br>read only = no <br>[root@centos8-backup /]# <br>#指定目录给nobody权限，默认用户以nobody访问此目录<br>[root@centos8-backup ~]#setfacl -m u:nobody:rwx /data/backup/<br>#查看rsync服务器的模块名称<br>[root@centos7-slave /]# rsync rsync://192.168.179.165<br>backup    	<br>[root@centos7-slave /]# <br>[root@centos7-slave /]# rsync 192.168.179.165::<br>backup<br><br>#访问rsync服务器的共享目录<br>#推<br>[root@centos7-slave /]# rsync /xy.log 192.168.179.165::backup<br>[root@centos7-slave /]# rsync /etc/shells rsync://root@192.168.179.165/backup<br><br>[root@centos7-slave /]#rsync 192.168.179.165::backup/* /opt<br>[root@centos7-slave /]#rsync rsync://192.168.179.165/backup/* /mnt<br></code></pre></td></tr></table></figure><p>范例：以独立服务方式运行 rsync</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><code class="hljs text"># 修改配置文件<br>[root@centos8-backup etc]# cat rsyncd.conf<br>#uid = root #提定以哪个用户来访问共享目录，将之指定为生成的文件所有者，默认为nobody<br>#gid = root #默认为nobody,Ubuntu中为nogroup<br>#port = 874 可指定非标准端口,默认873/tcp<br>#use chroot = no<br>#max connections = 0<br>#ignore errors<br>#exclude = lost+found/<br>#log file = /var/log/rsyncd.log<br>#pid file = /var/run/rsyncd.pid<br>#lock file = /var/run/rsyncd.lock<br>#reverse lookup = no<br>#hosts allow = 10.0.0.0/24<br>#[backup] #每个模块名对应一个不同的path目录，如果同名后面模块生效<br>#path = /data/backup/<br>#comment = backup dir<br>#read only = no #默认是yes,即只读<br>#auth users = rsyncuser #默认anonymous可以访问rsync服务器<br>#secrets file = /etc/rsync.pas<br># /etc/rsyncd: configuration file for rsync daemon mode<br><br># See rsyncd.conf man page for more options.<br><br># configuration example:<br><br># uid = nobody<br># gid = nobody<br># use chroot = yes<br># max connections = 4<br># pid file = /var/run/rsyncd.pid<br># exclude = lost+found/<br># transfer logging = yes<br># timeout = 900<br># ignore nonreadable = yes<br># dont compress   = *.gz *.tgz *.zip *.z *.Z *.rpm *.deb *.bz2<br><br># [ftp]<br>#        path = /home/ftp<br>#        comment = ftp export area<br><br><br>uid = root <br>gid = root  <br>max connections = 0<br>ignore errors<br>exclude = lost+found/<br>log file = /var/log/rsyncd.log<br>pid file = /var/run/rsyncd.pid<br>lock file = /var/run/rsyncd.lock<br>reverse lookup = no<br><br>[backup] <br>path = /web/backup/  <br>comment = backup dir<br>read only = no <br>auth users = rsyncuser  <br>secrets file = /etc/rsync.pas<br><br>[root@centos8-backup etc]# <br><br><br>#服务器端生成验证文件<br>[root@centos8-backup ~]#echo &quot;rsyncuser:123456&quot; &gt; /etc/rsync.pas<br>[root@centos8-backup ~]#chmod 600 /etc/rsync.pas<br><br>#服务器端启动rsync服务<br>[root@centos8-backup ~]#rsync --daemon #可加入/etc/rc.d/rc.local实现开<br>机启动<br><br>#客户端配置密码文件<br>#也可将密码赋值给环境变量RSYNC_PASSWORD变量,但不安全<br>#export RSYNC_PASSWORD=123456<br>[root@centos7-slave ~]#echo &quot;123456&quot; &gt; /etc/rsync.pas<br>[root@centos7-slave ~]#chmod 600 /etc/rsync.pas #此为必要项,权限必须修改<br><br>#查看远程rsync服务器的模块信息<br>[root@centos7-slave etc]# rsync rsync://192.168.179.165<br>backup         	backup dir<br>[root@centos7-slave etc]# <br><br>#交互式验证查看具体模块内的文件<br>[root@centos7-slave etc]# rsync rsync://rsyncuser@192.168.179.165/backup<br>Password: <br><br>#非交互式查看共享目录<br>[root@centos7-slave etc]# rsync --password-file=/etc/rsync.pas rsync://rsyncuser@192.168.179.165/backup<br>drwxrwxrwx             34 2022/12/07 16:20:07 .<br>-rw-r--r--              0 2022/12/07 16:20:07 xy.log<br>-rw-r--r--              0 2022/12/07 16:09:50 zz.log<br>[root@centos7-slave etc]# <br><br><br>#客户端测试同步数据<br>[root@data-centos8 ~]#rsync -avz --delete --password-file=/etc/rsync.pas /data/www/ rsyncuser@rsync服务器IP::backup<br>[root@data-centos8 ~]#rsync -avz --delete --password-file=/etc/rsync.pas rsyncuser@rsync服务器IP::backup /data/www/<br></code></pre></td></tr></table></figure><h3 id="inotify-rsync-shell-脚本实现实时数据同步"><a href="#inotify-rsync-shell-脚本实现实时数据同步" class="headerlink" title="inotify+rsync+shell 脚本实现实时数据同步"></a>inotify+rsync+shell 脚本实现实时数据同步</h3><p><img src="/../image.assets/1670403695085.png" srcset="/img/loading.gif" lazyload alt="1670403695085"></p><p>按 5.3 搭建好 rsyncd的备份服务器，在数据服务器上创建inotify_rsync.sh脚本<br>注意: 此脚本执行前先确保两主机初始数据处于同步状态,此脚本实现后续的数据同步</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs text">[root@centos7-slave ~]# vim inotify_rsync.sh <br>#!/bin/bash<br>SRC=&#x27;/data/www/&#x27; #注意最后的/<br>DEST=&#x27;rsyncuser@rsync服务器IP::backup&#x27;<br>rpm -q inotify-tools &amp;&gt; /dev/null ||yum -y install inotify-tools<br>rpm -q rsync &amp;&gt; /dev/null || yum -y install rsync<br>inotifywait -mrq --exclude=&quot;.*\.swp&quot; --timefmt &#x27;%Y-%m-%d %H:%M:%S&#x27; --format<br>&#x27;%T %w %f&#x27; -e create,delete,moved_to,close_write,attrib $&#123;SRC&#125; |while read DATE<br>TIME DIR FILE;do<br>FILEPATH=$&#123;DIR&#125;$&#123;FILE&#125;<br>rsync -az --delete --password-file=/etc/rsync.pas $SRC $DEST &amp;&amp; echo<br>&quot;At $&#123;TIME&#125; on $&#123;DATE&#125;, file $FILEPATH was backuped up via rsync&quot; &gt;&gt;<br>/var/log/changelist.log<br>done<br>#查看文件传输日志<br>[root@centos7-slave www]# tail -f /var/log/changelist.log <br></code></pre></td></tr></table></figure><h2 id="sersync-实现实时数据同步"><a href="#sersync-实现实时数据同步" class="headerlink" title="sersync 实现实时数据同步"></a>sersync 实现实时数据同步</h2><h3 id="sersync-介绍"><a href="#sersync-介绍" class="headerlink" title="sersync 介绍"></a>sersync 介绍</h3><p>sersync类似于inotify，同样用于监控，但它克服了inotify的缺点.<br>inotify最大的不足是会产生重复事件，或者同一个目录下多个文件的操作会产生多个事件，例如，当监<br>控目录中有5个文件时，删除目录时会产生6个监控事件，从而导致重复调用rsync命令。另外比如：vim<br>文件时，inotify会监控到临时文件的事件，但这些事件相对于rsync来说是不应该被监控的</p><p><strong>sersync 优点：</strong></p><ul><li>sersync是使用c++编写，而且对linux系统文件系统产生的临时文件和重复的文件操作进行过滤，<br>所以在结合rsync同步的时候，节省了运行时耗和网络资源。因此更快。</li><li>sersync配置很简单，其中提供了静态编译好的二进制文件和xml配置文件，直接使用即可</li><li>sersync使用多线程进行同步，尤其在同步较大文件时，能够保证多个服务器实时保持同步状态</li><li>sersync有出错处理机制，通过失败队列对出错的文件重新同步，如果仍旧失败，则按设定时长对<br>同步失败的文件重新同步</li><li>sersync不仅可以实现实时同步，另外还自带crontab功能，只需在xml配置文件中开启，即也可以<br>按要求隔一段时间整体同步一次，而无需再额外配置crontab功能</li><li>sersync 可以二次开发</li></ul><p>sersync项目地址： <a target="_blank" rel="noopener" href="https://code.google.com/archive/p/sersync/">https://code.google.com/archive/p/sersync/</a><br>sersync下载地址： <a target="_blank" rel="noopener" href="https://code.google.com/archive/p/sersync/downloads">https://code.google.com/archive/p/sersync/downloads</a></p><h3 id="基于rsync-daemon-实现-sersync"><a href="#基于rsync-daemon-实现-sersync" class="headerlink" title="基于rsync daemon 实现 sersync"></a>基于rsync daemon 实现 sersync</h3><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><code class="hljs text"># #在数据服务器上下载sersync，并拷贝至相应的目录，设置PATH变量<br>wget https://storage.googleapis.com/google-code-archive-downloads/v2/code.google.com/sersync/sersync2.5.4_64bit_binary_stable_final.tar.gz<br><br>[root@centos7-slave ~]# tar -vxf sersync2.5.4_64bit_binary_stable_final.tar.gz <br>[root@centos7-slave ~]# cp -r GNU-Linux-x86/ /usr/local/sersync<br>[root@centos7-slave sersync]# echo &#x27;PATH=/usr/local/sersync:$PATH&#x27; &gt; /etc/profile.d/sersync.sh<br>[root@centos7-slave sersync]# source /etc/profile.d/sersync.sh<br>[root@centos7-slave sersync]# <br><br>#确认安装rsync客户端工具<br>rpm -q rsync &amp;&gt; /dev/null || dnf -y install rsync<br><br>#备份sersync配置文件<br>cp /usr/local/sersync/confxml.xml&#123;,.bak&#125;<br># 修改配置文件<br>vim /usr/local/sersync/confxml.xml<br>&lt;?xml version=&quot;1.0&quot; encoding=&quot;ISO-8859-1&quot;?&gt;<br>&lt;head version=&quot;2.5&quot;&gt;<br>&lt;host hostip=&quot;localhost&quot; port=&quot;8008&quot;&gt;&lt;/host&gt;<br>&lt;debug start=&quot;false&quot;/&gt; # 是否开启调试模式<br>&lt;fileSystem xfs=&quot;false&quot;/&gt;<br>&lt;filter start=&quot;false&quot;&gt; #不开启文件过滤功能，当为true时,以下类型的文件将不同<br>步<br>&lt;exclude expression=&quot;(.*)\.svn&quot;&gt;&lt;/exclude&gt;<br>&lt;exclude expression=&quot;(.*)\.gz&quot;&gt;&lt;/exclude&gt;<br>&lt;exclude expression=&quot;^info/*&quot;&gt;&lt;/exclude&gt;<br>&lt;exclude expression=&quot;^static/*&quot;&gt;&lt;/exclude&gt;<br>&lt;/filter&gt;<br>&lt;inotify&gt; # 监控事件，默认监控<br>delete/close_write/moved_from/moved_to/create folder<br>&lt;delete start=&quot;true&quot;/&gt;<br>&lt;createFolder start=&quot;true&quot;/&gt;<br>&lt;createFile start=&quot;false&quot;/&gt;<br>&lt;closeWrite start=&quot;true&quot;/&gt;<br>&lt;moveFrom start=&quot;true&quot;/&gt;<br>&lt;moveTo start=&quot;true&quot;/&gt;<br>&lt;attrib start=&quot;true&quot;/&gt; #修改此行为true，文件属性变化后也会同步<br>&lt;modify start=&quot;false&quot;/&gt;<br>&lt;/inotify&gt;<br>&lt;sersync&gt; # rsync命令的配置段<br>&lt;localpath watch=&quot;/data/www&quot;&gt; #修改此行,需要同步的源目录或文件，建议同步目<br>录<br>&lt;remote ip=&quot;备份服务器IP&quot; name=&quot;backup&quot;/&gt; #修改此行,指定备份服务器地址和rsync<br>daemon的模块名，如果下面开启了ssh start，此时name为远程shell方式运行时的目标目录<br>&lt;!--&lt;remote ip=&quot;192.168.8.39&quot; name=&quot;tongbu&quot;/&gt;--&gt;<br>&lt;!--&lt;remote ip=&quot;192.168.8.40&quot; name=&quot;tongbu&quot;/&gt;--&gt;<br>&lt;/localpath&gt;<br>&lt;rsync&gt;<br>&lt;commonParams params=&quot;-artuz&quot;/&gt; # 指定rsync选项<br>&lt;auth start=&quot;true&quot; users=&quot;rsyncuser&quot; passwordfile=&quot;/etc/rsync.pas&quot;/&gt; #修<br>改此行为true,指定备份服务器的rsync配置的用户和密码文件<br>&lt;userDefinedPort start=&quot;false&quot; port=&quot;874&quot;/&gt;&lt;!-- port=874 --&gt;#指定rsync的非<br>标准端口号<br>&lt;timeout start=&quot;false&quot; time=&quot;100&quot;/&gt;&lt;!-- timeout=100 --&gt;<br>&lt;ssh start=&quot;false&quot;/&gt; #默认使用rsync daemon运行rsync命令,true为使用远程shell模<br>式<br>&lt;/rsync&gt;<br>&lt;failLog path=&quot;/tmp/rsync_fail_log.sh&quot; timeToExecute=&quot;60&quot;/&gt;&lt;!--default every<br>60mins execute once--&gt; #错误重传及日志文件路径<br>&lt;crontab start=&quot;false&quot; schedule=&quot;600&quot;&gt;&lt;!--600mins--&gt; #不开启crontab功能<br>&lt;crontabfilter start=&quot;false&quot;&gt; #不开启crontab定时传输的筛选功能<br>&lt;exclude expression=&quot;*.php&quot;&gt;&lt;/exclude&gt;<br>&lt;exclude expression=&quot;info/*&quot;&gt;&lt;/exclude&gt;<br>&lt;/crontabfilter&gt;<br>&lt;/crontab&gt;<br>&lt;plugin start=&quot;false&quot; name=&quot;command&quot;/&gt;<br>&lt;/sersync&gt;<br>#####################################以下行不需要修改<br>####################################<br>&lt;plugin name=&quot;command&quot;&gt;<br>&lt;param prefix=&quot;/bin/sh&quot; suffix=&quot;&quot; ignoreError=&quot;true&quot;/&gt; &lt;!--prefix<br>/opt/tongbu/mmm.sh suffix--&gt;<br>&lt;filter start=&quot;false&quot;&gt;<br>&lt;include expression=&quot;(.*)\.php&quot;/&gt;<br>&lt;include expression=&quot;(.*)\.sh&quot;/&gt;<br>&lt;/filter&gt;<br>&lt;/plugin&gt;<br>&lt;plugin name=&quot;socket&quot;&gt;<br>&lt;localpath watch=&quot;/opt/tongbu&quot;&gt;<br>&lt;deshost ip=&quot;192.168.138.20&quot; port=&quot;8009&quot;/&gt;<br>&lt;/localpath&gt;<br>&lt;/plugin&gt;<br>&lt;plugin name=&quot;refreshCDN&quot;&gt;<br>&lt;localpath watch=&quot;/data0/htdocs/cms.xoyo.com/site/&quot;&gt;<br>&lt;cdninfo domainname=&quot;ccms.chinacache.com&quot; port=&quot;80&quot; username=&quot;xxxx&quot;<br>passwd=&quot;xxxx&quot;/&gt;<br>&lt;sendurl base=&quot;http://pic.xoyo.com/cms&quot;/&gt;<br> &lt;regexurl regex=&quot;false&quot; match=&quot;cms.xoyo.com/site([/a-zA-Z0-<br>9]*).xoyo.com/images&quot;/&gt;<br>&lt;/localpath&gt;<br>&lt;/plugin&gt;<br>&lt;/head&gt;<br><br><br>#创建连接rsynd服务器的用户密码文件,并必须修改权限<br>echo 123456 &gt; /etc/rsync.pas<br>chmod 600 /etc/rsync.pas<br>#查看帮助<br>sersync2 -h<br>set the system param<br>execute：echo 50000000 &gt; /proc/sys/fs/inotify/max_user_watches<br>execute：echo 327679 &gt; /proc/sys/fs/inotify/max_queued_events<br>parse the command param<br><br>_______________________________________________________<br>参数-d:启用守护进程模式<br>参数-r:在监控前，将监控目录与远程主机用rsync命令推送一遍<br>c参数-n: 指定开启守护线程的数量，默认为10个<br>参数-o:指定配置文件，默认使用当前工作目录下的confxml.xml文件<br>参数-m:单独启用其他模块，使用 -m refreshCDN 开启刷新CDN模块<br>参数-m:单独启用其他模块，使用 -m socket 开启socket模块<br>参数-m:单独启用其他模块，使用 -m http 开启http模块<br>不加-m参数，则默认执行同步程序<br><br><br>#以后台方式执行同步<br>sersync2 -dro /usr/local/sersync/confxml.xml<br><br>#如果同步失败,可以手动执行下面命令,观察过程<br>cd /data/www &amp;&amp; rsync -artuz -R --delete ./ rsyncuser@backup-server::backup --password-file=/etc/rsync.pas &gt;/dev/null 2&gt;&amp;1<br><br>#sersync支持多实例，也即监控多个目录时，只需分别配置不同配置文件，然后使用sersync2指定对应配置文件运行<br>sersync2 -rd -o /etc/sersync.d/nginx.xml<br></code></pre></td></tr></table></figure></div><hr><div><div class="post-metas my-3"><div class="post-meta mr-3 d-flex align-items-center"><i class="iconfont icon-category"></i> <span class="category-chains"><span class="category-chain"><a href="/categories/Linux%E5%9F%BA%E7%A1%80/" class="category-chain-item">Linux基础</a></span></span></div><div class="post-meta"><i class="iconfont icon-tags"></i> <a href="/tags/Linux%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/">#Linux从入门到放弃</a></div></div><div class="license-box my-3"><div class="license-title"><div>网络文件共享服务</div><div>https://itshare.work/2022/12/04/网络文件共享服务/</div></div><div class="license-meta"><div class="license-meta-item"><div>作者</div><div>yuankun</div></div><div class="license-meta-item license-meta-date"><div>发布于</div><div>2022年12月4日</div></div><div class="license-meta-item license-meta-date"><div>更新于</div><div>2022年12月16日</div></div><div class="license-meta-item"><div>许可协议</div><div><a target="_blank" href="https://creativecommons.org/licenses/by/4.0/"><span class="hint--top hint--rounded" aria-label="BY - 署名"><i class="iconfont icon-by"></i></span></a></div></div></div><div class="license-icon iconfont"></div></div><div class="post-prevnext my-3"><article class="post-prev col-6"><a href="/2022/12/07/Redis%E9%83%A8%E7%BD%B2%E5%92%8C%E5%9F%BA%E7%A1%80%E4%BD%BF%E7%94%A8/" title="Redis部署和基础使用"><i class="iconfont icon-arrowleft"></i> <span class="hidden-mobile">Redis部署和基础使用</span> <span class="visible-mobile">上一篇</span></a></article><article class="post-next col-6"><a href="/2022/12/03/%E6%97%A5%E5%BF%97%E6%9C%8D%E5%8A%A1%E7%AE%A1%E7%90%86/" title="日志服务管理"><span class="hidden-mobile">日志服务管理</span> <span class="visible-mobile">下一篇</span> <i class="iconfont icon-arrowright"></i></a></article></div></div><article id="comments" lazyload><div id="valine"></div><script type="text/javascript">Fluid.utils.loadComments("#valine",(function(){Fluid.utils.createScript("https://lib.baomitu.com/valine/1.5.1/Valine.min.js",(function(){var i=Object.assign({appId:"hQDROocUhxVs3CipuQjO33sY-gzGzoHsz",appKey:"CHcmi9bz6KRRaChFJVSY14g1",path:"window.location.pathname",placeholder:"请在这里书写你想说的话······",avatar:"retro",meta:["nick","mail","link"],requiredFields:[],pageSize:10,lang:"zh-CN",highlight:!1,recordIP:!1,serverURLs:"",emojiCDN:null,emojiMaps:null,enableQQ:!1},{el:"#valine",path:window.location.pathname});new Valine(i),Fluid.utils.waitElementVisible("#valine .vcontent",()=>{var i="#valine .vcontent img:not(.vemoji)";Fluid.plugins.imageCaption(i),Fluid.plugins.fancyBox(i)})}))}))</script><noscript>Please enable JavaScript to view the comments</noscript></article></article></div></div></div><div class="side-col d-none d-lg-block col-lg-2"><aside class="sidebar" style="margin-left:-1rem"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p><div class="toc-body" id="toc-body"></div></div></aside></div></div></div><a id="scroll-top-button" aria-label="TOP" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">搜索</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">关键词</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div></main><footer><div class="footer-inner"><div class="footer-content"><span>由<a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a>强力驱动</span> <i class="iconfont icon-love"></i> <span>主题</span> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> <i class="iconfont icon-love"></i> <span>©2022</span></div><div class="statistics"><span id="leancloud-site-pv-container" style="display:none">总访问量 <span id="leancloud-site-pv"></span> 次 </span><span id="leancloud-site-uv-container" style="display:none">总访问客数 <span id="leancloud-site-uv"></span> 人</span></div><div class="beian"><span><a href="http://beian.miit.gov.cn/" target="_blank" rel="nofollow noopener">黔ICP备2022006994号-2 </a></span><span><a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=http://beian.miit.gov.cn/" rel="nofollow noopener" class="beian-police" target="_blank"><span style="visibility:hidden;width:0">|</span> <img src="/img/police_beian.png" srcset="/img/loading.gif" lazyload alt="police-icon"> <span>黔公网安备2022006994号</span></a></span></div></div></footer><script src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js"></script><link rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css"><script>NProgress.configure({showSpinner:!1,trickleSpeed:100}),NProgress.start(),window.addEventListener("load",(function(){NProgress.done()}))</script><script src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js"></script><script src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js"></script><script src="/js/events.js"></script><script src="/js/plugins.js"></script><script src="/js/img-lazyload.js"></script><script>Fluid.utils.createScript("https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js",(function(){var t=jQuery("#toc");if(0!==t.length&&window.tocbot){var i=jQuery("#board-ctn").offset().top;window.tocbot.init(Object.assign({tocSelector:"#toc-body",contentSelector:".markdown-body",linkClass:"tocbot-link",activeLinkClass:"tocbot-active-link",listClass:"tocbot-list",isCollapsedClass:"tocbot-is-collapsed",collapsibleClass:"tocbot-is-collapsible",scrollSmooth:!0,includeTitleTags:!0,headingsOffset:-i},CONFIG.toc)),t.find(".toc-list-item").length>0&&t.css("visibility","visible"),Fluid.events.registerRefreshCallback((function(){if("tocbot"in window){tocbot.refresh();var t=jQuery("#toc");if(0===t.length||!tocbot)return;t.find(".toc-list-item").length>0&&t.css("visibility","visible")}}))}}))</script><script src="https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js"></script><script>Fluid.plugins.codeWidget()</script><script>Fluid.utils.createScript("https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js",(function(){window.anchors.options={placement:CONFIG.anchorjs.placement,visible:CONFIG.anchorjs.visible},CONFIG.anchorjs.icon&&(window.anchors.options.icon=CONFIG.anchorjs.icon);var n=(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","),o=[];for(var s of n)o.push(".markdown-body > "+s.trim());"left"===CONFIG.anchorjs.placement&&(window.anchors.options.class="anchorjs-link-left"),window.anchors.add(o.join(", ")),Fluid.events.registerRefreshCallback((function(){if("anchors"in window){anchors.removeAll();var n=(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","),o=[];for(var s of n)o.push(".markdown-body > "+s.trim());"left"===CONFIG.anchorjs.placement&&(anchors.options.class="anchorjs-link-left"),anchors.add(o.join(", "))}}))}))</script><script>Fluid.utils.createScript("https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js",(function(){Fluid.plugins.fancyBox()}))</script><script>Fluid.plugins.imageCaption()</script><script defer src="/js/leancloud.js"></script><script src="/js/local-search.js"></script><script src="/js/caidai.js"></script><script src="/js/love.main.js"></script><script src="/js/boot.js"></script><noscript><div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div></noscript></body></html>