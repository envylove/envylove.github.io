<!DOCTYPE html><html lang="zh-CN" data-default-color-scheme="auto"><head><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.ico"><link rel="icon" href="/img/favicon.ico"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="theme-color" content="#2f4154"><meta name="author" content="yuankun"><meta name="keywords" content="hexo,theme,fluid,linux,ops,运维,分享"><meta name="description" content="Ansible 的名称来自科幻小说《安德的游戏》中跨越时空的即时通信工具，使用它可以在相距数光年的距离,远程实时控制前线的舰队战斗"><meta property="og:type" content="article"><meta property="og:title" content="运维自动化工具Ansible(二)"><meta property="og:url" content="https://itshare.work/2023/02/25/Ansible2/index.html"><meta property="og:site_name" content="Cookie Blog"><meta property="og:description" content="Ansible 的名称来自科幻小说《安德的游戏》中跨越时空的即时通信工具，使用它可以在相距数光年的距离,远程实时控制前线的舰队战斗"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://itshare.work/image.assets/1677299110747.png"><meta property="og:image" content="https://itshare.work/image.assets/1677310138888.png"><meta property="og:image" content="https://itshare.work/image.assets/1677315798458.png"><meta property="og:image" content="https://itshare.work/image.assets/1677315812687.png"><meta property="og:image" content="https://itshare.work/image.assets/1677315839869.png"><meta property="og:image" content="https://itshare.work/image.assets/1677315862982.png"><meta property="og:image" content="https://itshare.work/image.assets/1677315872464.png"><meta property="og:image" content="https://itshare.work/image.assets/1677315902745.png"><meta property="og:image" content="https://itshare.work/image.assets/1677315975960.png"><meta property="og:image" content="https://itshare.work/image.assets/1677316033321.png"><meta property="og:image" content="https://itshare.work/image.assets/1677662324156.png"><meta property="og:image" content="https://itshare.work/image.assets/1677664119238.png"><meta property="article:published_time" content="2023-02-25T04:21:17.000Z"><meta property="article:modified_time" content="2023-03-03T10:12:30.500Z"><meta property="article:author" content="yuankun"><meta property="article:tag" content="hexo,theme,fluid,linux,ops,运维,分享"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image" content="https://itshare.work/image.assets/1677299110747.png"><title>运维自动化工具Ansible(二) - Cookie Blog</title><link rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css"><link rel="stylesheet" href="/css/main.css"><link id="highlight-css" rel="stylesheet" href="/css/highlight.css"><link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css"><link rel="stylesheet" href="/css/tbdzj.css"><script id="fluid-configs">var Fluid=window.Fluid||{};Fluid.ctx=Object.assign({},Fluid.ctx);var CONFIG={hostname:"itshare.work",root:"/",version:"1.9.3",typing:{enable:!1,typeSpeed:70,cursorChar:" ",loop:!0,scope:[]},anchorjs:{enable:!0,element:"h1,h2,h3,h4,h5,h6",placement:"left",visible:"hover",icon:""},progressbar:{enable:!0,height_px:3,color:"#29d",options:{showSpinner:!1,trickleSpeed:100}},code_language:{enable:!0,default:"text"},copy_btn:!0,image_caption:{enable:!0},image_zoom:{enable:!0,img_url_replace:["",""]},toc:{enable:!0,placement:"right",headingSelector:"h1,h2,h3,h4,h5,h6",collapseDepth:0},lazyload:{enable:!0,loading_img:"/img/loading.gif",onlypost:!1,offset_factor:2},web_analytics:{enable:!0,follow_dnt:!0,baidu:null,google:null,gtag:null,tencent:{sid:null,cid:null},woyaola:null,cnzz:null,leancloud:{app_id:"hQDROocUhxVs3CipuQjO33sY-gzGzoHsz",app_key:"CHcmi9bz6KRRaChFJVSY14g1",server_url:"https://hqdroocu.lc-cn-n1-shared.com",path:"window.location.pathname",ignore_local:!0}},search_path:"/local-search.xml"};if(CONFIG.web_analytics.follow_dnt){var dntVal=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack;Fluid.ctx.dnt=dntVal&&(dntVal.startsWith("1")||dntVal.startsWith("yes")||dntVal.startsWith("on"))}</script><script src="/js/utils.js"></script><script src="/js/color-schema.js"></script><meta name="generator" content="Hexo 6.3.0"></head><body><header><div class="header-inner" style="height:70vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/"><strong>Cookie</strong> </a><button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/"><i class="iconfont icon-home-fill"></i> 首页</a></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" target="_self" href="javascript:;" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><i class="iconfont icon-books"></i> 文章</a><div class="dropdown-menu" aria-labelledby="navbarDropdown"><a class="dropdown-item" href="/archives/"><i class="iconfont icon-archive-fill"></i> 归档 </a><a class="dropdown-item" href="/categories/"><i class="iconfont icon-category-fill"></i> 分类 </a><a class="dropdown-item" href="/tags/"><i class="iconfont icon-tags-fill"></i> 标签</a></div></li><li class="nav-item"><a class="nav-link" href="/about/"><i class="iconfont icon-user-fill"></i> 关于</a></li><li class="nav-item"><a class="nav-link" href="/links/"><i class="iconfont icon-link-fill"></i> 友链</a></li><li class="nav-item" id="search-btn"><a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">&nbsp;<i class="iconfont icon-search"></i>&nbsp;</a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a></li></ul></div></div></nav><div id="banner" class="banner" parallax="true" style="background:url(/img/default.png) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="banner-text text-center fade-in-up"><div class="h2"><span id="subtitle">运维自动化工具Ansible(二)</span></div><div class="mt-3"><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2023-02-25 12:21" pubdate>2023年2月25日 中午</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 38k 字 </span><span class="post-meta mr-2"><i class="iconfont icon-clock-fill"></i> 318 分钟 </span><span id="leancloud-page-views-container" class="post-meta" style="display:none"><i class="iconfont icon-eye" aria-hidden="true"></i> <span id="leancloud-page-views"></span> 次</span></div></div></div></div></div></div></header><main><div class="container-fluid nopadding-x"><div class="row nomargin-x"><div class="side-col d-none d-lg-block col-lg-2"></div><div class="col-lg-8 nopadding-x-md"><div class="container nopadding-x-md" id="board-ctn"><div id="board"><article class="post-content mx-auto"><h1 style="display:none">运维自动化工具Ansible(二)</h1><div class="markdown-body"><h1 id="Playbook"><a href="#Playbook" class="headerlink" title="Playbook"></a>Playbook</h1><h2 id="playbook介绍"><a href="#playbook介绍" class="headerlink" title="playbook介绍"></a>playbook介绍</h2><p>官方链接</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">https:<span class="hljs-regexp">//</span>docs.ansible.com<span class="hljs-regexp">/ansible/</span>latest<span class="hljs-regexp">/user_guide/</span>playbooks_intro.html<br></code></pre></td></tr></table></figure><h3 id="Playbook-组成"><a href="#Playbook-组成" class="headerlink" title="Playbook 组成"></a>Playbook 组成</h3><p><img src="/../image.assets/1677299110747.png" srcset="/img/loading.gif" lazyload alt="1677299110747"></p><ul><li>一个 playbook(剧本)文件是一个YAML语言编写的文本文件</li><li>通常一个playbook只包括一个play</li><li>一个 play的主要包括两部分: 主机和tasks. 即实现在指定一组主机上执行一个tasks定义好的任务列表。</li><li>一个tasks中可以有一个或多个task任务</li><li>每一个Task本质上就是调用ansible的一个module</li><li>在复杂场景中,一个playbook中也可以包括多个play，实现对多组不同的主机执行不同的任务</li></ul><h3 id="Playbook-与-Ad-Hoc-对比"><a href="#Playbook-与-Ad-Hoc-对比" class="headerlink" title="Playbook 与 Ad-Hoc 对比"></a>Playbook 与 Ad-Hoc 对比</h3><ul><li>Playbook是对多个 AD-Hoc 的一种编排组合的实现方式</li><li>Playbook能控制任务执行的先后顺序</li><li>Playbook可以持久保存到文件中从而方便多次调用运行，而Ad-Hoc只能临时运行。</li><li>Playbook适合复杂的重复性的任务，而Ad-Hoc适合做快速简单的一次性任务</li></ul><h2 id="YAML-语言"><a href="#YAML-语言" class="headerlink" title="YAML 语言"></a>YAML 语言</h2><h3 id="YAML-语言介绍"><a href="#YAML-语言介绍" class="headerlink" title="YAML 语言介绍"></a>YAML 语言介绍</h3><p>YAML：YAML Ain’t Markup Language，即YAML不是标记语言。不过，在开发的这种语言时，YAML的<br>意思其实是：”Yet Another Markup Language”（仍是一种标记语言）<br>YAML是一个可读性高的用来表达资料序列的格式。<br>YAML参考了其他多种语言，包括：XML、C语言、Python、Perl以及电子邮件格式RFC2822等。<br>Clark Evans在2001年在首次发表了这种语言，另外Ingy döt Net与Oren Ben-Kiki也是这语言的共同设计者<br>目前很多最新的软件比较流行采用此格式的文件存放配置信息，如:ubuntu，anisble，docker，kubernetes等<br>YAML 官方网站：</p><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs avrasm"><span class="hljs-symbol">http:</span>//www.yaml<span class="hljs-meta">.org</span><br></code></pre></td></tr></table></figure><p>ansible 官网:</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">https:<span class="hljs-regexp">//</span>docs.ansible.com<span class="hljs-regexp">/ansible/</span>latest<span class="hljs-regexp">/reference_appendices/</span>YAMLSyntax.html<br></code></pre></td></tr></table></figure><h3 id="YAML-语言特性"><a href="#YAML-语言特性" class="headerlink" title="YAML 语言特性"></a>YAML 语言特性</h3><ul><li>YAML的可读性好</li><li>YAML和脚本语言的交互性好</li><li>YAML使用实现语言的数据类型</li><li>YAML有一个一致的信息模型</li><li>YAML易于实现</li><li>YAML可以基于流来处理</li><li>YAML表达能力强，扩展性好</li></ul><h3 id="YAML语法简介"><a href="#YAML语法简介" class="headerlink" title="YAML语法简介"></a>YAML语法简介</h3><ul><li>在单一文件第一行，用连续三个连字号”-“ 开始，还有选择性的连续三个点号( … )用来表示文件结尾</li><li>次行开始正常写Playbook的内容，一般建议写明该Playbook的功能</li><li>使用#号注释代码</li><li>缩进的级别也必须是一致的，同样的缩进代表同样的级别，程序判别配置的级别是通过缩进结行来实现的</li><li>缩进不支持tab,必须使用空格进行缩进</li><li>缩进的空格数不重要，只要相同层级的元素左对齐即可</li><li>YAML文件内容是区别大小写的，key&#x2F;value的值均需大小写敏感</li><li>多个key&#x2F;value可同行写也可换行写，同行使用，分隔</li><li>key后面冒号要加一个空格 比如: key: value</li><li>value可是个字符串，也可是另一个列表</li><li>YAML文件扩展名通常为yml或yaml</li></ul><h3 id="支持的数据类型"><a href="#支持的数据类型" class="headerlink" title="支持的数据类型"></a>支持的数据类型</h3><p>YAML 支持以下常用几种数据类型：</p><ul><li>标量：单个的、不可再分的值</li><li>对象：键值对的集合，又称为: 字典（dictionary）&#x2F; 哈希（hashes） &#x2F; 映射（mapping）</li><li>数组：一组按次序排列的值，又称为: 列表（list）&#x2F; 序列（sequence）</li></ul><h4 id="scalar-标量"><a href="#scalar-标量" class="headerlink" title="scalar 标量"></a>scalar 标量</h4><p>key对应value</p><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs avrasm"><span class="hljs-symbol">name:</span> wang<br><span class="hljs-symbol">age:</span> <span class="hljs-number">18</span><br></code></pre></td></tr></table></figure><p>使用缩进的方式</p><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs avrasm"><span class="hljs-symbol">name:</span><br>wang<br><span class="hljs-symbol">age:</span><br><span class="hljs-number">18</span><br></code></pre></td></tr></table></figure><p>标量是最基本的，不可再分的值，包括：</p><ul><li>字符串</li><li>布尔值</li><li>整数</li><li>浮点数</li><li>Null</li><li>时间</li><li>日期</li></ul><h4 id="Dictionary-字典"><a href="#Dictionary-字典" class="headerlink" title="Dictionary 字典"></a>Dictionary 字典</h4><p>一个字典是由一个或多个key与value构成<br>key和value之间用冒号 ：分隔<br>冒号 : 后面有一个空格<br>所有 k&#x2F;v 可以放在一行，,每个 k&#x2F;v 之间用逗号分隔<br>所有每个 k&#x2F;v 也可以分别放在不同行,一对k&#x2F;v放在独立的一行<br>格式</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">account:</span> &#123; <span class="hljs-attr">name:</span> <span class="hljs-string">wang</span>, <span class="hljs-attr">age:</span> <span class="hljs-number">30</span> &#125;<br></code></pre></td></tr></table></figure><p>使用缩进方式</p><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs avrasm"><span class="hljs-symbol">account:</span><br><span class="hljs-symbol">name:</span> wang<br><span class="hljs-symbol">age:</span> <span class="hljs-number">18</span><br></code></pre></td></tr></table></figure><p>范例：</p><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs avrasm"><span class="hljs-meta">#不同行</span><br><span class="hljs-meta"># An employee record</span><br><span class="hljs-symbol">name:</span> Example Developer<br><span class="hljs-symbol">job:</span> Developer<br><span class="hljs-symbol">skill:</span> Elite(社会精英)<br><span class="hljs-meta">#同一行,也可以将key:value放置于&#123;&#125;中进行表示，用,分隔多个key:value</span><br><span class="hljs-meta"># An employee record</span><br>&#123;name: <span class="hljs-string">&quot;Example Developer&quot;</span>, job: <span class="hljs-string">&quot;Developer&quot;</span>, skill: <span class="hljs-string">&quot;Elite&quot;</span>&#125;<br></code></pre></td></tr></table></figure><h4 id="List-列表"><a href="#List-列表" class="headerlink" title="List 列表"></a>List 列表</h4><p>列表由多个元素组成<br>每个元素放在不同行，每个元素一行,且元素前均使用中横线 - 开头，并且中横线 - 和元素之间有一个空格<br>也可以将所有元素用 [ ] 括起来放在同一行,每个元素之间用逗号分隔<br>格式</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">course</span>:<span class="hljs-meta"> [ linux , golang , python ]</span><br></code></pre></td></tr></table></figure><p>也可以写成以 - 开头的多行</p><figure class="highlight nestedtext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs nestedtext"><span class="hljs-attribute">course</span><span class="hljs-punctuation">:</span><br>	<span class="hljs-bullet">-</span> <span class="hljs-string">linux</span><br>	<span class="hljs-bullet">-</span> <span class="hljs-string">golang</span><br>	<span class="hljs-bullet">-</span> <span class="hljs-string">python</span><br><span class="hljs-attribute">course</span><span class="hljs-punctuation">:</span><br>	<span class="hljs-bullet">-</span> <span class="hljs-string">linux: manjaro</span><br>	<span class="hljs-bullet">-</span> <span class="hljs-string">golang: gin</span><br>	<span class="hljs-bullet">-</span> <span class="hljs-string">python: django</span><br></code></pre></td></tr></table></figure><p>范例：</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs markdown"><span class="hljs-section">#不同行,行以-开头,后面有一个空格</span><br><span class="hljs-section"># A list of tasty fruits</span><br><span class="hljs-bullet">-</span> Apple<br><span class="hljs-bullet">-</span> Orange<br><span class="hljs-bullet">-</span> Strawberry<br><span class="hljs-bullet">-</span> Mango<br><span class="hljs-section">#同一行</span><br>[Apple,Orange,Strawberry,Mango]<br></code></pre></td></tr></table></figure><p>范例：YAML 表示一个家庭</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">name:</span> <span class="hljs-string">John</span> <span class="hljs-string">Smith</span><br><span class="hljs-attr">age:</span> <span class="hljs-number">41</span><br><span class="hljs-attr">gender:</span> <span class="hljs-string">Male</span><br><span class="hljs-attr">spouse:</span> &#123; <span class="hljs-attr">name:</span> <span class="hljs-string">Jane</span> <span class="hljs-string">Smith</span>, <span class="hljs-attr">age:</span> <span class="hljs-number">37</span>, <span class="hljs-attr">gender:</span> <span class="hljs-string">Female</span> &#125; <span class="hljs-comment"># 写在一行里</span><br>	<span class="hljs-attr">name:</span> <span class="hljs-string">Jane</span> <span class="hljs-string">Smith</span> <span class="hljs-comment">#也可以写成多行</span><br>	<span class="hljs-attr">age:</span> <span class="hljs-number">37</span><br>	<span class="hljs-attr">gender:</span> <span class="hljs-string">Female</span><br>	<span class="hljs-attr">children:</span> [ &#123;<span class="hljs-attr">name:</span> <span class="hljs-string">Jimmy</span> <span class="hljs-string">Smith</span>,<span class="hljs-attr">age:</span> <span class="hljs-number">17</span>, <span class="hljs-attr">gender:</span> <span class="hljs-string">Male</span>&#125;, &#123;<span class="hljs-attr">name:</span> <span class="hljs-string">Jenny</span> <span class="hljs-string">Smith</span>, 		<span class="hljs-string">age:13</span>, <span class="hljs-attr">gender:</span> <span class="hljs-string">Female</span>&#125;, &#123;<span class="hljs-attr">name:</span> <span class="hljs-string">hao</span> <span class="hljs-string">Smith</span>, <span class="hljs-attr">age:</span> <span class="hljs-number">20</span>, <span class="hljs-attr">gender:</span> <span class="hljs-string">Male</span> &#125; ] <span class="hljs-comment">#写在一行</span><br>	<span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Jimmy</span> <span class="hljs-string">Smith</span> <span class="hljs-comment">#写在多行,更为推荐的写法</span><br>		<span class="hljs-attr">age:</span> <span class="hljs-number">17</span><br>		<span class="hljs-attr">gender:</span> <span class="hljs-string">Male</span><br>	<span class="hljs-bullet">-</span> &#123;<span class="hljs-attr">name:</span> <span class="hljs-string">Jenny</span> <span class="hljs-string">Smith</span>, <span class="hljs-attr">age:</span> <span class="hljs-number">13</span>, <span class="hljs-attr">gender:</span> <span class="hljs-string">Female</span>&#125;<br>	<span class="hljs-bullet">-</span> &#123;<span class="hljs-attr">name:</span> <span class="hljs-string">hao</span> <span class="hljs-string">Smith</span>, <span class="hljs-attr">age:</span> <span class="hljs-number">20</span>, <span class="hljs-attr">gender:</span> <span class="hljs-string">Male</span> &#125;<br></code></pre></td></tr></table></figure><h3 id="三种常见的数据格式"><a href="#三种常见的数据格式" class="headerlink" title="三种常见的数据格式"></a>三种常见的数据格式</h3><ul><li>XML：Extensible Markup Language，可扩展标记语言，可用于数据交换和配置</li><li>JSON：JavaScript Object Notation, JavaScript 对象表记法，主要用来数据交换或配置，不支持注释</li><li>YAML：YAML Ain’t Markup Language YAML 不是一种标记语言， 主要用来配置，大小写敏感，不支持tab</li></ul><p><img src="/../image.assets/1677310138888.png" srcset="/img/loading.gif" lazyload alt="1677310138888"></p><p>可以用工具互相转换，参考网站：<br><a target="_blank" rel="noopener" href="https://www.json2yaml.com/">https://www.json2yaml.com/</a><br><a target="_blank" rel="noopener" href="http://www.bejson.com/json/json2yaml/">http://www.bejson.com/json/json2yaml/</a></p><h2 id="Playbook-核心组件"><a href="#Playbook-核心组件" class="headerlink" title="Playbook 核心组件"></a>Playbook 核心组件</h2><p>官方文档</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">https:<span class="hljs-regexp">//</span>docs.ansible.com<span class="hljs-regexp">/ansible/</span>latest<span class="hljs-regexp">/reference_appendices/</span>playbooks_keywords.html<span class="hljs-comment">#playbook-keywords</span><br></code></pre></td></tr></table></figure><p>一个playbook 中由多个组件组成,其中所用到的常见组件类型如下:</p><ul><li>Hosts 执行的远程主机列表</li><li>Tasks 任务集,由多个task的元素组成的列表实现,每个task是一个字典,一个完整的代码块功能需少元素需包括 name 和 task,一个name只能包括一个task</li><li>Variables 内置变量或自定义变量在playbook中调用</li><li>Templates 模板，可替换模板文件中的变量并实现一些简单逻辑的文件</li><li>Handlers 和 notify 结合使用，由特定条件触发的操作，满足条件方才执行，否则不执行</li><li>tags 标签 指定某条任务执行，用于选择运行playbook中的部分代码。ansible具有幂等性，因此 会自动跳过没有变化的部分，即便如此，有些代码为测试其确实没有发生变化的时间依然会非常地长。此时，如果确信其没有变化，就可以通过tags跳过此些代码片断</li></ul><h3 id="hosts-组件"><a href="#hosts-组件" class="headerlink" title="hosts 组件"></a>hosts 组件</h3><p>Hosts：playbook中的每一个play的目的都是为了让特定主机以某个指定的用户身份执行任务。hosts用于指定要执行指定任务的主机，须事先定义在主机清单中</p><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs avrasm">one.example.com<br><span class="hljs-symbol">one.example.com:</span>two.example.com<br><span class="hljs-number">192.168</span><span class="hljs-number">.1</span><span class="hljs-number">.50</span><br><span class="hljs-number">192.168</span><span class="hljs-number">.1</span>.*<br><span class="hljs-symbol">Websrvs:</span>dbsrvs <span class="hljs-meta">#或者，两个组的并集</span><br><span class="hljs-symbol">Websrvs:</span>&amp;dbsrvs <span class="hljs-meta">#与，两个组的交集</span><br><span class="hljs-symbol">webservers:</span>!dbsrvs <span class="hljs-meta">#在websrvs组，但不在dbsrvs组</span><br></code></pre></td></tr></table></figure><p>案例：</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc"><span class="hljs-bullet">- </span>hosts: websrvs:appsrvs<br></code></pre></td></tr></table></figure><h3 id="remote-user-组件"><a href="#remote-user-组件" class="headerlink" title="remote_user 组件"></a>remote_user 组件</h3><p>remote_user: 可用于Host和task中。也可以通过指定其通过sudo的方式在远程主机上执行任务，其可用于play全局或某任务；此外，甚至可以在sudo时使用sudo_user指定sudo时切换的用户</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">websrvs</span><br>  <span class="hljs-attr">remote_user:</span> <span class="hljs-string">root</span><br>  <span class="hljs-attr">tasks:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">test</span> <span class="hljs-string">connection</span><br>    <span class="hljs-attr">ping:</span><br>    <span class="hljs-attr">remote_user:</span> <span class="hljs-string">magedu</span><br>    <span class="hljs-attr">sudo:</span> <span class="hljs-literal">yes</span> <span class="hljs-comment">#默认sudo为root</span><br>    <span class="hljs-string">sudo_user:wang</span> <span class="hljs-comment">#sudo为wang</span><br></code></pre></td></tr></table></figure><h3 id="task列表和action组件"><a href="#task列表和action组件" class="headerlink" title="task列表和action组件"></a>task列表和action组件</h3><p>play的主体部分是task list，task list中有一个或多个task,各个task 按次序逐个在hosts中指定的所有主机上执行，即在所有主机上完成第一个task后，再开始第二个task<br>task的目的是使用指定的参数执行模块，而在模块参数中可以使用变量。模块执行是幂等的，这意味着多次执行是安全的，因为其结果均一致<br>每个task都应该有其name，用于playbook的执行结果输出，建议其内容能清晰地描述任务执行步骤。<br>如果未提供name，则action的结果将用于输出<br>task两种格式：</p><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs clean">action: <span class="hljs-keyword">module</span> arguments #示例: action: shell wall hello<br><span class="hljs-keyword">module</span>: arguments #建议使用 #示例: shell: wall hello<br></code></pre></td></tr></table></figure><p>注意：shell和command模块后面跟命令，而非key&#x3D;value<br>范例:</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs yaml">[<span class="hljs-string">root@ansible</span> <span class="hljs-string">ansible</span>]<span class="hljs-comment">#cat hello.yml</span><br><span class="hljs-meta">---</span><br><span class="hljs-comment">#first yaml文件</span><br><span class="hljs-comment">#</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">websrvs</span><br>  <span class="hljs-attr">remote_user:</span> <span class="hljs-string">root</span><br>  <span class="hljs-attr">gather_facts:</span> <span class="hljs-literal">no</span><br>  <span class="hljs-attr">tasks:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">task1</span><br>      <span class="hljs-attr">debug:</span> <span class="hljs-string">msg=&quot;task1</span> <span class="hljs-string">running&quot;</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">task2</span><br>      <span class="hljs-attr">debug:</span> <span class="hljs-string">msg=&quot;task2</span> <span class="hljs-string">running&quot;</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">appsrvs</span><br>  <span class="hljs-attr">remote_user:</span> <span class="hljs-string">root</span><br>  <span class="hljs-attr">gather_facts:</span> <span class="hljs-literal">no</span><br>  <span class="hljs-attr">tasks:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">task3</span><br>      <span class="hljs-attr">debug:</span> <span class="hljs-string">msg=&quot;task3</span> <span class="hljs-string">running&quot;</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">task4</span><br>      <span class="hljs-attr">debug:</span> <span class="hljs-string">msg=&quot;task4</span> <span class="hljs-string">running&quot;</span><br></code></pre></td></tr></table></figure><h3 id="其它组件说明"><a href="#其它组件说明" class="headerlink" title="其它组件说明"></a>其它组件说明</h3><p>某任务的状态在运行后为changed时，可通过”notify”通知给相应的handlers任务<br>还可以通过”tags”给task 打标签，可在ansible-playbook命令上使用-t指定进行调用</p><h3 id="ShellScripts-VS-Playbook-案例"><a href="#ShellScripts-VS-Playbook-案例" class="headerlink" title="ShellScripts VS Playbook 案例"></a>ShellScripts VS Playbook 案例</h3><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-comment">#SHELL脚本实现</span><br><span class="hljs-comment">#!/bin/bash</span><br><span class="hljs-comment"># 安装Apache</span><br>yum install --quiet -y httpd<br><span class="hljs-comment"># 复制配置文件</span><br>cp <span class="hljs-regexp">/tmp/</span>httpd.conf <span class="hljs-regexp">/etc/</span>httpd<span class="hljs-regexp">/conf/</span>httpd.conf<br>cp<span class="hljs-regexp">/tmp/</span>vhosts.conf <span class="hljs-regexp">/etc/</span>httpd<span class="hljs-regexp">/conf.d/</span><br><span class="hljs-comment"># 启动Apache，并设置开机启动</span><br>systemctl enable --now httpd<br><span class="hljs-comment">#Playbook实现</span><br>---<br>- hosts: websrvs<br>  remote_user: root<br>  gather_facts: no<br>  tasks:<br>  - name: <span class="hljs-string">&quot;安装Apache&quot;</span><br>    yum: name=httpd<br>  - name: <span class="hljs-string">&quot;复制配置文件&quot;</span><br>	copy: src=<span class="hljs-regexp">/tmp/</span>httpd.conf dest=<span class="hljs-regexp">/etc/</span>httpd<span class="hljs-regexp">/conf/</span><br>  - name: <span class="hljs-string">&quot;复制配置文件&quot;</span><br>	copy: src=<span class="hljs-regexp">/tmp/</span>vhosts.conf dest=<span class="hljs-regexp">/etc/</span>httpd<span class="hljs-regexp">/conf.d/</span><br>  - name: <span class="hljs-string">&quot;启动Apache，并设置开机启动&quot;</span><br>	service: name=httpd state=started enabled=yes<br></code></pre></td></tr></table></figure><h2 id="playbook-命令"><a href="#playbook-命令" class="headerlink" title="playbook 命令"></a>playbook 命令</h2><p>格式</p><figure class="highlight sas"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sas">ansible-playbook &lt;<span class="hljs-keyword">filename</span>.yml&gt; ... [<span class="hljs-keyword">options</span>]<br></code></pre></td></tr></table></figure><p>选项</p><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli"><span class="hljs-params">--syntax</span>,<span class="hljs-params">--syntax-check</span> <span class="hljs-comment">#语法检查,功能相当于bash -n</span><br>-C <span class="hljs-params">--check</span> <span class="hljs-comment">#模拟执行dry run ,只检测可能会发生的改变，但不真正执行操作</span><br><span class="hljs-params">--list-hosts</span> <span class="hljs-comment">#列出运行任务的主机</span><br><span class="hljs-params">--list-tags</span> <span class="hljs-comment">#列出tag</span><br><span class="hljs-params">--list-tasks</span> <span class="hljs-comment">#列出task</span><br><span class="hljs-params">--limit</span> 主机列表 <span class="hljs-comment">#只针对主机列表中的特定主机执行</span><br>-i INVENTORY, <span class="hljs-params">--inventory</span> INVENTORY <span class="hljs-comment">#指定主机清单文件,通常一个项对应一个主机清单文件</span><br><span class="hljs-params">--start-at-task</span> START_AT_TASK <span class="hljs-comment">#从指定task开始执行,而非从头开始,START_AT_TASK为任务的name</span><br>-v -vv -vvv <span class="hljs-comment">#显示过程</span><br></code></pre></td></tr></table></figure><p>范例: 一个简单的 playbook</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs yaml">[<span class="hljs-string">root@ansible</span> <span class="hljs-string">ansible</span>]<span class="hljs-comment">#cat hello.yml</span><br><span class="hljs-meta">---</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">websrvs</span><br>  <span class="hljs-attr">tasks:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">hello</span><br>      <span class="hljs-attr">command:</span> <span class="hljs-string">echo</span> <span class="hljs-string">&quot;hello ansible&quot;</span><br>[<span class="hljs-string">root@ansible</span> <span class="hljs-string">ansible</span>]<span class="hljs-comment">#ansible-playbook hello.yml</span><br>[<span class="hljs-string">root@ansible</span> <span class="hljs-string">ansible</span>]<span class="hljs-comment">#ansible-playbook -v hello.yml</span><br></code></pre></td></tr></table></figure><p>范例: 检查和限制主机</p><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs applescript">ansible-playbook <span class="hljs-built_in">file</span>.yml <span class="hljs-comment">--check #只检测</span><br>ansible-playbook <span class="hljs-built_in">file</span>.yml<br>ansible-playbook <span class="hljs-built_in">file</span>.yml <span class="hljs-comment">--limit websrvs</span><br></code></pre></td></tr></table></figure><p>范例: 一个playbook 多个play</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">cat</span> <span class="hljs-string">test_plays.yaml</span><br><span class="hljs-meta">---</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">localhost</span><br>  <span class="hljs-attr">remote_user:</span> <span class="hljs-string">root</span><br>  <span class="hljs-attr">gather_facts:</span> <span class="hljs-literal">no</span><br>  <span class="hljs-attr">tasks:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">play1</span><br>      <span class="hljs-attr">command:</span> <span class="hljs-string">echo</span> <span class="hljs-string">&quot;play1&quot;</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">centos7</span><br>  <span class="hljs-attr">remote_user:</span> <span class="hljs-string">root</span><br>  <span class="hljs-attr">gather_facts:</span> <span class="hljs-literal">no</span><br>  <span class="hljs-attr">tasks:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">play2</span><br>      <span class="hljs-attr">command:</span> <span class="hljs-string">echo</span> <span class="hljs-string">&quot;play2&quot;</span><br></code></pre></td></tr></table></figure><h2 id="忽略错误-ignore-errors"><a href="#忽略错误-ignore-errors" class="headerlink" title="忽略错误 ignore_errors"></a>忽略错误 ignore_errors</h2><p>如果一个task出错,默认将不会继续执行后续的其它task<br>利用 ignore_errors: yes 可以忽略此task的错误,继续向下执行playbook其它task</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs yaml">[<span class="hljs-string">root@ansible</span> <span class="hljs-string">ansible</span>]<span class="hljs-comment">#cat test_ignore.yml</span><br><span class="hljs-meta">---</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">centos7</span><br>  <span class="hljs-attr">tasks:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">error</span><br>      <span class="hljs-attr">command:</span> <span class="hljs-string">/bin/false</span><br>      <span class="hljs-attr">ignore_errors:</span> <span class="hljs-literal">yes</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">continue</span><br>      <span class="hljs-attr">command:</span> <span class="hljs-string">wall</span> <span class="hljs-string">continue</span><br></code></pre></td></tr></table></figure><h2 id="ansible-playbook案例"><a href="#ansible-playbook案例" class="headerlink" title="ansible-playbook案例"></a>ansible-playbook案例</h2><h3 id="安装nginx"><a href="#安装nginx" class="headerlink" title="安装nginx"></a>安装nginx</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs ymal">---<br>- hosts: centos7<br># yum install nginx<br>  remote_user: root<br>  gather_facts: no<br>  tasks:<br>    - name: install nginx<br>      yum: name=nginx state=present<br>    - name:<br>      service: name=nginx state=started enabled=yes<br></code></pre></td></tr></table></figure><h3 id="卸载httpd"><a href="#卸载httpd" class="headerlink" title="卸载httpd"></a>卸载httpd</h3><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-comment">#remove_httpd.yml</span><br><span class="hljs-meta">---</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">webservers</span><br>  <span class="hljs-attr">remote_user:</span> <span class="hljs-string">root</span><br>  <span class="hljs-attr">gather_facts:</span> <span class="hljs-literal">no</span><br>  <span class="hljs-attr">tasks:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">remove</span> <span class="hljs-string">httpd</span> <span class="hljs-string">package</span><br>    <span class="hljs-attr">yum:</span> <span class="hljs-string">name=httpd</span> <span class="hljs-string">state=absent</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">remove</span> <span class="hljs-string">apache</span> <span class="hljs-string">user</span><br>    <span class="hljs-attr">user:</span> <span class="hljs-string">name=apache</span> <span class="hljs-string">state=absent</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">remove</span> <span class="hljs-string">config</span> <span class="hljs-string">file</span><br>    <span class="hljs-attr">file:</span> <span class="hljs-string">name=/etc/httpd</span> <span class="hljs-string">state=absent</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">remove</span> <span class="hljs-string">web</span> <span class="hljs-string">html</span><br>    <span class="hljs-attr">file:</span> <span class="hljs-string">name=/data/html/</span> <span class="hljs-string">state=absent</span><br></code></pre></td></tr></table></figure><h2 id="Playbook中使用handlers和notify"><a href="#Playbook中使用handlers和notify" class="headerlink" title="Playbook中使用handlers和notify"></a>Playbook中使用handlers和notify</h2><h3 id="handlers和notify"><a href="#handlers和notify" class="headerlink" title="handlers和notify"></a>handlers和notify</h3><p>Handlers本质是task list ，类似于MySQL中的触发器触发的行为，其中的task与前述的task并没有本质上的不同，只有在关注的资源发生变化时，才会采取一定的操作。<br>Notify对应的action 在所有task都执行完才会最后被触发，这样可避免多个task多次改变发生时每次都触发执行指定的操作，Handlers仅在所有的变化发生完成后一次性地执行指定操作。<br>在notify中列出的操作称为handler，也即notify中调用handler中定义的操作<br>注意:</p><ul><li>如果多个task通知了相同的handlers， 此handlers仅会在所有task结束后运行一 次。</li><li>只有notify对应的task发生改变了才会通知handlers， 没有改变则不会触发handlers</li><li>handlers 是在所有前面的tasks都成功执行才会执行,如果前面任何一个task失败,会导致handle跳过执行</li></ul><p>案例:</p><p><img src="/../image.assets/1677315798458.png" srcset="/img/loading.gif" lazyload alt="1677315798458"></p><p><img src="/../image.assets/1677315812687.png" srcset="/img/loading.gif" lazyload alt="1677315812687"></p><p>案例：</p><p><img src="/../image.assets/1677315839869.png" srcset="/img/loading.gif" lazyload alt="1677315839869"></p><p>案例：</p><p><img src="/../image.assets/1677315862982.png" srcset="/img/loading.gif" lazyload alt="1677315862982"></p><p><img src="/../image.assets/1677315872464.png" srcset="/img/loading.gif" lazyload alt="1677315872464"></p><p>范例: 部署haproxy</p><p><img src="/../image.assets/1677315902745.png" srcset="/img/loading.gif" lazyload alt="1677315902745"></p><h3 id="force-handlers"><a href="#force-handlers" class="headerlink" title="force_handlers"></a>force_handlers</h3><p>如果不论前面的task成功与否,都希望handlers能执行, 可以使用force_handlers: yes 强制执行handler<br>范例: 强制调用handlers</p><p><img src="/../image.assets/1677315975960.png" srcset="/img/loading.gif" lazyload alt="1677315975960"></p><h2 id="Playbook中使用tags组件"><a href="#Playbook中使用tags组件" class="headerlink" title="Playbook中使用tags组件"></a>Playbook中使用tags组件</h2><p>官方文档:</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">https:<span class="hljs-regexp">//</span>docs.ansible.com<span class="hljs-regexp">/ansible/</span>latest<span class="hljs-regexp">/user_guide/</span>playbooks_tags.html<br></code></pre></td></tr></table></figure><p>默认情况下， Ansible 在执行一个 playbook 时，会执行 playbook 中所有的任务，在playbook文件中，可以利用tags组件，为特定 task 指定标签，当在执行playbook时，可以只执行特定tags的task,而非整个playbook文件<br>可以一个task对应多个tag,也可以多个task对应同一个tag<br>还有另外3个特殊关键字用于标签, tagged, untagged 和 all,它们分别是仅运行已标记，只有未标记和所有任务。<br>tags 主要用于调试环境<br>范例： tag 标签</p><p><img src="/../image.assets/1677316033321.png" srcset="/img/loading.gif" lazyload alt="1677316033321"></p><h2 id="Playbook中使用变量"><a href="#Playbook中使用变量" class="headerlink" title="Playbook中使用变量"></a>Playbook中使用变量</h2><p>Playbook中同样也支持变量<br>变量名：仅能由字母、数字和下划线组成，且只能以字母开头<br>变量定义：</p><figure class="highlight ceylon"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs ceylon"><span class="hljs-keyword">variable</span>=<span class="hljs-keyword">value</span><br><span class="hljs-keyword">variable</span>: <span class="hljs-keyword">value</span><br></code></pre></td></tr></table></figure><p>范例：</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">http_port</span>=<span class="hljs-number">80</span><br><span class="hljs-attribute">http_port</span>: <span class="hljs-number">80</span><br></code></pre></td></tr></table></figure><p>通过 调用变量，且变量名前后建议加空格，有时用”“才生效<br>变量来源：</p><ol><li>ansible 的 setup facts 远程主机的所有变量都可直接调用</li><li>通过命令行指定变量，优先级最高</li></ol><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">ansible-playbook -e <span class="hljs-attribute">varname</span>=value test.yml<br></code></pre></td></tr></table></figure><p>3.在playbook文件中定义</p><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs avrasm"><span class="hljs-symbol">vars:</span><br><span class="hljs-symbol">var1:</span> value1<br><span class="hljs-symbol">var2:</span> value2<br></code></pre></td></tr></table></figure><p>4.在独立的变量YAML文件中定义</p><figure class="highlight ldif"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs ldif"><span class="hljs-literal">-</span> hosts: all<br><span class="hljs-attribute">vars_files</span>:<br><span class="hljs-literal">-</span> vars.yml<br></code></pre></td></tr></table></figure><ol start="5"><li>在主机清单文件中定义<br>主机（普通）变量：主机组中主机单独定义，优先级高于公共变量<br>组（公共）变量：针对主机组中所有主机定义统一变量</li><li>在项目中针对主机和主机组定义<br>在项目目录中创建 host_vars和group_vars目录</li><li>在role中定义</li></ol><p>变量的优先级从高到低如下</p><figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xl">-<span class="hljs-function"><span class="hljs-title">e</span> 选项定义变量 --&gt;</span><span class="hljs-function"><span class="hljs-title">playbook</span>中vars_files --&gt;</span> <span class="hljs-function"><span class="hljs-title">playbook</span>中vars变量定义 --&gt;</span><span class="hljs-function"><span class="hljs-title">host_vars</span>/主机名文件 --&gt;</span>主机清单中主机变量--&gt; <span class="hljs-function"><span class="hljs-title">group_vars</span>/主机组名文件--&gt;</span><span class="hljs-function"><span class="hljs-title">group_vars</span>/all文件--&gt;</span> 主机清单组变量<br></code></pre></td></tr></table></figure><h3 id="使用-setup-模块中变量"><a href="#使用-setup-模块中变量" class="headerlink" title="使用 setup 模块中变量"></a>使用 setup 模块中变量</h3><h4 id="使用-facts-变量"><a href="#使用-facts-变量" class="headerlink" title="使用 facts 变量"></a>使用 facts 变量</h4><p>本模块自动在playbook调用，生成的系统状态信息, 并将之存放在facts变量中<br>facts 包括的信息很多,如: 主机名,IP,CPU,内存,网卡等<br>facts 变量的实际使用场景案例</p><ul><li>通过facts变量获取被控端CPU的个数信息,从而生成不同的Nginx配置文件</li><li>通过facts变量获取被控端内存大小信息,从而生成不同的memcached的配置文件</li><li>通过facts变量获取被控端主机名称信息,从而生成不同的Zabbix配置文件</li><li>通过facts变量获取被控端网卡信息,从而生成不同的主机名</li></ul><p>案例：使用setup变量</p><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs autoit">[root<span class="hljs-symbol">@ansible</span> ~]<span class="hljs-meta"># ansible localhost -m setup -a <span class="hljs-string">&#x27;filter=&quot;ansible_default_ipv4&quot;&#x27;</span></span><br>localhost | SUCCESS =&gt; &#123;<br>    <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;ansible_default_ipv4&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;address&quot;</span>: <span class="hljs-string">&quot;192.168.32.133&quot;</span>,<br>            <span class="hljs-string">&quot;alias&quot;</span>: <span class="hljs-string">&quot;ens160&quot;</span>,<br>            <span class="hljs-string">&quot;broadcast&quot;</span>: <span class="hljs-string">&quot;192.168.32.255&quot;</span>,<br>            <span class="hljs-string">&quot;gateway&quot;</span>: <span class="hljs-string">&quot;192.168.32.2&quot;</span>,<br>            <span class="hljs-string">&quot;interface&quot;</span>: <span class="hljs-string">&quot;ens160&quot;</span>,<br>            <span class="hljs-string">&quot;macaddress&quot;</span>: <span class="hljs-string">&quot;00:0c:29:7c:80:cd&quot;</span>,<br>            <span class="hljs-string">&quot;mtu&quot;</span>: <span class="hljs-number">1500</span>,<br>            <span class="hljs-string">&quot;netmask&quot;</span>: <span class="hljs-string">&quot;255.255.255.0&quot;</span>,<br>            <span class="hljs-string">&quot;network&quot;</span>: <span class="hljs-string">&quot;192.168.32.0&quot;</span>,<br>            <span class="hljs-string">&quot;prefix&quot;</span>: <span class="hljs-string">&quot;24&quot;</span>,<br>            <span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;ether&quot;</span><br>        &#125;<br>    &#125;,<br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">false</span><br>&#125;<br>[root<span class="hljs-symbol">@ansible</span> ~]<span class="hljs-meta"># </span><br></code></pre></td></tr></table></figure><p>范例：显示ens33的网卡的IP地址</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs stylus">---<br>- hosts: centos7<br>  tasks:<br>    - name: show ens33 ip<br>      debug:<br>        msg: IP <span class="hljs-selector-tag">address</span> &#123;&#123; ansible_ens33<span class="hljs-selector-class">.ipv4</span><span class="hljs-selector-class">.address</span> &#125;&#125;<br>        <span class="hljs-selector-id">#msg</span>: IP <span class="hljs-selector-tag">address</span> &#123;&#123; ansible_facts<span class="hljs-selector-attr">[<span class="hljs-string">&quot;ens33&quot;</span>]</span><span class="hljs-selector-attr">[<span class="hljs-string">&quot;ipv4&quot;</span>]</span><span class="hljs-selector-attr">[<span class="hljs-string">&quot;address&quot;</span>]</span> &#125;&#125;<br>        <span class="hljs-selector-id">#msg</span>: IP <span class="hljs-selector-tag">address</span> &#123;&#123; ansible_facts<span class="hljs-selector-class">.ens33</span><span class="hljs-selector-class">.ipv4</span><span class="hljs-selector-class">.address</span> &#125;&#125;<br>        <span class="hljs-selector-id">#msg</span>: IP <span class="hljs-selector-tag">address</span> &#123;&#123; ansible_default_ipv4<span class="hljs-selector-class">.address</span> &#125;&#125;<br>        <span class="hljs-selector-id">#msg</span>: IP <span class="hljs-selector-tag">address</span> &#123;&#123; ansible_ens33<span class="hljs-selector-class">.ipv4</span><span class="hljs-selector-class">.address</span> &#125;&#125;<br>        <span class="hljs-selector-id">#msg</span>: IP <span class="hljs-selector-tag">address</span> &#123;&#123; ansible_ens33<span class="hljs-selector-class">.ipv4</span><span class="hljs-selector-class">.address</span><span class="hljs-selector-class">.split</span>(<span class="hljs-string">&#x27;.&#x27;</span>)<span class="hljs-selector-attr">[-1]</span> &#125;&#125;  #取IP中的最后一个数字<br></code></pre></td></tr></table></figure><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs markdown">[root@ansible ansible]# ansible-playbook -v show<span class="hljs-emphasis">_ip.yml </span><br><span class="hljs-emphasis">Using /etc/ansible/ansible.cfg as config file</span><br><span class="hljs-emphasis"></span><br><span class="hljs-emphasis">PLAY [centos7] <span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span>*</span><br><span class="hljs-emphasis"></span><br><span class="hljs-emphasis">TASK [Gathering Facts] <span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span>*</span><br><span class="hljs-emphasis">ok: [192.168.32.179]</span><br><span class="hljs-emphasis">ok: [192.168.32.178]</span><br><span class="hljs-emphasis"></span><br><span class="hljs-emphasis">TASK [show ens33 ip] <span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">***</span></span><br><span class="hljs-strong"><span class="hljs-emphasis">ok: [192.168.32.178] =&gt; &#123;</span></span><br><span class="hljs-strong"><span class="hljs-emphasis">    &quot;msg&quot;: &quot;IP address 192.168.32.178&quot;</span></span><br><span class="hljs-strong"><span class="hljs-emphasis">&#125;</span></span><br><span class="hljs-strong"><span class="hljs-emphasis">ok: [192.168.32.179] =&gt; &#123;</span></span><br><span class="hljs-strong"><span class="hljs-emphasis">    &quot;msg&quot;: &quot;IP address 192.168.32.179&quot;</span></span><br><span class="hljs-strong"><span class="hljs-emphasis">&#125;</span></span><br><span class="hljs-strong"><span class="hljs-emphasis"></span></span><br><span class="hljs-strong"><span class="hljs-emphasis">PLAY RECAP **</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">***</span></span><br><span class="hljs-strong"><span class="hljs-emphasis">192.168.32.178             : ok=2    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span></span><br><span class="hljs-strong"><span class="hljs-emphasis">192.168.32.179             : ok=2    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span></span><br><span class="hljs-strong"><span class="hljs-emphasis"></span></span><br><span class="hljs-strong"><span class="hljs-emphasis">[root@ansible ansible]# </span></span><br></code></pre></td></tr></table></figure><p>范例：修改主机名称为web-IP</p><figure class="highlight handlebars"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs handlebars"><span class="language-xml">- hosts: centos7</span><br><span class="language-xml">  tasks:</span><br><span class="language-xml">  - name: 打印facts变量</span><br><span class="language-xml">    debug: msg=</span><span class="hljs-template-variable">&#123;&#123; <span class="hljs-name">ansible_ens33.ipv4.address</span> &#125;&#125;</span><span class="language-xml"></span><br><span class="language-xml">  - name: 修改主机名</span><br><span class="language-xml">    hostname: name=web-</span><span class="hljs-template-variable">&#123;&#123; <span class="hljs-name">ansible_ens33.ipv4.address</span> &#125;&#125;</span><span class="language-xml"></span><br><span class="language-xml">  #- name: 获取facts变量提取IP地址，以.结尾的最后一列,修改主机名为web-hostid</span><br><span class="language-xml">    #hostname: name=web-</span><span class="hljs-template-variable">&#123;&#123; <span class="hljs-name">ansible_ens33.ipv4.address.split</span>(<span class="hljs-name">&#x27;.&#x27;</span>)[-1] &#125;&#125;</span><br></code></pre></td></tr></table></figure><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs markdown">[root@ansible ansible]# ansible-playbook change<span class="hljs-emphasis">_hostname.yml </span><br><span class="hljs-emphasis"></span><br><span class="hljs-emphasis">PLAY [centos7] <span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span>*</span><br><span class="hljs-emphasis"></span><br><span class="hljs-emphasis">TASK [Gathering Facts] <span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span>*</span><br><span class="hljs-emphasis">ok: [192.168.32.178]</span><br><span class="hljs-emphasis">ok: [192.168.32.179]</span><br><span class="hljs-emphasis"></span><br><span class="hljs-emphasis">TASK [打印facts变量] <span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">***</span></span><br><span class="hljs-strong"><span class="hljs-emphasis">ok: [192.168.32.178] =&gt; &#123;</span></span><br><span class="hljs-strong"><span class="hljs-emphasis">    &quot;msg&quot;: &quot;192.168.32.178&quot;</span></span><br><span class="hljs-strong"><span class="hljs-emphasis">&#125;</span></span><br><span class="hljs-strong"><span class="hljs-emphasis">ok: [192.168.32.179] =&gt; &#123;</span></span><br><span class="hljs-strong"><span class="hljs-emphasis">    &quot;msg&quot;: &quot;192.168.32.179&quot;</span></span><br><span class="hljs-strong"><span class="hljs-emphasis">&#125;</span></span><br><span class="hljs-strong"><span class="hljs-emphasis"></span></span><br><span class="hljs-strong"><span class="hljs-emphasis">TASK [修改主机名] **</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span></span><br><span class="hljs-emphasis">changed: [192.168.32.179]</span><br><span class="hljs-emphasis">changed: [192.168.32.178]</span><br><span class="hljs-emphasis"></span><br><span class="hljs-emphasis">PLAY RECAP <span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span>*</span><br><span class="hljs-emphasis">192.168.32.178             : ok=3    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br><span class="hljs-emphasis">192.168.32.179             : ok=3    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br><span class="hljs-emphasis"></span><br><span class="hljs-emphasis">[root@ansible ansible]# </span><br></code></pre></td></tr></table></figure><h4 id="性能优化"><a href="#性能优化" class="headerlink" title="性能优化"></a>性能优化</h4><p>每次执行playbook,默认会收集每个主机的所有facts变量,将会导致速度很慢,可以采用下面方法加速<br>方法1<br>关闭facts采集加速执行,此方法将导致无法使用facts变量</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">all</span><br>  <span class="hljs-attr">gather_facts:</span> <span class="hljs-literal">no</span><br></code></pre></td></tr></table></figure><p>方法2<br>当使用 gather_facts: no 关闭 facts，确实能加速 Ansible 执行，但是有时候又需要使用 facts 中的内容，还希望执行的速度快，这时候可以设置facts 的缓存,将facts变量信息存在redis服务器中</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[root@ansible ~]</span><span class="hljs-comment"># cat /etc/ansible/ansible.cfg</span><br><span class="hljs-section">[defaults]</span><br><span class="hljs-comment"># smart 表示默认收集 facts，但 facts 已有的情况下不会收集，即使用缓存 facts</span><br><span class="hljs-comment"># implicit 表示默认收集 facts，要禁止收集，必须使用 gather_facts: False</span><br><span class="hljs-comment"># explicit 则表示默认不收集，要显式收集，必须使用gather_facts: True</span><br><span class="hljs-attr">gathering</span> = smart <span class="hljs-comment">#在使用 facts 缓存时设置为smart</span><br><span class="hljs-attr">fact_caching_timeout</span> = <span class="hljs-number">86400</span> <span class="hljs-comment">#缓存时长</span><br><span class="hljs-attr">fact_caching</span> = redis <span class="hljs-comment">#缓存存在redis中</span><br><span class="hljs-attr">fact_caching_connection</span> = <span class="hljs-number">10.0</span>.<span class="hljs-number">0.100</span>:<span class="hljs-number">6379</span>:<span class="hljs-number">0</span> <span class="hljs-comment">#0表示redis的0号数据库</span><br><span class="hljs-comment">#若redis设置了密码</span><br><span class="hljs-attr">fact_caching_connection</span> = <span class="hljs-number">10.0</span>.<span class="hljs-number">0.100</span>:<span class="hljs-number">6379</span>:<span class="hljs-number">0</span>:password<br></code></pre></td></tr></table></figure><h3 id="register-注册变量"><a href="#register-注册变量" class="headerlink" title="register 注册变量"></a>register 注册变量</h3><p>在playbook中可以使用register将捕获命令的输出保存在临时变量中，方便后续调用此变量,比如可以使用debug模块进行显示输出<br>范例: 利用debug 模块输出变量</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">centos7</span><br>  <span class="hljs-attr">tasks:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">get</span> <span class="hljs-string">variable</span><br>      <span class="hljs-attr">shell:</span> <span class="hljs-string">hostname</span><br>      <span class="hljs-attr">register:</span> <span class="hljs-string">name</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">print</span> <span class="hljs-string">variable</span><br>      <span class="hljs-attr">debug:</span><br>        <span class="hljs-attr">msg:</span> <span class="hljs-string">&quot;<span class="hljs-template-variable">&#123;&#123; name &#125;&#125;</span>&quot;</span> <span class="hljs-comment">#输出register注册的name变量的全部信息,注意变量要加&quot; &quot;引起来</span><br>         <span class="hljs-comment">#msg: &quot;&#123;&#123; name.cmd &#125;&#125;&quot; #显示命令</span><br>         <span class="hljs-comment">#msg: &quot;&#123;&#123; name.rc &#125;&#125;&quot; #显示命令成功与否</span><br>		 <span class="hljs-comment">#msg: &quot;&#123;&#123; name.stdout &#125;&#125;&quot; #显示命令的输出结果为字符串形式,所有结果都放在一行里显示,适合于结果是单行输出</span><br>	    <span class="hljs-comment">#msg: &quot;&#123;&#123; name.stdout_lines &#125;&#125;&quot; #显示命令的输出结果为列表形式,逐行标准输出,适用于多行显示</span><br>		<span class="hljs-comment">#msg: &quot;&#123;&#123; name[&#x27;stdout_lines&#x27;] &#125;&#125;&quot; #显示命令的执行结果为列表形式,和效果上面相同</span><br>		<span class="hljs-comment">#msg: &quot;&#123;&#123; name.stdout_lines[0] &#125;&#125;&quot; #显示命令的输出结果的列表中的第一个元素</span><br><span class="hljs-comment">#说明 第一个 task 中，使用了 register 注册变量名为 name ；当 shell 模块执行完毕后，会将数据放到该变量中。第二给 task 中，使用了 debug 模块，并从变量name中获取数据。</span><br></code></pre></td></tr></table></figure><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs markdown">[root@ansible ansible]# ansible-playbook -C register.yml <br><br>PLAY [centos7] <span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-emphasis">*</span><br><span class="hljs-emphasis"></span><br><span class="hljs-emphasis">TASK [Gathering Facts] <span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span>*</span><br>ok: [192.168.32.179]<br>ok: [192.168.32.178]<br><br>TASK [get variable] <span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><br>skipping: [192.168.32.179]<br>skipping: [192.168.32.178]<br><br>TASK [print variable] <span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">**</span><br><span class="hljs-strong">ok: [192.168.32.178] =&gt; &#123;</span><br><span class="hljs-strong">    &quot;msg&quot;: &#123;</span><br><span class="hljs-strong">        &quot;changed&quot;: false,</span><br><span class="hljs-strong">        &quot;cmd&quot;: &quot;hostname&quot;,</span><br><span class="hljs-strong">        &quot;delta&quot;: null,</span><br><span class="hljs-strong">        &quot;end&quot;: null,</span><br><span class="hljs-strong">        &quot;failed&quot;: false,</span><br><span class="hljs-strong">        &quot;msg&quot;: &quot;Command would have run if not in check mode&quot;,</span><br><span class="hljs-strong">        &quot;rc&quot;: 0,</span><br><span class="hljs-strong">        &quot;skipped&quot;: true,</span><br><span class="hljs-strong">        &quot;start&quot;: null,</span><br><span class="hljs-strong">        &quot;stderr&quot;: &quot;&quot;,</span><br><span class="hljs-strong">        &quot;stderr<span class="hljs-emphasis">_lines&quot;: [],</span></span><br><span class="hljs-emphasis"><span class="hljs-strong">        &quot;stdout&quot;: &quot;&quot;,</span></span><br><span class="hljs-emphasis"><span class="hljs-strong">        &quot;stdout_</span>lines&quot;: []</span><br><span class="hljs-strong">    &#125;</span><br><span class="hljs-strong">&#125;</span><br><span class="hljs-strong">ok: [192.168.32.179] =&gt; &#123;</span><br><span class="hljs-strong">    &quot;msg&quot;: &#123;</span><br><span class="hljs-strong">        &quot;changed&quot;: false,</span><br><span class="hljs-strong">        &quot;cmd&quot;: &quot;hostname&quot;,</span><br><span class="hljs-strong">        &quot;delta&quot;: null,</span><br><span class="hljs-strong">        &quot;end&quot;: null,</span><br><span class="hljs-strong">        &quot;failed&quot;: false,</span><br><span class="hljs-strong">        &quot;msg&quot;: &quot;Command would have run if not in check mode&quot;,</span><br><span class="hljs-strong">        &quot;rc&quot;: 0,</span><br><span class="hljs-strong">        &quot;skipped&quot;: true,</span><br><span class="hljs-strong">        &quot;start&quot;: null,</span><br><span class="hljs-strong">        &quot;stderr&quot;: &quot;&quot;,</span><br><span class="hljs-strong">        &quot;stderr<span class="hljs-emphasis">_lines&quot;: [],</span></span><br><span class="hljs-emphasis"><span class="hljs-strong">        &quot;stdout&quot;: &quot;&quot;,</span></span><br><span class="hljs-emphasis"><span class="hljs-strong">        &quot;stdout_</span>lines&quot;: []</span><br><span class="hljs-strong">    &#125;</span><br><span class="hljs-strong">&#125;</span><br><span class="hljs-strong"></span><br><span class="hljs-strong">PLAY RECAP **</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">**<span class="hljs-emphasis">*</span></span><br><span class="hljs-emphasis"><span class="hljs-strong">192.168.32.178             : ok=2    changed=0    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0   </span></span><br><span class="hljs-emphasis"><span class="hljs-strong">192.168.32.179             : ok=2    changed=0    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0   </span></span><br><span class="hljs-emphasis"><span class="hljs-strong"></span></span><br><span class="hljs-emphasis"><span class="hljs-strong">[root@ansible ansible]# </span></span><br></code></pre></td></tr></table></figure><p>范例: 安装启动服务并检查</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">centos7</span><br>  <span class="hljs-attr">vars:</span><br>    <span class="hljs-attr">package_name:</span> <span class="hljs-string">nginx</span><br>    <span class="hljs-attr">service_name:</span> <span class="hljs-string">nginx</span><br>  <span class="hljs-attr">tasks:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">install</span> &#123;&#123; <span class="hljs-string">package_name</span> &#125;&#125;<br>    <span class="hljs-attr">yum:</span> <span class="hljs-string">name=&#123;&#123;</span> <span class="hljs-string">package_name</span> <span class="hljs-string">&#125;&#125;</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">start</span> &#123;&#123; <span class="hljs-string">service_name</span> &#125;&#125;<br>    <span class="hljs-attr">service:</span> <span class="hljs-string">name=&#123;&#123;</span> <span class="hljs-string">service_name</span> <span class="hljs-string">&#125;&#125;</span> <span class="hljs-string">state=started</span> <span class="hljs-string">enabled=yes</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">check</span><br>    <span class="hljs-attr">shell:</span> <span class="hljs-string">ps</span> <span class="hljs-string">axu|grep</span> &#123;&#123; <span class="hljs-string">service_name</span> &#125;&#125;<br>    <span class="hljs-attr">register:</span> <span class="hljs-string">check_service</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">debug</span><br>    <span class="hljs-attr">debug:</span><br>      <span class="hljs-attr">msg:</span> <span class="hljs-string">&quot;<span class="hljs-template-variable">&#123;&#123; check_service.stdout_lines &#125;&#125;</span>&quot;</span><br></code></pre></td></tr></table></figure><p>范例: 修改主机名形式为 web_&lt;随机字符&gt;</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">centos7</span><br>  <span class="hljs-attr">tasks:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">genarate</span> <span class="hljs-string">random</span><br>    <span class="hljs-attr">shell:</span><br>      <span class="hljs-attr">cmd:</span> <span class="hljs-string">openssl</span> <span class="hljs-string">rand</span> <span class="hljs-string">-base64</span> <span class="hljs-number">12</span> <span class="hljs-string">|tr</span> <span class="hljs-string">-dc</span> <span class="hljs-string">&#x27;[:alnum:]&#x27;</span><br>    <span class="hljs-attr">register:</span><br>      <span class="hljs-string">num</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">show</span> <span class="hljs-string">random</span><br>    <span class="hljs-attr">debug:</span><br>      <span class="hljs-attr">msg:</span> <span class="hljs-string">&quot;<span class="hljs-template-variable">&#123;&#123; num &#125;&#125;</span>&quot;</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">change</span> <span class="hljs-string">hostname</span><br>    <span class="hljs-attr">hostname:</span><br>      <span class="hljs-attr">name:</span> <span class="hljs-string">web-&#123;&#123;</span> <span class="hljs-string">num.stdout</span> <span class="hljs-string">&#125;&#125;</span><br></code></pre></td></tr></table></figure><p>范例: 修改主机名形式为 web_随机数</p><figure class="highlight nestedtext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs nestedtext"><span class="hljs-bullet">-</span> <span class="hljs-string">hosts: centos7</span><br>  <span class="hljs-attribute">tasks</span><span class="hljs-punctuation">:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">name: 定义一个随机数，设定为变量，然后后续调用</span><br>    <span class="hljs-attribute">shell</span><span class="hljs-punctuation">:</span> <span class="hljs-string">echo $((RANDOM%255))</span><br>    <span class="hljs-attribute">register</span><span class="hljs-punctuation">:</span> <span class="hljs-string">web_number</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">name: 使用debug输出变量结果</span><br>    <span class="hljs-attribute">debug</span><span class="hljs-punctuation">:</span> <span class="hljs-string">msg=&#123;&#123; web_number &#125;&#125;</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">name: 使用hostname模块将主机名修改为web_随机数</span><br>    <span class="hljs-attribute">hostname</span><span class="hljs-punctuation">:</span> <span class="hljs-string">name=web_&#123;&#123; web_number.stdout &#125;&#125;</span><br></code></pre></td></tr></table></figure><p>范例: 批量修改主机名为随机字符</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">centos7</span><br>  <span class="hljs-attr">vars:</span><br>    <span class="hljs-attr">host:</span> <span class="hljs-string">web</span><br>    <span class="hljs-attr">domain:</span> <span class="hljs-string">wang.org</span><br>  <span class="hljs-attr">tasks:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">get</span> <span class="hljs-string">variable</span><br>    <span class="hljs-attr">shell:</span> <span class="hljs-string">echo</span> <span class="hljs-string">$RANDOM</span> <span class="hljs-string">|</span> <span class="hljs-string">md5sum</span> <span class="hljs-string">|</span> <span class="hljs-string">cut</span> <span class="hljs-string">-c</span> <span class="hljs-number">1</span><span class="hljs-number">-8</span><br>    <span class="hljs-attr">register:</span> <span class="hljs-string">get_random</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">print</span> <span class="hljs-string">variable</span><br>    <span class="hljs-attr">debug:</span><br>      <span class="hljs-attr">msg:</span> <span class="hljs-string">&quot;<span class="hljs-template-variable">&#123;&#123; get_random.stdout &#125;&#125;</span>&quot;</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">set</span> <span class="hljs-string">hostname</span><br>    <span class="hljs-attr">hostname:</span> <span class="hljs-string">name=&#123;&#123;</span> <span class="hljs-string">host</span> <span class="hljs-string">&#125;&#125;-&#123;&#123;</span> <span class="hljs-string">get_random.stdout</span> <span class="hljs-string">&#125;&#125;.&#123;&#123;</span> <span class="hljs-string">domain</span> <span class="hljs-string">&#125;&#125;</span><br></code></pre></td></tr></table></figure><p>范例: 批量修改主机名为IP最后1位数字</p><figure class="highlight handlebars"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs handlebars"><span class="language-xml">- hosts: centos7</span><br><span class="language-xml">  vars:</span><br><span class="language-xml">    host: web</span><br><span class="language-xml">    domain: wang.org</span><br><span class="language-xml">  tasks:</span><br><span class="language-xml">    - name: get variable</span><br><span class="language-xml">      shell: hostname -I | awk &#x27;&#123;print $1&#125;&#x27;</span><br><span class="language-xml">      register: get_ip</span><br><span class="language-xml">    - name: print variable</span><br><span class="language-xml">      debug:</span><br><span class="language-xml">        msg: &quot;</span><span class="hljs-template-variable">&#123;&#123; <span class="hljs-name">get_ip.stdout.split</span>(<span class="hljs-name">&#x27;.&#x27;</span>)[3] &#125;&#125;</span><span class="language-xml">&quot;</span><br><span class="language-xml">    - name: set hostname</span><br><span class="language-xml">      hostname: name=</span><span class="hljs-template-variable">&#123;&#123; <span class="hljs-name">host</span> &#125;&#125;</span><span class="language-xml">-</span><span class="hljs-template-variable">&#123;&#123; <span class="hljs-name">get_ip.stdout.split</span>(<span class="hljs-name">&#x27;.&#x27;</span>)[3] &#125;&#125;</span><span class="language-xml">.</span><span class="hljs-template-variable">&#123;&#123; <span class="hljs-name">domain</span> &#125;&#125;</span><br></code></pre></td></tr></table></figure><h3 id="在-Playbook-命令行中定义变量"><a href="#在-Playbook-命令行中定义变量" class="headerlink" title="在 Playbook 命令行中定义变量"></a>在 Playbook 命令行中定义变量</h3><p>范例：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">centos7</span><br>  <span class="hljs-attr">remote_user:</span> <span class="hljs-string">root</span><br>  <span class="hljs-attr">tasks:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">install</span> <span class="hljs-string">nginx</span><br>    <span class="hljs-attr">yum:</span> <span class="hljs-string">name=&#123;&#123;</span> <span class="hljs-string">pkname</span> <span class="hljs-string">&#125;&#125;</span> <span class="hljs-string">state=present</span><br>    <br>    <br>[<span class="hljs-string">root@ansible</span> <span class="hljs-string">~</span>]<span class="hljs-comment">#ansible-playbook -e pkname=nginx var2.yml</span><br></code></pre></td></tr></table></figure><p>范例：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment">#也可以将多个变量放在一个文件中</span><br>[<span class="hljs-string">root@ansible</span> <span class="hljs-string">~</span>]<span class="hljs-comment">#cat vars</span><br><span class="hljs-attr">pkname1:</span> <span class="hljs-string">memcached</span><br><span class="hljs-attr">pkname2:</span> <span class="hljs-string">vsftpd</span><br>[<span class="hljs-string">root@ansible</span> <span class="hljs-string">~</span>]<span class="hljs-comment">#vim var2.yml</span><br><span class="hljs-meta">---</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">centos7</span><br>  <span class="hljs-attr">remote_user:</span> <span class="hljs-string">root</span><br>  <span class="hljs-attr">tasks:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">install</span> <span class="hljs-string">package</span> &#123;&#123; <span class="hljs-string">pkname1</span> &#125;<br>    <span class="hljs-attr">yum:</span> <span class="hljs-string">name=<span class="hljs-template-variable">&#123;&#123; pkname1 &#125;&#125;</span></span> <span class="hljs-string">state=present</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">install</span> <span class="hljs-string">package</span> &#123;&#123; <span class="hljs-string">pkname2</span> &#125;<br>    <span class="hljs-attr">yum:</span> <span class="hljs-string">name=<span class="hljs-template-variable">&#123;&#123; pkname2 &#125;&#125;</span></span> <span class="hljs-string">state=present</span><br>[<span class="hljs-string">root@ansible</span> <span class="hljs-string">~</span>]<span class="hljs-comment">#ansible-playbook -e pkname1=memcached -e pkname2=httpd var2.yml</span><br>[<span class="hljs-string">root@ansible</span> <span class="hljs-string">~</span>]<span class="hljs-comment">#ansible-playbook -e &#x27;@vars&#x27; var2.yml</span><br></code></pre></td></tr></table></figure><h3 id="在playbook文件中定义变量"><a href="#在playbook文件中定义变量" class="headerlink" title="在playbook文件中定义变量"></a>在playbook文件中定义变量</h3><p>此方式定义的是私有变量,即只能在当前playbook中使用,不能被其它Playbook共用<br>范例：</p><figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs pf">- hosts: webservers<br>  remote_user: root<br>  vars:<br>    username: user1<br>    groupname: group1<br>  tasks:<br>  - name: create <span class="hljs-keyword">group</span> &#123;&#123; groupname &#125;&#125;<br>    <span class="hljs-keyword">group</span>: name=&#123;&#123; groupname &#125;&#125; <span class="hljs-keyword">state</span>=present<br>  - name: create <span class="hljs-keyword">user</span> &#123;&#123; username &#125;&#125;<br>    <span class="hljs-keyword">user</span>: name=&#123;&#123; username &#125;&#125; <span class="hljs-keyword">group</span>=&#123;&#123; groupname &#125;&#125; <span class="hljs-keyword">state</span>=present<br>    <br>[root@ansible ~]<span class="hljs-comment">#ansible-playbook -e &quot;username=user2 groupname=group2&quot; var3.yml</span><br></code></pre></td></tr></table></figure><p>范例：变量的相互调用</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">centos7</span><br>  <span class="hljs-attr">remote_user:</span> <span class="hljs-string">root</span><br>  <span class="hljs-attr">vars:</span><br>    <span class="hljs-attr">collect_info:</span> <span class="hljs-string">&quot;/data/test/<span class="hljs-template-variable">&#123;&#123;ansible_default_ipv4[&#x27;address&#x27;]&#125;&#125;</span>/&quot;</span><br>  <span class="hljs-attr">tasks:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">create</span> <span class="hljs-string">IP</span> <span class="hljs-string">directory</span><br>    <span class="hljs-attr">file:</span> <span class="hljs-string">name=&quot;&#123;&#123;collect_info&#125;&#125;&quot;</span> <span class="hljs-string">state=directory</span><br></code></pre></td></tr></table></figure><h3 id="使用专用的公共的变量文件"><a href="#使用专用的公共的变量文件" class="headerlink" title="使用专用的公共的变量文件"></a>使用专用的公共的变量文件</h3><p>可以在一个独立的playbook文件中定义公共变量，在其它的playbook文件中可以引用变量文件中的变量<br>此方式比playbook中定义的变量优化级高</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">vim</span> <span class="hljs-string">vars.yml</span><br><span class="hljs-meta">---</span><br><span class="hljs-comment"># variables file</span><br><span class="hljs-attr">package_name:</span> <span class="hljs-string">mariadb-server</span><br><span class="hljs-attr">service_name:</span> <span class="hljs-string">mariadb</span><br><br><span class="hljs-string">vim</span> <span class="hljs-string">var5.yml</span><br><span class="hljs-meta">---</span><br><span class="hljs-comment">#install package and start service</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">dbsrvs</span><br>  <span class="hljs-attr">remote_user:</span> <span class="hljs-string">root</span><br>  <span class="hljs-attr">vars_files:</span><br>  <span class="hljs-comment"># 指定变量文件名</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">vars.yml</span><br>  <span class="hljs-attr">tasks:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">install</span> <span class="hljs-string">package</span><br>    <span class="hljs-attr">yum:</span> <span class="hljs-string">name=&#123;&#123;</span> <span class="hljs-string">package_name</span> <span class="hljs-string">&#125;&#125;</span><br>    <span class="hljs-attr">tags:</span> <span class="hljs-string">install</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">start</span> <span class="hljs-string">service</span><br>    <span class="hljs-attr">service:</span> <span class="hljs-string">name=&#123;&#123;</span> <span class="hljs-string">service_name</span> <span class="hljs-string">&#125;&#125;</span> <span class="hljs-string">state=started</span> <span class="hljs-string">enabled=yes</span><br></code></pre></td></tr></table></figure><h3 id="在主机清单中定义主机和主机组的变量"><a href="#在主机清单中定义主机和主机组的变量" class="headerlink" title="在主机清单中定义主机和主机组的变量"></a>在主机清单中定义主机和主机组的变量</h3><h4 id="所有项目的主机变量"><a href="#所有项目的主机变量" class="headerlink" title="所有项目的主机变量"></a>所有项目的主机变量</h4><p>在inventory 主机清单文件中为指定的主机定义变量以便于在playbook中使用<br>范例：</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs routeros">[webservers]<br>www1.wang.org <span class="hljs-attribute">http_port</span>=80 <span class="hljs-attribute">maxRequestsPerChild</span>=808<br>www2.wang.org <span class="hljs-attribute">http_port</span>=8080 <span class="hljs-attribute">maxRequestsPerChild</span>=909<br></code></pre></td></tr></table></figure><h4 id="所有项目的组（公共）变量"><a href="#所有项目的组（公共）变量" class="headerlink" title="所有项目的组（公共）变量"></a>所有项目的组（公共）变量</h4><p>在inventory 主机清单文件中赋予给指定组内所有主机上的在playbook中可用的变量，如果和主机变是同名，优先级低于主机变量</p><p>案例：</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[webservers:vars]</span><br><span class="hljs-attr">http_port</span>=<span class="hljs-number">80</span><br><span class="hljs-attr">ntp_server</span>=ntp.wang.org<br><span class="hljs-attr">nfs_server</span>=nfs.wang.org<br><span class="hljs-section">[all:vars]</span><br><span class="hljs-comment"># --------- Main Variables ---------------</span><br><span class="hljs-comment"># Cluster container-runtime supported: docker, containerd</span><br><span class="hljs-attr">CONTAINER_RUNTIME</span>=<span class="hljs-string">&quot;docker&quot;</span><br><span class="hljs-comment"># Network plugins supported: calico, flannel, kube-router, cilium, kube-ovn</span><br><span class="hljs-attr">CLUSTER_NETWORK</span>=<span class="hljs-string">&quot;calico&quot;</span><br><span class="hljs-comment"># Service proxy mode of kube-proxy: &#x27;iptables&#x27; or &#x27;ipvs&#x27;</span><br><span class="hljs-attr">PROXY_MODE</span>=<span class="hljs-string">&quot;ipvs&quot;</span><br><span class="hljs-comment"># K8S Service CIDR, not overlap with node(host) networking</span><br><span class="hljs-attr">SERVICE_CIDR</span>=<span class="hljs-string">&quot;192.168.0.0/16&quot;</span><br><span class="hljs-comment"># Cluster CIDR (Pod CIDR), not overlap with node(host) networking</span><br><span class="hljs-attr">CLUSTER_CIDR</span>=<span class="hljs-string">&quot;172.16.0.0/16&quot;</span><br><span class="hljs-comment"># NodePort Range</span><br><span class="hljs-attr">NODE_PORT_RANGE</span>=<span class="hljs-string">&quot;20000-60000&quot;</span><br><span class="hljs-comment"># Cluster DNS Domain</span><br><span class="hljs-attr">CLUSTER_DNS_DOMAIN</span>=<span class="hljs-string">&quot;magedu.local.&quot;</span><br></code></pre></td></tr></table></figure><p>范例：</p><figure class="highlight handlebars"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs handlebars"><span class="language-xml">[root@ansible ~]#vim /etc/ansible/hosts</span><br><span class="language-xml">[webservers]</span><br><span class="language-xml">10.0.0.8 hname=www1 domain=magedu.io</span><br><span class="language-xml">10.0.0.7 hname=www2</span><br><span class="language-xml">[webservers:vars]</span><br><span class="language-xml">mark=&quot;-&quot;</span><br><span class="language-xml">[all:vars]</span><br><span class="language-xml">domain=wang.org</span><br><span class="language-xml">[root@ansible ~]#ansible webservers -m hostname -a &#x27;name=</span><span class="hljs-template-variable">&#123;&#123; <span class="hljs-name">hname</span> &#125;&#125;</span><span class="hljs-template-variable">&#123;&#123; <span class="hljs-name">mark</span> &#125;&#125;</span><span class="language-xml"></span><br><span class="language-xml"></span><span class="hljs-template-variable">&#123;&#123; <span class="hljs-name">domain</span> &#125;&#125;</span><span class="language-xml">&#x27;</span><br><span class="language-xml">#命令行指定变量：</span><br><span class="language-xml">[root@ansible ~]#ansible webservers -e domain=magedu.cn -m hostname -a &#x27;name=</span><br><span class="language-xml"></span><span class="hljs-template-variable">&#123;&#123; <span class="hljs-name">hname</span> &#125;&#125;</span><span class="hljs-template-variable">&#123;&#123; <span class="hljs-name">mark</span> &#125;&#125;</span><span class="hljs-template-variable">&#123;&#123; <span class="hljs-name">domain</span> &#125;&#125;</span><span class="language-xml">&#x27;</span><br></code></pre></td></tr></table></figure><h3 id="针对当前项目的主机和主机组的变量"><a href="#针对当前项目的主机和主机组的变量" class="headerlink" title="针对当前项目的主机和主机组的变量"></a>针对当前项目的主机和主机组的变量</h3><p>上面的方式是针对所有项目都有效,而官方更建议的方式是使用ansible特定项目的主机变量和组变量.生产建议在每个项目对应的目录中创建额外的两个变量目录,分别是host_vars和group_vars</p><ul><li>host_vars下面的文件名和主机清单主机名一致,针对单个主机进行变量定义格式:host_vars&#x2F;hostname</li><li>group_vars下面的文件名和主机清单中组名一致, 针对单个组进行变量定义格式: group_vars&#x2F;groupname</li><li>group_vars&#x2F;all文件内定义的变量对所有组都有效</li></ul><p>范例: 特定项目的主机和组变量</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs markdown">[root@ansible ansible]#pwd<br>/data/ansible<br>[root@ansible ansible]#mkdir host<span class="hljs-emphasis">_vars</span><br><span class="hljs-emphasis">[root@ansible ansible]#mkdir group_</span>vars<br>[root@ansible ansible]#cat host<span class="hljs-emphasis">_vars/10.0.0.8</span><br><span class="hljs-emphasis">id: 2</span><br><span class="hljs-emphasis">[root@ansible ansible]#cat host_</span>vars/10.0.0.7<br>id: 1<br>[root@ansible ansible]#cat group<span class="hljs-emphasis">_vars/webservers</span><br><span class="hljs-emphasis">name: web</span><br><span class="hljs-emphasis">[root@ansible ansible]#cat group_</span>vars/all<br>domain: wang.org<br>[root@ansible ansible]#tree host<span class="hljs-emphasis">_vars/ group_</span>vars/<br>host<span class="hljs-emphasis">_vars/</span><br><span class="hljs-emphasis">├── 10.0.0.7</span><br><span class="hljs-emphasis">└── 10.0.0.8</span><br><span class="hljs-emphasis">group_</span>vars/<br>├── all<br>└── webservers<br>0 directories, 4 files<br>[root@ansible ansible]#cat test.yml<br><span class="hljs-bullet">-</span> hosts: webservers<br>tasks:<br><span class="hljs-bullet">-</span> name: get variable<br>command: echo &quot;&#123;&#123;name&#125;&#125;&#123;&#123;id&#125;&#125;.&#123;&#123;domain&#125;&#125;&quot;<br>register: result<br><span class="hljs-bullet">-</span> name: print variable<br>debug:<br>msg: &quot;&#123;&#123;result.stdout&#125;&#125;&quot;<br>[root@ansible ansible]#ansible-playbook test.yml<br>PLAY [webservers]<br><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><br><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">**<span class="hljs-emphasis">*</span></span><br><span class="hljs-emphasis"><span class="hljs-strong">TASK [Gathering Facts]</span></span><br><span class="hljs-emphasis"><span class="hljs-strong">*</span>**</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-emphasis">*</span><br><span class="hljs-emphasis"><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">***</span></span><br><span class="hljs-strong"><span class="hljs-emphasis">ok: [10.0.0.7]</span></span><br><span class="hljs-strong"><span class="hljs-emphasis">ok: [10.0.0.8]</span></span><br><span class="hljs-strong"><span class="hljs-emphasis">TASK [get variable]</span></span><br><span class="hljs-strong"><span class="hljs-emphasis">**</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">**</span></span><br><span class="hljs-strong"><span class="hljs-emphasis">**</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span></span><br><span class="hljs-emphasis">changed: [10.0.0.7]</span><br><span class="hljs-emphasis">changed: [10.0.0.8]</span><br><span class="hljs-emphasis">TASK [print variable]</span><br><span class="hljs-emphasis"><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span></span><br><span class="hljs-emphasis"><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span></span><br><span class="hljs-emphasis">ok: [10.0.0.7] =&gt; &#123;</span><br><span class="hljs-emphasis">&quot;msg&quot;: &quot;web1.wang.org&quot;</span><br><span class="hljs-emphasis">&#125;</span><br><span class="hljs-emphasis">ok: [10.0.0.8] =&gt; &#123;</span><br><span class="hljs-emphasis">&quot;msg&quot;: &quot;web2.wang.org&quot;</span><br><span class="hljs-emphasis">&#125;</span><br><span class="hljs-emphasis">PLAY RECAP</span><br><span class="hljs-emphasis"><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span></span><br><span class="hljs-emphasis"><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">***</span></span><br><span class="hljs-strong"><span class="hljs-emphasis">10.0.0.7 : ok=3 changed=1 unreachable=0 failed=0</span></span><br><span class="hljs-strong"><span class="hljs-emphasis">skipped=0 rescued=0 ignored=0</span></span><br><span class="hljs-strong"><span class="hljs-emphasis">10.0.0.8 : ok=3 changed=1 unreachable=0 failed=0</span></span><br><span class="hljs-strong"><span class="hljs-emphasis">skipped=0 rescued=0 ignored=0</span></span><br></code></pre></td></tr></table></figure><h2 id="Template-模板"><a href="#Template-模板" class="headerlink" title="Template 模板"></a>Template 模板</h2><p>模板是一个文本文件，可以用于根据每个主机的不同环境而为生成不同的文件<br>模板文件中支持嵌套jinja2语言的指令,来实现变量,条件判断,循环等功能<br>需要使用template模块实现文件的复制到远程主机,但和copy模块不同,复制过去的文件每个主机可以会有所不同</p><h3 id="jinja2语言"><a href="#jinja2语言" class="headerlink" title="jinja2语言"></a>jinja2语言</h3><p><img src="/../image.assets/1677662324156.png" srcset="/img/loading.gif" lazyload alt="1677662324156"></p><p>Jinja2 是一个现代的，设计者友好的，仿照 Django 模板的 Python 模板语言。 它速度快，被广泛使用，并且提供了可选的沙箱模板执行环境保证安全:<br>特性:</p><ul><li>沙箱中执行</li><li>强大的 HTML 自动转义系统保护系统免受 XSS</li><li>模板继承</li><li>及时编译最优的 python 代码</li><li>可选提前编译模板的时间</li><li>易于调试。异常的行数直接指向模板中的对应行。</li><li>可配置的语法</li></ul><p>官方网站：</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs awk">http:<span class="hljs-regexp">//</span>jinja.pocoo.org/<br>https:<span class="hljs-regexp">//</span>jinja.palletsprojects.com<span class="hljs-regexp">/en/</span><span class="hljs-number">2.11</span>.x/<br></code></pre></td></tr></table></figure><p>官方中文文档</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs awk">http:<span class="hljs-regexp">//</span>docs.jinkan.org<span class="hljs-regexp">/docs/</span>jinja2/<br>https:<span class="hljs-regexp">//</span>www.w3cschool.cn<span class="hljs-regexp">/yshfid/</span><br></code></pre></td></tr></table></figure><p>jinja2 语言支持多种数据类型和操作:<br>字面量，如: 字符串：使用单引号或双引号,数字：整数，浮点数<br>列表：[item1, item2, …]<br>元组：(item1, item2, …)<br>字典：{key1:value1, key2:value2, …}<br>布尔型：true&#x2F;false<br>算术运算：+, -, *, &#x2F;, &#x2F;&#x2F;, %, **<br>比较操作：&#x3D;&#x3D;, !&#x3D;, &gt;, &gt;&#x3D;, &lt;, &lt;&#x3D;</p><p>逻辑运算：and，or，not<br>流表达式：For，If，When</p><p><strong>字面量：</strong><br>表达式最简单的形式就是字面量。字面量表示诸如字符串和数值的 Python 对象。如”Hello World”<br>双引号或单引号中间的一切都是字符串。无论何时你需要在模板中使用一个字符串（比如函数调用、过滤器或只是包含或继承一个模板的参数），如42，42.23<br>数值可以为整数和浮点数。如果有小数点，则为浮点数，否则为整数。在 Python 里， 42 和 42.0 是不一样的</p><p><strong>算术运算：</strong><br>Jinja 允许用计算值。支持下面的运算符<br>+：把两个对象加到一起。通常对象是素质，但是如果两者是字符串或列表，你可以用这 种方式来衔接<br>它们。无论如何这不是首选的连接字符串的方式！连接字符串见 ~ 运算符。 2 等于 2<br>-：用第一个数减去第二个数。 1 等于 1<br>&#x2F;：对两个数做除法。返回值会是一个浮点数。 0.5 等于 0.5<br>&#x2F;&#x2F;：对两个数做除法，返回整数商。 2 等于 2<br>%：计算整数除法的余数。 4 等于 4<br>*：用右边的数乘左边的操作数。 4 会返回 4 。也可以用于重 复一个字符串多次。 NaN<br>会打印 80 个等号的横条<br>**：取左操作数的右操作数次幂。 8 会返回 8</p><p><strong>比较操作符</strong></p><p>&#x3D;&#x3D; 比较两个对象是否相等<br>!&#x3D; 比较两个对象是否不等</p><blockquote><p>如果左边大于右边，返回 true<br>&#x3D; 如果左边大于等于右边，返回 true<br>&lt; 如果左边小于右边，返回 true<br>&lt;&#x3D; 如果左边小于等于右边，返回 true<br>逻辑运算符</p></blockquote><p>对于 if 语句，在 for 过滤或 if 表达式中，它可以用于联合多个表达式<br>and 如果左操作数和右操作数同为真，返回 true<br>or 如果左操作数和右操作数有一个为真，返回 true<br>not 对一个表达式取反<br>(expr)表达式组<br>true &#x2F; false true 永远是 true ，而 false 始终是 false</p><h3 id="template"><a href="#template" class="headerlink" title="template"></a>template</h3><p>template功能：可以根据和参考模块文件，动态生成相类似的配置文件<br>template文件存建议放于templates目录下，且命名为 .j2 结尾</p><p>yaml&#x2F;yml 文件和templates目录平级，此时playbook中指定模版文件时可不用指定路径, 目录结构如下<br>示例：</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs stylus">./<br>├── temnginx<span class="hljs-selector-class">.yml</span><br>└── templates<br>   └── nginx<span class="hljs-selector-class">.conf</span>.j2<br></code></pre></td></tr></table></figure><p>范例：利用template 同步nginx配置文件</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment">#准备templates/nginx.conf.j2文件</span><br>[<span class="hljs-string">root@ansible</span> <span class="hljs-string">~</span>]<span class="hljs-comment">#vim temnginx.yml</span><br><span class="hljs-meta">---</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">centos7</span><br>  <span class="hljs-attr">remote_user:</span> <span class="hljs-string">root</span><br>  <span class="hljs-attr">tasks:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">template</span> <span class="hljs-string">config</span> <span class="hljs-string">to</span> <span class="hljs-string">remote</span> <span class="hljs-string">hosts</span><br>    <span class="hljs-attr">template:</span> <span class="hljs-string">src=nginx.conf.j2</span> <span class="hljs-string">dest=/etc/nginx/nginx.conf</span><br>    <br>[<span class="hljs-string">root@ansible</span> <span class="hljs-string">~</span>]<span class="hljs-comment">#ansible-playbook temnginx.yml</span><br></code></pre></td></tr></table></figure><p>template变更替换<br>范例：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment">#修改文件nginx.conf.j2</span><br>[<span class="hljs-string">root@ansible</span> <span class="hljs-string">~</span>]<span class="hljs-comment">#mkdir templates</span><br>[<span class="hljs-string">root@ansible</span> <span class="hljs-string">~</span>]<span class="hljs-comment">#vim templates/nginx.conf.j2</span><br><span class="hljs-string">......</span><br><span class="hljs-string">worker_processes</span> &#123;&#123; <span class="hljs-string">ansible_processor_vcpus</span> &#125;&#125;<span class="hljs-string">;</span><br><span class="hljs-string">......</span><br>[<span class="hljs-string">root@ansible</span> <span class="hljs-string">~</span>]<span class="hljs-comment">#vim temnginx2.yml</span><br><span class="hljs-meta">---</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">centos7</span><br>  <span class="hljs-attr">remote_user:</span> <span class="hljs-string">root</span><br>  <span class="hljs-attr">tasks:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">install</span> <span class="hljs-string">nginx</span><br>    <span class="hljs-attr">yum:</span> <span class="hljs-string">name=nginx</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">template</span> <span class="hljs-string">config</span> <span class="hljs-string">to</span> <span class="hljs-string">remote</span> <span class="hljs-string">hosts</span><br>    <span class="hljs-attr">template:</span> <span class="hljs-string">src=nginx.conf.j2</span> <span class="hljs-string">dest=/etc/nginx/nginx.conf</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">start</span> <span class="hljs-string">service</span><br>    <span class="hljs-attr">service:</span> <span class="hljs-string">name=nginx</span> <span class="hljs-string">state=started</span> <span class="hljs-string">enabled=yes</span><br>[<span class="hljs-string">root@ansible</span> <span class="hljs-string">~</span>]<span class="hljs-comment">#ansible-playbook temnginx2.yml</span><br></code></pre></td></tr></table></figure><h2 id="Roles-角色"><a href="#Roles-角色" class="headerlink" title="Roles 角色"></a>Roles 角色</h2><p>角色是ansible自1.2版本引入的新特性，用于层次性、结构化地组织playbook。roles能够根据层次型结构自动装载变量文件、tasks以及handlers等。要使用roles只需要在playbook中使用include指令即可。简单来讲，roles就是通过分别将变量、文件、任务、模板及处理器放置于单独的目录中，并可以便捷地include它们的一种机制。角色一般用于基于主机构建服务的场景中，但也可以是用于构建守护进程等场景中<br>运维复杂的场景：建议使用 roles，代码复用度高<br>roles：多个角色的集合目录， 可以将多个的role，分别放至roles目录下的独立子目录中,如下示例</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs">roles/<br>mysql/<br>nginx/<br>tomcat/<br>redis/<br></code></pre></td></tr></table></figure><p>默认roles存放路径</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-regexp">/root/</span>.ansible/roles<br><span class="hljs-regexp">/usr/</span>share<span class="hljs-regexp">/ansible/</span>roles<br><span class="hljs-regexp">/etc/</span>ansible/roles<br></code></pre></td></tr></table></figure><p>官方文档:</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">https:<span class="hljs-regexp">//</span>docs.ansible.com<span class="hljs-regexp">/ansible/</span>latest<span class="hljs-regexp">/user_guide/</span>playbooks_reuse_roles.html<br></code></pre></td></tr></table></figure><h3 id="Ansible-Roles目录编排"><a href="#Ansible-Roles目录编排" class="headerlink" title="Ansible Roles目录编排"></a>Ansible Roles目录编排</h3><p>roles目录结构如下所示</p><p><img src="/../image.assets/1677664119238.png" srcset="/img/loading.gif" lazyload alt="1677664119238"></p><p>每个角色，以特定的层级目录结构进行组织<br>roles目录结构：</p><figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs actionscript">playbook1.yml<br>playbook2.yml<br>roles/<br>project1/<br>tasks/<br>files/<br>vars/<br>templates/<br>handlers/<br><span class="hljs-keyword">default</span>/<br>meta/<br>project2/<br>tasks/<br>files/<br>vars/<br>templates/<br>handlers/<br><span class="hljs-keyword">default</span>/<br>meta/<br></code></pre></td></tr></table></figure><p>Roles各目录作用<br>roles&#x2F;project&#x2F; :项目名称,有以下子目录</p><ul><li>files&#x2F; ：存放由copy或script模块等调用的文件</li><li>templates&#x2F;：template模块查找所需要模板文件的目录</li><li>tasks&#x2F;：定义task,role的基本元素，至少应该包含一个名为main.yml的文件；其它的文件需要在此文件中通过include进行包含</li><li>handlers&#x2F;：至少应该包含一个名为main.yml的文件；此目录下的其它的文件需要在此文件中通过include进行包含</li><li>vars&#x2F;：定义变量，至少应该包含一个名为main.yml的文件；此目录下的其它的变量文件需要在此文件中通过include进行包含,也可以通过项目目录中的group_vars&#x2F;all定义变量,从而实现角色通用代码和项目数据的分离</li><li>meta&#x2F;：定义当前角色的特殊设定及其依赖关系,至少应该包含一个名为main.yml的文件，其它文件需在此文件中通过include进行包含</li><li>default&#x2F;：设定默认变量时使用此目录中的main.yml文件，比vars的优先级低</li></ul><h3 id="创建-role"><a href="#创建-role" class="headerlink" title="创建 role"></a>创建 role</h3><p>创建role的步骤</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs text">1 创建role的目录结构.在以roles命名的目录下分别创建以各角色名称命名的目录，如mysql等,在每个角色命名的目录中分别创建相关的目录和文件,比如tasks、files、handlers、templates和vars等目录；用不到的目录可以创建为空目录，也可以不创建<br>2 编写和准备指定role的功能文件,包括: tasks,templates,vars等相关文件<br>3 编写playbook文件调用上面定义的role,应用到指定的主机<br></code></pre></td></tr></table></figure><p>针对大型项目使用Roles进行编排<br>范例: 利用 ansible-galaxy 创建角色目录的结构</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs stylus">#创建初始化目录结构<br><span class="hljs-selector-attr">[root@ansible roles]</span><span class="hljs-selector-id">#ansible-galaxy</span> role init test_role<br>- Role test_role was created successfully<br><span class="hljs-selector-attr">[root@ansible roles]</span><span class="hljs-selector-id">#tree</span> test_role/<br>test_role/<br>├── defaults<br>│ └── <span class="hljs-selector-tag">main</span><span class="hljs-selector-class">.yml</span><br>├── files<br>├── handlers<br>│ └── <span class="hljs-selector-tag">main</span><span class="hljs-selector-class">.yml</span><br>├── meta<br>│ └── <span class="hljs-selector-tag">main</span><span class="hljs-selector-class">.yml</span><br>├── README<span class="hljs-selector-class">.md</span><br>├── tasks<br>│ └── <span class="hljs-selector-tag">main</span><span class="hljs-selector-class">.yml</span><br>├── templates<br>├── tests<br>│ ├── inventory<br>│ └── test<span class="hljs-selector-class">.yml</span><br>└── vars<br>└── <span class="hljs-selector-tag">main</span><span class="hljs-selector-class">.yml</span><br><span class="hljs-number">8</span> directories, <span class="hljs-number">8</span> files<br></code></pre></td></tr></table></figure><p>范例：roles的目录结构</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs stylus">nginx-role<span class="hljs-selector-class">.yml</span><br>roles/<br>└── nginx<br>├── files<br>│ └── nginx<span class="hljs-selector-class">.conf</span><br>├── tasks<br>│ ├── groupadd<span class="hljs-selector-class">.yml</span><br>│ ├── install<span class="hljs-selector-class">.yml</span><br>│ ├── <span class="hljs-selector-tag">main</span><span class="hljs-selector-class">.yml</span><br>│ ├── restart<span class="hljs-selector-class">.yml</span><br>│ └── useradd<span class="hljs-selector-class">.yml</span><br>└── vars<br>└── <span class="hljs-selector-tag">main</span>.yml<br></code></pre></td></tr></table></figure><h3 id="Playbook-调用角色"><a href="#Playbook-调用角色" class="headerlink" title="Playbook 调用角色"></a>Playbook 调用角色</h3><p>调用角色方法1：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">webservers</span><br>  <span class="hljs-attr">remote_user:</span> <span class="hljs-string">root</span><br>  <span class="hljs-attr">roles:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">mysql</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">memcached</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">nginx</span><br></code></pre></td></tr></table></figure><p>调用角色方法2：<br>键role用于指定角色名称，后续的k&#x2F;v用于传递变量给角色</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">all</span><br>  <span class="hljs-attr">remote_user:</span> <span class="hljs-string">root</span><br>  <span class="hljs-attr">roles:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">role:</span> <span class="hljs-string">mysql</span><br>    <span class="hljs-attr">username:</span> <span class="hljs-string">mysql</span><br>    <span class="hljs-bullet">-</span> &#123; <span class="hljs-attr">role:</span> <span class="hljs-string">nginx</span>, <span class="hljs-attr">username:</span> <span class="hljs-string">nginx</span> &#125;<br></code></pre></td></tr></table></figure><p>调用角色方法3：<br>还可基于条件测试实现角色调用</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">all</span><br>  <span class="hljs-attr">remote_user:</span> <span class="hljs-string">root</span><br>  <span class="hljs-attr">roles:</span><br>   <span class="hljs-bullet">-</span> &#123; <span class="hljs-attr">role:</span> <span class="hljs-string">nginx</span>, <span class="hljs-attr">username:</span> <span class="hljs-string">nginx</span>, <span class="hljs-attr">when:</span> <span class="hljs-string">ansible_distribution_major_version</span> <span class="hljs-string">==</span> <span class="hljs-string">&#x27;7&#x27;</span> &#125;<br></code></pre></td></tr></table></figure><h3 id="Roles-中-Tags-使用"><a href="#Roles-中-Tags-使用" class="headerlink" title="Roles 中 Tags 使用"></a>Roles 中 Tags 使用</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs yaml">[<span class="hljs-string">root@ansible</span> <span class="hljs-string">~</span>]<span class="hljs-comment">#vi app-role.yml</span><br><span class="hljs-meta">---</span><br><span class="hljs-comment">#可以有多个play</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">lbserver</span><br>  <span class="hljs-attr">roles:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">role:</span> <span class="hljs-string">haproxy</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">role:</span> <span class="hljs-string">keepalived</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">appsrvs</span><br>  <span class="hljs-attr">remote_user:</span> <span class="hljs-string">root</span><br>  <span class="hljs-attr">roles:</span><br>    <span class="hljs-bullet">-</span> &#123; <span class="hljs-attr">role:</span> <span class="hljs-string">nginx</span> ,<span class="hljs-attr">tags:</span> [ <span class="hljs-string">&#x27;nginx&#x27;</span>, <span class="hljs-string">&#x27;web&#x27;</span> ] ,<span class="hljs-attr">when:</span><br>    <span class="hljs-string">ansible_distribution_major_version</span> <span class="hljs-string">==</span> <span class="hljs-string">&quot;6&quot;</span> &#125;<br>    <span class="hljs-bullet">-</span> &#123; <span class="hljs-attr">role:</span> <span class="hljs-string">httpd</span> ,<span class="hljs-attr">tags:</span> [ <span class="hljs-string">&#x27;httpd&#x27;</span>, <span class="hljs-string">&#x27;web&#x27;</span> ] &#125;<br>    <span class="hljs-bullet">-</span> &#123; <span class="hljs-attr">role:</span> <span class="hljs-string">mysql</span> ,<span class="hljs-attr">tags:</span> [ <span class="hljs-string">&#x27;mysql&#x27;</span>, <span class="hljs-string">&#x27;db&#x27;</span> ] &#125;<br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">role:</span> <span class="hljs-string">mariadb</span><br>      <span class="hljs-attr">tags:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">mariadb</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">db</span><br>  <span class="hljs-attr">tags:</span> <span class="hljs-string">app</span> <span class="hljs-comment">#play的tag</span><br>[<span class="hljs-string">root@ansible</span> <span class="hljs-string">~</span>]<span class="hljs-comment">#ansible-playbook --tags=&quot;nginx,mysql&quot; app-role.yml</span><br></code></pre></td></tr></table></figure><h3 id="实战案例"><a href="#实战案例" class="headerlink" title="实战案例"></a>实战案例</h3><h4 id="实现httpd角色"><a href="#实现httpd角色" class="headerlink" title="实现httpd角色"></a>实现httpd角色</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># 创建role目录</span><br>[<span class="hljs-string">root@ansible</span> <span class="hljs-string">data</span>]<span class="hljs-comment"># ansible-galaxy role init httpd</span><br><span class="hljs-bullet">-</span> <span class="hljs-string">Role</span> <span class="hljs-string">htppd</span> <span class="hljs-string">was</span> <span class="hljs-string">created</span> <span class="hljs-string">successfully</span><br>[<span class="hljs-string">root@ansible</span> <span class="hljs-string">data</span>]<span class="hljs-comment"># tree httpd/</span><br><span class="hljs-string">httpd/</span><br><span class="hljs-string">├──</span> <span class="hljs-string">defaults</span><br><span class="hljs-string">│</span>   <span class="hljs-string">└──</span> <span class="hljs-string">main.yml</span><br><span class="hljs-string">├──</span> <span class="hljs-string">files</span><br><span class="hljs-string">├──</span> <span class="hljs-string">handlers</span><br><span class="hljs-string">│</span>   <span class="hljs-string">└──</span> <span class="hljs-string">main.yml</span><br><span class="hljs-string">├──</span> <span class="hljs-string">meta</span><br><span class="hljs-string">│</span>   <span class="hljs-string">└──</span> <span class="hljs-string">main.yml</span><br><span class="hljs-string">├──</span> <span class="hljs-string">README.md</span><br><span class="hljs-string">├──</span> <span class="hljs-string">tasks</span><br><span class="hljs-string">│</span>   <span class="hljs-string">└──</span> <span class="hljs-string">main.yml</span><br><span class="hljs-string">├──</span> <span class="hljs-string">templates</span><br><span class="hljs-string">├──</span> <span class="hljs-string">tests</span><br><span class="hljs-string">│</span>   <span class="hljs-string">├──</span> <span class="hljs-string">inventory</span><br><span class="hljs-string">│</span>   <span class="hljs-string">└──</span> <span class="hljs-string">test.yml</span><br><span class="hljs-string">└──</span> <span class="hljs-string">vars</span><br>    <span class="hljs-string">└──</span> <span class="hljs-string">main.yml</span><br><br><span class="hljs-number">8</span> <span class="hljs-string">directories,</span> <span class="hljs-number">8</span> <span class="hljs-string">files</span><br>[<span class="hljs-string">root@ansible</span> <span class="hljs-string">data</span>]<span class="hljs-comment"># </span><br><br><span class="hljs-comment">#main.yml 是task的入口文件</span><br>[<span class="hljs-string">root@ansible</span> <span class="hljs-string">tasks</span>]<span class="hljs-comment"># cat main.yml </span><br><span class="hljs-meta">---</span><br><span class="hljs-comment"># tasks file for httpd</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">include:</span> <span class="hljs-string">group.yml</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">include:</span> <span class="hljs-string">user.yml</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">include:</span> <span class="hljs-string">install_httpd.yml</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">include:</span> <span class="hljs-string">config.yml</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">inclusde:</span> <span class="hljs-string">index.yml</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">include:</span> <span class="hljs-string">service.yml</span><br>[<span class="hljs-string">root@ansible</span> <span class="hljs-string">tasks</span>]<span class="hljs-comment"># </span><br><br><span class="hljs-comment"># 创建用户组</span><br>[<span class="hljs-string">root@ansible</span> <span class="hljs-string">httpd</span>]<span class="hljs-comment"># cat tasks/group.yml </span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">add</span> <span class="hljs-string">group</span> <br>  <span class="hljs-attr">group:</span> <span class="hljs-string">name=&#123;&#123;</span> <span class="hljs-string">httpd_group&#125;&#125;</span> <span class="hljs-string">system=yes</span> <span class="hljs-string">gid=&#123;&#123;</span> <span class="hljs-string">httpd_gid</span> <span class="hljs-string">&#125;&#125;</span><br>[<span class="hljs-string">root@ansible</span> <span class="hljs-string">htppd</span>]<span class="hljs-comment"># </span><br><br><span class="hljs-comment"># 创建用户</span><br>[<span class="hljs-string">root@ansible</span> <span class="hljs-string">httpd</span>]<span class="hljs-comment"># cat tasks/user.yml </span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">add</span> <span class="hljs-string">httpd</span> <span class="hljs-string">user</span><br>  <span class="hljs-attr">user:</span> <span class="hljs-string">name=&#123;&#123;</span> <span class="hljs-string">httpd_user</span> <span class="hljs-string">&#125;&#125;</span> <span class="hljs-string">system=yes</span> <span class="hljs-string">shel=/sbin/nologin</span> <span class="hljs-string">home=/var/www</span> <span class="hljs-string">uid=&#123;&#123;</span> <span class="hljs-string">httpd_uid</span> <span class="hljs-string">&#125;&#125;</span> <span class="hljs-string">group=&#123;&#123;</span> <span class="hljs-string">httpd_group</span> <span class="hljs-string">&#125;&#125;</span><br>[<span class="hljs-string">root@ansible</span> <span class="hljs-string">htppd</span>]<span class="hljs-comment"># </span><br><br><span class="hljs-comment"># yum install httpd</span><br>[<span class="hljs-string">root@ansible</span> <span class="hljs-string">httpd</span>]<span class="hljs-comment"># cat tasks/install_httpd.yml </span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">install</span> <span class="hljs-string">httpd</span><br>  <span class="hljs-attr">yum:</span> <span class="hljs-string">name=httpd</span><br>[<span class="hljs-string">root@ansible</span> <span class="hljs-string">httpd</span>]<span class="hljs-comment"># </span><br><br><span class="hljs-comment"># 拷贝配置文件</span><br><span class="hljs-comment">#注意: 文件是放在files目录下,但src的路径无需写files目录名</span><br>[<span class="hljs-string">root@ansible</span> <span class="hljs-string">htppd</span>]<span class="hljs-comment"># cat tasks/config.yml</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">httpd</span> <span class="hljs-string">config</span><br>  <span class="hljs-attr">copy:</span> <span class="hljs-string">src=httpd.conf</span> <span class="hljs-string">dest=/etc/httpd/conf</span> <span class="hljs-string">backup=yes</span><br>  <span class="hljs-attr">notify:</span> <span class="hljs-string">restart</span> <span class="hljs-string">httpd</span><br> <br> <span class="hljs-comment"># 准备测试文件</span><br>[<span class="hljs-string">root@ansible</span> <span class="hljs-string">htppd</span>]<span class="hljs-comment"># cat tasks/index.yml </span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">copy</span> <span class="hljs-string">index.html</span><br>  <span class="hljs-attr">copy:</span> <span class="hljs-string">src=index.html</span> <span class="hljs-string">dest=/var/www/html</span><br>[<span class="hljs-string">root@ansible</span> <span class="hljs-string">htppd</span>]<span class="hljs-comment"># </span><br><br><span class="hljs-comment"># start httpd</span><br>[<span class="hljs-string">root@ansible</span> <span class="hljs-string">htppd</span>]<span class="hljs-comment"># cat tasks/service.yml </span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">start</span> <span class="hljs-string">httpd</span><br>  <span class="hljs-attr">service:</span> <span class="hljs-string">name=httpd</span> <span class="hljs-string">state=started</span> <span class="hljs-string">enabled=yes</span><br>[<span class="hljs-string">root@ansible</span> <span class="hljs-string">htppd</span>]<span class="hljs-comment"># </span><br><br><span class="hljs-comment"># 配置文件修改则重启httpd</span><br>[<span class="hljs-string">root@ansible</span> <span class="hljs-string">htppd</span>]<span class="hljs-comment"># cat handlers/main.yml </span><br><span class="hljs-meta">---</span><br><span class="hljs-comment"># handlers file for httpd</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">restart</span> <span class="hljs-string">httpd</span><br>  <span class="hljs-attr">service:</span> <span class="hljs-string">name=httpd</span> <span class="hljs-string">state=restarted</span><br>[<span class="hljs-string">root@ansible</span> <span class="hljs-string">htppd</span>]<span class="hljs-comment"># </span><br><br><span class="hljs-comment">#在files目录下准备两个文件</span><br>[<span class="hljs-string">root@ansible</span> <span class="hljs-string">data</span>]<span class="hljs-comment"># ll httpd/files</span><br><span class="hljs-string">total</span> <span class="hljs-number">16</span><br><span class="hljs-string">-rw-r--r--</span> <span class="hljs-number">1</span> <span class="hljs-string">root</span> <span class="hljs-string">root</span> <span class="hljs-number">11753</span> <span class="hljs-string">Mar</span>  <span class="hljs-number">1</span> <span class="hljs-number">18</span><span class="hljs-string">:36</span> <span class="hljs-string">httpd.conf</span><br><span class="hljs-string">-rw-r--r--</span> <span class="hljs-number">1</span> <span class="hljs-string">root</span> <span class="hljs-string">root</span>    <span class="hljs-number">23</span> <span class="hljs-string">Mar</span>  <span class="hljs-number">1</span> <span class="hljs-number">21</span><span class="hljs-string">:10</span> <span class="hljs-string">index.html</span><br><br><span class="hljs-comment"># 准备变量文件</span><br>[<span class="hljs-string">root@ansible</span> <span class="hljs-string">data</span>]<span class="hljs-comment"># cat httpd/vars/main.yml </span><br><span class="hljs-meta">---</span><br><span class="hljs-comment"># vars file for httpd</span><br><span class="hljs-attr">httpd_group:</span> <span class="hljs-string">apache</span><br><span class="hljs-attr">httpd_gid:</span> <span class="hljs-number">88</span><br><span class="hljs-attr">httpd_user:</span> <span class="hljs-string">apache</span><br><span class="hljs-attr">httpd_uid:</span> <span class="hljs-number">88</span><br>[<span class="hljs-string">root@ansible</span> <span class="hljs-string">data</span>]<span class="hljs-comment"># </span><br><br><span class="hljs-comment">#在playbook中调用角色</span><br>[<span class="hljs-string">root@ansible</span> <span class="hljs-string">data</span>]<span class="hljs-comment"># cat web_roles.yml </span><br><span class="hljs-meta">---</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">centos7</span><br>  <span class="hljs-attr">remote_user:</span> <span class="hljs-string">root</span><br>  <span class="hljs-attr">roles:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">httpd</span><br>    <br><span class="hljs-comment">#运行playbook</span><br>[<span class="hljs-string">root@ansible</span> <span class="hljs-string">data</span>]<span class="hljs-comment"># ansible-playbook /data/web_roles.yml</span><br></code></pre></td></tr></table></figure><h4 id="实现Nginx角色"><a href="#实现Nginx角色" class="headerlink" title="实现Nginx角色"></a>实现Nginx角色</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># 创建roles目录</span><br>[<span class="hljs-string">root@ansible</span> <span class="hljs-string">data</span>]<span class="hljs-comment"># ansible-galaxy init nginx</span><br><span class="hljs-bullet">-</span> <span class="hljs-string">Role</span> <span class="hljs-string">nginx</span> <span class="hljs-string">was</span> <span class="hljs-string">created</span> <span class="hljs-string">successfully</span><br>[<span class="hljs-string">root@ansible</span> <span class="hljs-string">data</span>]<span class="hljs-comment"># ll</span><br><span class="hljs-string">total</span> <span class="hljs-number">12</span><br><span class="hljs-string">-rw-r--r--</span>  <span class="hljs-number">1</span> <span class="hljs-string">root</span> <span class="hljs-string">root</span>  <span class="hljs-number">614</span> <span class="hljs-string">Mar</span>  <span class="hljs-number">1</span> <span class="hljs-number">21</span><span class="hljs-string">:07</span> <span class="hljs-string">ansible.cfg</span><br><span class="hljs-string">-rw-r--r--</span>  <span class="hljs-number">1</span> <span class="hljs-string">root</span> <span class="hljs-string">root</span> <span class="hljs-number">1382 </span><span class="hljs-string">Mar</span>  <span class="hljs-number">1</span> <span class="hljs-number">21</span><span class="hljs-string">:07</span> <span class="hljs-string">hosts</span><br><span class="hljs-string">drwxr-xr-x</span> <span class="hljs-number">10</span> <span class="hljs-string">root</span> <span class="hljs-string">root</span>  <span class="hljs-number">154</span> <span class="hljs-string">Mar</span>  <span class="hljs-number">1</span> <span class="hljs-number">18</span><span class="hljs-string">:07</span> <span class="hljs-string">httpd</span><br><span class="hljs-string">drwxr-xr-x</span> <span class="hljs-number">10</span> <span class="hljs-string">root</span> <span class="hljs-string">root</span>  <span class="hljs-number">154</span> <span class="hljs-string">Mar</span>  <span class="hljs-number">1</span> <span class="hljs-number">21</span><span class="hljs-string">:52</span> <span class="hljs-string">nginx</span><br><span class="hljs-string">-rw-r--r--</span>  <span class="hljs-number">1</span> <span class="hljs-string">root</span> <span class="hljs-string">root</span>   <span class="hljs-number">63</span> <span class="hljs-string">Mar</span>  <span class="hljs-number">1</span> <span class="hljs-number">21</span><span class="hljs-string">:14</span> <span class="hljs-string">web_roles.yml</span><br>[<span class="hljs-string">root@ansible</span> <span class="hljs-string">data</span>]<span class="hljs-comment"># </span><br><br><span class="hljs-comment"># 创建tasks文件</span><br>[<span class="hljs-string">root@ansible</span> <span class="hljs-string">data</span>]<span class="hljs-comment"># cat nginx/tasks/main.yml </span><br><span class="hljs-meta">---</span><br><span class="hljs-comment"># tasks file for nginx</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">include:</span> <span class="hljs-string">install_nginx.yml</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">import_playbook:</span> <span class="hljs-string">config.yml</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">include:</span> <span class="hljs-string">index.yml</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">import_playbook:</span> <span class="hljs-string">service.yml</span><br>[<span class="hljs-string">root@ansible</span> <span class="hljs-string">data</span>]<span class="hljs-comment">#</span><br><br><span class="hljs-comment"># 安装nginx</span><br>[<span class="hljs-string">root@ansible</span> <span class="hljs-string">data</span>]<span class="hljs-comment"># cat nginx/tasks/install_nginx.yml</span><br><span class="hljs-meta">---</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">install</span> <span class="hljs-string">nginx</span><br>  <span class="hljs-attr">yum:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">nginx</span><br>    <span class="hljs-attr">state:</span> <span class="hljs-string">present</span><br>[<span class="hljs-string">root@ansible</span> <span class="hljs-string">data</span>]<span class="hljs-comment"># </span><br><br><span class="hljs-comment"># 配置文件</span><br>[<span class="hljs-string">root@ansible</span> <span class="hljs-string">data</span>]<span class="hljs-comment"># cat nginx/tasks/config.yml</span><br><span class="hljs-meta">---</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">copy</span> <span class="hljs-string">config</span><br>  <span class="hljs-attr">template:</span> <span class="hljs-string">src=nginx.conf.j2</span> <span class="hljs-string">dest=/etc/nginx/nginx.conf</span><br>  <span class="hljs-attr">notify:</span> <span class="hljs-string">restart</span> <span class="hljs-string">nginx</span><br>  <br><span class="hljs-comment"># 创建测试文件</span><br>[<span class="hljs-string">root@ansible</span> <span class="hljs-string">data</span>]<span class="hljs-comment"># cat nginx/tasks/index.yml</span><br><span class="hljs-meta">---</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">copt</span> <span class="hljs-string">index.html</span><br>  <span class="hljs-attr">copy:</span> <span class="hljs-string">src=index.html</span> <span class="hljs-string">dest=/usr/share/nginx/html/</span><br><br><span class="hljs-comment"># 启动nginx</span><br>[<span class="hljs-string">root@ansible</span> <span class="hljs-string">data</span>]<span class="hljs-comment"># cat nginx/tasks/service.yml</span><br><span class="hljs-meta">---</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">start</span> <span class="hljs-string">nginx</span><br>  <span class="hljs-attr">service:</span> <span class="hljs-string">name=nginx</span> <span class="hljs-string">state=started</span> <span class="hljs-string">enabled=yes</span><br>  <br><span class="hljs-comment">#创建handler文件</span><br>[<span class="hljs-string">root@ansible</span> <span class="hljs-string">data</span>]<span class="hljs-comment"># cat nginx/handlers/main.yml </span><br><span class="hljs-meta">---</span><br><span class="hljs-comment"># handlers file for nginx</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">restart</span> <span class="hljs-string">nginx</span><br>  <span class="hljs-attr">service:</span> <span class="hljs-string">naem=nginx</span> <span class="hljs-string">state=restarted</span><br>[<span class="hljs-string">root@ansible</span> <span class="hljs-string">data</span>]<span class="hljs-comment"># ll</span><br><br><span class="hljs-comment">#创建template文件</span><br>[<span class="hljs-string">root@ansible</span> <span class="hljs-string">data</span>]<span class="hljs-comment"># ll nginx/templates/</span><br><span class="hljs-string">total</span> <span class="hljs-number">4</span><br><span class="hljs-string">-rw-r--r--</span> <span class="hljs-number">1</span> <span class="hljs-string">root</span> <span class="hljs-string">root</span> <span class="hljs-number">2336 </span><span class="hljs-string">Mar</span>  <span class="hljs-number">1</span> <span class="hljs-number">22</span><span class="hljs-string">:12</span> <span class="hljs-string">nginx.conf.j2</span><br>[<span class="hljs-string">root@ansible</span> <span class="hljs-string">data</span>]<span class="hljs-comment"># </span><br><br><br><span class="hljs-comment"># 创建测试文件</span><br>[<span class="hljs-string">root@ansible</span> <span class="hljs-string">data</span>]<span class="hljs-comment"># ll nginx/files/</span><br><span class="hljs-string">total</span> <span class="hljs-number">4</span><br><span class="hljs-string">-rw-r--r--</span> <span class="hljs-number">1</span> <span class="hljs-string">root</span> <span class="hljs-string">root</span> <span class="hljs-number">23</span> <span class="hljs-string">Mar</span>  <span class="hljs-number">1</span> <span class="hljs-number">22</span><span class="hljs-string">:14</span> <span class="hljs-string">index.html</span><br>[<span class="hljs-string">root@ansible</span> <span class="hljs-string">data</span>]<span class="hljs-comment">#</span><br><br><span class="hljs-comment">#在playbook中调用角色</span><br>[<span class="hljs-string">root@ansible</span> <span class="hljs-string">data</span>]<span class="hljs-comment"># cat web_roles.yml </span><br><span class="hljs-meta">---</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">centos7</span><br>  <span class="hljs-attr">remote_user:</span> <span class="hljs-string">root</span><br>  <span class="hljs-attr">roles:</span><br>  <span class="hljs-comment">#  - httpd</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">nginx</span><br>[<span class="hljs-string">root@ansible</span> <span class="hljs-string">data</span>]<span class="hljs-comment"># </span><br><span class="hljs-comment">#运行playbook</span><br>[<span class="hljs-string">root@ansible</span> <span class="hljs-string">data</span>]<span class="hljs-comment"># ansible-playbook web_roles.yml </span><br></code></pre></td></tr></table></figure><h4 id="实现MySql8角色"><a href="#实现MySql8角色" class="headerlink" title="实现MySql8角色"></a>实现MySql8角色</h4><ul><li>创建角色目录</li></ul><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs tap">[root@ansible data]<span class="hljs-comment"># ansible-galaxy init mysql8</span><br>[root@ansible data]<span class="hljs-comment"># ll</span><br>total 12<br>-rw-r--r-- <span class="hljs-number"> 1 </span>root root <span class="hljs-number"> 614 </span>Mar <span class="hljs-number"> 1 </span>21:07 ansible.cfg<br>-rw-r--r-- <span class="hljs-number"> 1 </span>root root<span class="hljs-number"> 1382 </span>Mar <span class="hljs-number"> 1 </span>21:07 hosts<br>drwxr-xr-x<span class="hljs-number"> 10 </span>root root <span class="hljs-number"> 154 </span>Mar <span class="hljs-number"> 1 </span>18:07 httpd<br>drwxr-xr-x<span class="hljs-number"> 10 </span>root root <span class="hljs-number"> 154 </span>Mar <span class="hljs-number"> 1 </span>22:55 mysql8<br>drwxr-xr-x <span class="hljs-number"> 8 </span>root root <span class="hljs-number"> 125 </span>Mar <span class="hljs-number"> 1 </span>22:44 nginx<br>-rw-r--r-- <span class="hljs-number"> 1 </span>root root  <span class="hljs-number"> 75 </span>Mar <span class="hljs-number"> 1 </span>22:38 web_roles.yml<br>[root@ansible data]<span class="hljs-comment"># </span><br></code></pre></td></tr></table></figure><ul><li>创建tasks yml文件</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># 安装包</span><br>[<span class="hljs-string">root@ansible</span> <span class="hljs-string">data</span>]<span class="hljs-comment"># cat mysql8/tasks/install_package.yml</span><br><span class="hljs-meta">---</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">install</span> <span class="hljs-string">package</span><br>  <span class="hljs-attr">yum:</span> <span class="hljs-string">name=&#123;&#123;</span> <span class="hljs-string">item</span> <span class="hljs-string">&#125;&#125;</span> <span class="hljs-string">state=latest</span><br>  <span class="hljs-attr">loop:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">libaio</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">numactl-libs</span><br>    <br><span class="hljs-comment"># add group</span><br>[<span class="hljs-string">root@ansible</span> <span class="hljs-string">data</span>]<span class="hljs-comment"># cat mysql8/tasks/group.yml</span><br><span class="hljs-meta">---</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">add</span> <span class="hljs-string">group</span><br>  <span class="hljs-attr">group:</span> <span class="hljs-string">name=&#123;&#123;</span> <span class="hljs-string">group</span> <span class="hljs-string">&#125;&#125;</span> <span class="hljs-string">gid=&#123;&#123;</span> <span class="hljs-string">group_gid</span> <span class="hljs-string">&#125;&#125;</span><br>[<span class="hljs-string">root@ansible</span> <span class="hljs-string">data</span>]<span class="hljs-comment"># </span><br><br><span class="hljs-comment"># add user</span><br>[<span class="hljs-string">root@ansible</span> <span class="hljs-string">data</span>]<span class="hljs-comment"># cat mysql8/tasks/user.yml</span><br><span class="hljs-meta">---</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">add</span> <span class="hljs-string">user</span><br>  <span class="hljs-attr">user:</span> <span class="hljs-string">name=&#123;&#123;</span> <span class="hljs-string">user</span> <span class="hljs-string">&#125;&#125;</span> <span class="hljs-string">uid=&#123;&#123;</span> <span class="hljs-string">user_uid</span> <span class="hljs-string">&#125;&#125;</span> <span class="hljs-string">shell=/sbin/nologin</span> <span class="hljs-string">group=&#123;&#123;</span> <span class="hljs-string">group</span> <span class="hljs-string">&#125;&#125;</span> <span class="hljs-string">create_home=no</span> <span class="hljs-string">system=yes</span> <span class="hljs-string">home=/data/mysql</span><br>[<span class="hljs-string">root@ansible</span> <span class="hljs-string">data</span>]<span class="hljs-comment"># </span><br><br><span class="hljs-comment"># 准备my.cnf文件</span><br>[<span class="hljs-string">root@ansible</span> <span class="hljs-string">data</span>]<span class="hljs-comment"># cat mysql8/files/my.cnf</span><br>[<span class="hljs-string">mysqld</span>]<br><span class="hljs-string">server-id=1</span><br><span class="hljs-string">log-bin</span><br><span class="hljs-string">datadir=/data/mysql</span><br><span class="hljs-string">socket=/data/mysql/mysql.sock</span><br><span class="hljs-string">log-error=/data/mysql/mysql.log</span><br><span class="hljs-string">pid-file=/data/mysql/mysql.pid</span><br>[<span class="hljs-string">client</span>]<br><span class="hljs-string">socket=/data/mysql/mysql.sock</span><br><br><span class="hljs-comment"># 准备mysql二进制包</span><br>[<span class="hljs-string">root@ansible</span> <span class="hljs-string">data</span>]<span class="hljs-comment"># ll mysql8/files/</span><br><span class="hljs-string">total</span> <span class="hljs-number">1176056</span><br><span class="hljs-string">-rw-r--r--</span> <span class="hljs-number">1</span> <span class="hljs-string">root</span> <span class="hljs-string">root</span>        <span class="hljs-number">181</span> <span class="hljs-string">Mar</span>  <span class="hljs-number">1</span> <span class="hljs-number">23</span><span class="hljs-string">:10</span> <span class="hljs-string">my.cnf</span><br><span class="hljs-string">-rw-r--r--</span> <span class="hljs-number">1</span> <span class="hljs-string">root</span> <span class="hljs-string">root</span> <span class="hljs-number">1204277208</span> <span class="hljs-string">Dec</span> <span class="hljs-number">18</span>  <span class="hljs-number">2021 </span><span class="hljs-string">mysql-8.0.28-linux-glibc2.12-x86_64.tar.xz</span><br>[<span class="hljs-string">root@ansible</span> <span class="hljs-string">data</span>]<span class="hljs-comment"># </span><br><br><span class="hljs-comment"># 将mysql二进制包解压到远程主机</span><br>[<span class="hljs-string">root@ansible</span> <span class="hljs-string">data</span>]<span class="hljs-comment"># cat mysql8/tasks/unarchive.yml</span><br><span class="hljs-meta">---</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">copy</span> <span class="hljs-string">mysql</span> <span class="hljs-string">tar</span> <span class="hljs-string">host</span><br>  <span class="hljs-comment"># mysql_tar 为mysql二进制的压缩包名称</span><br>  <span class="hljs-attr">unarchive:</span> <span class="hljs-string">src=&#123;&#123;</span> <span class="hljs-string">mysql_tar</span> <span class="hljs-string">&#125;&#125;</span> <span class="hljs-string">dest=/usr/local/</span> <span class="hljs-string">owner=root</span> <span class="hljs-string">group=root</span><br>[<span class="hljs-string">root@ansible</span> <span class="hljs-string">data</span>]<span class="hljs-comment"># </span><br><br><span class="hljs-comment"># 将远程主机解压出的二进制包创建软连接</span><br>[<span class="hljs-string">root@ansible</span> <span class="hljs-string">data</span>]<span class="hljs-comment"># cat mysql8/tasks/linkfile.yml</span><br><span class="hljs-meta">---</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">create</span> <span class="hljs-string">link</span><br>  <span class="hljs-attr">file:</span> <span class="hljs-string">src=/usr/local/mysql-&#123;&#123;</span> <span class="hljs-string">mysql_version</span> <span class="hljs-string">&#125;&#125;-linux-glibc2.12-x86_64</span> <span class="hljs-string">dest=/usr/local/mysql</span> <span class="hljs-string">state=link</span><br>[<span class="hljs-string">root@ansible</span> <span class="hljs-string">data</span>]<span class="hljs-comment"># </span><br><br><span class="hljs-comment"># 初始化数据库</span><br>[<span class="hljs-string">root@ansible</span> <span class="hljs-string">data</span>]<span class="hljs-comment"># cat mysql8/tasks/init_mysql_data.yml</span><br><span class="hljs-meta">---</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">create</span> <span class="hljs-string">datadir</span> <span class="hljs-string">dir</span><br>  <span class="hljs-attr">file:</span> <span class="hljs-string">path=/data/mysql</span> <span class="hljs-string">state=directory</span> <span class="hljs-string">owner=&#123;&#123;</span> <span class="hljs-string">user</span> <span class="hljs-string">&#125;&#125;</span> <span class="hljs-string">group=&#123;&#123;</span> <span class="hljs-string">group</span> <span class="hljs-string">&#125;</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">init</span> <span class="hljs-string">mysql</span> <span class="hljs-string">data</span><br>  <span class="hljs-attr">shell:</span> <span class="hljs-string">/usr/local/mysql/bin/mysqld</span> <span class="hljs-string">--initialize-insecure</span> <span class="hljs-string">--user=mysql</span> <span class="hljs-string">--datadir=/data/mysql</span><br>[<span class="hljs-string">root@ansible</span> <span class="hljs-string">data</span>]<span class="hljs-comment">#</span><br><br><span class="hljs-comment"># copy config.con</span><br>[<span class="hljs-string">root@ansible</span> <span class="hljs-string">data</span>]<span class="hljs-comment"># cat mysql8/tasks/config.yml</span><br><span class="hljs-meta">---</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">copy</span> <span class="hljs-string">my.cnf</span><br>  <span class="hljs-attr">copy:</span> <span class="hljs-string">src=my.cnf</span> <span class="hljs-string">dest=/etc/my.cnf</span><br>[<span class="hljs-string">root@ansible</span> <span class="hljs-string">data</span>]<span class="hljs-comment"># </span><br><br>[<span class="hljs-string">root@ansible</span> <span class="hljs-string">data</span>]<span class="hljs-comment"># cat mysql8/tasks/script.yml</span><br><span class="hljs-meta">---</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">service</span> <span class="hljs-string">script</span><br>  <span class="hljs-attr">shell:</span> <span class="hljs-string">/bin/cp</span> <span class="hljs-string">/usr/local/mysql/support-files/mysql.server</span> <span class="hljs-string">/etc/init.d/mysqld</span><br>[<span class="hljs-string">root@ansible</span> <span class="hljs-string">data</span>]<span class="hljs-comment"># </span><br><br>[<span class="hljs-string">root@ansible</span> <span class="hljs-string">data</span>]<span class="hljs-comment"># cat mysql8/tasks/path.yml</span><br><span class="hljs-meta">---</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">path</span><br>  <span class="hljs-attr">copy:</span> <span class="hljs-string">content=&#x27;PATH=/usr/local/mysql/bin:$PATH&#x27;</span> <span class="hljs-string">dest=/etc/profile.d/mysql.sh</span><br><br>[<span class="hljs-string">root@ansible</span> <span class="hljs-string">data</span>]<span class="hljs-comment"># </span><br><br>[<span class="hljs-string">root@ansible</span> <span class="hljs-string">data</span>]<span class="hljs-comment"># cat mysql8/tasks/service.yml</span><br><span class="hljs-meta">---</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">service</span><br>  <span class="hljs-attr">shell:</span> <span class="hljs-string">chkconfig</span> <span class="hljs-string">--add</span> <span class="hljs-string">mysqld;/etc/init.d/mysqld</span> <span class="hljs-string">start</span><br>[<span class="hljs-string">root@ansible</span> <span class="hljs-string">data</span>]<span class="hljs-comment">#</span><br><br>[<span class="hljs-string">root@ansible</span> <span class="hljs-string">data</span>]<span class="hljs-comment"># cat mysql8/tasks/main.yml </span><br><span class="hljs-meta">---</span><br><span class="hljs-comment"># tasks file for mysql8</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">include:</span> <span class="hljs-string">install_package.yml</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">include:</span> <span class="hljs-string">group.yml</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">include:</span> <span class="hljs-string">user.yml</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">include:</span> <span class="hljs-string">unarchive.yml</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">include:</span> <span class="hljs-string">linkfile.yml</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">include:</span> <span class="hljs-string">linkfile.yml</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">include:</span> <span class="hljs-string">init_mysql_data.yml</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">include:</span> <span class="hljs-string">config.yml</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">include:</span> <span class="hljs-string">script.yml</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">include:</span> <span class="hljs-string">path.yml</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">include:</span> <span class="hljs-string">service.yml</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">include:</span> <span class="hljs-string">secure.yml</span><br><br><span class="hljs-comment"># 创建变量文件</span><br>[<span class="hljs-string">root@ansible</span> <span class="hljs-string">data</span>]<span class="hljs-comment"># cat mysql8/vars/main.yml </span><br><span class="hljs-meta">---</span><br><span class="hljs-comment"># vars file for mysql8</span><br><span class="hljs-attr">group:</span> <span class="hljs-string">mysql</span><br><span class="hljs-attr">group_gid:</span> <span class="hljs-number">306</span><br><span class="hljs-attr">user:</span> <span class="hljs-string">mysql</span><br><span class="hljs-attr">user_uid:</span> <span class="hljs-number">306</span><br><span class="hljs-attr">mysql_tar:</span> <span class="hljs-string">mysql-8.0.28-linux-glibc2.12-x86_64.tar.xz</span><br><span class="hljs-attr">mysql_version:</span> <span class="hljs-number">8.0</span><span class="hljs-number">.28</span><br><span class="hljs-attr">mysql_root_password:</span> <span class="hljs-number">123456</span><br>[<span class="hljs-string">root@ansible</span> <span class="hljs-string">data</span>]<span class="hljs-comment"># </span><br><br><span class="hljs-comment"># 调用角色</span><br>[<span class="hljs-string">root@ansible</span> <span class="hljs-string">data</span>]<span class="hljs-comment"># cat web_roles.yml </span><br><span class="hljs-meta">---</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">centos7</span><br>  <span class="hljs-attr">remote_user:</span> <span class="hljs-string">root</span><br>  <span class="hljs-attr">roles:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">mysql8</span><br><br><span class="hljs-comment"># 运行</span><br>[<span class="hljs-string">root@ansible</span> <span class="hljs-string">data</span>]<span class="hljs-comment"># ansible-playbook web_roles.yml</span><br></code></pre></td></tr></table></figure><h4 id="实现Redis角色"><a href="#实现Redis角色" class="headerlink" title="实现Redis角色"></a>实现Redis角色</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># 创建角色目录</span><br>[<span class="hljs-string">root@ansible</span> <span class="hljs-string">data</span>]<span class="hljs-comment"># ansible-galaxy init redis</span><br>[<span class="hljs-string">root@ansible</span> <span class="hljs-string">data</span>]<span class="hljs-comment"># tree redis/</span><br><span class="hljs-string">redis/</span><br><span class="hljs-string">├──</span> <span class="hljs-string">defaults</span><br><span class="hljs-string">│</span>   <span class="hljs-string">└──</span> <span class="hljs-string">main.yml</span><br><span class="hljs-string">├──</span> <span class="hljs-string">files</span><br><span class="hljs-string">├──</span> <span class="hljs-string">handlers</span><br><span class="hljs-string">│</span>   <span class="hljs-string">└──</span> <span class="hljs-string">main.yml</span><br><span class="hljs-string">├──</span> <span class="hljs-string">meta</span><br><span class="hljs-string">│</span>   <span class="hljs-string">└──</span> <span class="hljs-string">main.yml</span><br><span class="hljs-string">├──</span> <span class="hljs-string">README.md</span><br><span class="hljs-string">├──</span> <span class="hljs-string">tasks</span><br><span class="hljs-string">│</span>   <span class="hljs-string">└──</span> <span class="hljs-string">main.yml</span><br><span class="hljs-string">├──</span> <span class="hljs-string">templates</span><br><span class="hljs-string">├──</span> <span class="hljs-string">tests</span><br><span class="hljs-string">│</span>   <span class="hljs-string">├──</span> <span class="hljs-string">inventory</span><br><span class="hljs-string">│</span>   <span class="hljs-string">└──</span> <span class="hljs-string">test.yml</span><br><span class="hljs-string">└──</span> <span class="hljs-string">vars</span><br>    <span class="hljs-string">└──</span> <span class="hljs-string">main.yml</span><br>    <br><span class="hljs-comment"># 创建tasks文件</span><br>[<span class="hljs-string">root@ansible</span> <span class="hljs-string">data</span>]<span class="hljs-comment"># cat redis/tasks/main.yml </span><br><span class="hljs-meta">---</span><br><span class="hljs-comment"># tasks file for redis</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Installed</span> <span class="hljs-string">Redis</span> <span class="hljs-string">Server</span><br>  <span class="hljs-attr">yum:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">redis</span><br>    <span class="hljs-attr">state:</span> <span class="hljs-string">present</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Configure</span> <span class="hljs-string">Redis</span> <span class="hljs-string">Server</span><br>  <span class="hljs-attr">template:</span><br>    <span class="hljs-attr">src:</span> <span class="hljs-string">redis.conf.j2</span><br>    <span class="hljs-attr">dest:</span> <span class="hljs-string">/etc/redis.conf</span><br>    <span class="hljs-attr">owner:</span> <span class="hljs-string">redis</span><br>    <span class="hljs-attr">group:</span> <span class="hljs-string">root</span><br>    <span class="hljs-attr">mode:</span> <span class="hljs-string">&#x27;0640&#x27;</span><br>  <span class="hljs-attr">notify:</span> <span class="hljs-string">Restart</span> <span class="hljs-string">Redis</span> <span class="hljs-string">Server</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Start</span> <span class="hljs-string">Redis</span> <span class="hljs-string">Server</span><br>  <span class="hljs-attr">systemd:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">redis</span><br>    <span class="hljs-attr">state:</span> <span class="hljs-string">started</span><br>    <span class="hljs-attr">enabled:</span> <span class="hljs-literal">yes</span><br>[<span class="hljs-string">root@ansible</span> <span class="hljs-string">data</span>]<span class="hljs-comment"># </span><br><br><span class="hljs-comment"># 创建handlers文件</span><br>[<span class="hljs-string">root@ansible</span> <span class="hljs-string">data</span>]<span class="hljs-comment"># cat redis/handlers/main.yml </span><br><span class="hljs-meta">---</span><br><span class="hljs-comment"># handlers file for redis</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Restart</span> <span class="hljs-string">Redis</span> <span class="hljs-string">Server</span><br>  <span class="hljs-attr">systemd:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">redis</span><br>    <span class="hljs-attr">state:</span> <span class="hljs-string">restarted</span><br>[<span class="hljs-string">root@ansible</span> <span class="hljs-string">data</span>]<span class="hljs-comment"># </span><br><span class="hljs-comment"># 在/data/redis/templates目录下准备如下文件</span><br>[<span class="hljs-string">root@ansible</span> <span class="hljs-string">data</span>]<span class="hljs-comment"># ll redis/templates/</span><br><span class="hljs-string">total</span> <span class="hljs-number">48</span><br><span class="hljs-string">-rw-r-----</span> <span class="hljs-number">1</span> <span class="hljs-string">root</span> <span class="hljs-string">root</span> <span class="hljs-number">46729</span> <span class="hljs-string">Mar</span>  <span class="hljs-number">2</span> <span class="hljs-number">02</span><span class="hljs-string">:51</span> <span class="hljs-string">redis.conf.j2</span><br>[<span class="hljs-string">root@ansible</span> <span class="hljs-string">data</span>]<span class="hljs-comment">#</span><br><br><span class="hljs-comment"># 调用角色</span><br><span class="hljs-comment"># 调用角色</span><br>[<span class="hljs-string">root@ansible</span> <span class="hljs-string">data</span>]<span class="hljs-comment"># cat web_roles.yml </span><br><span class="hljs-meta">---</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">centos7</span><br>  <span class="hljs-attr">remote_user:</span> <span class="hljs-string">root</span><br>  <span class="hljs-attr">roles:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">redis</span><br><br><span class="hljs-comment"># 运行</span><br>[<span class="hljs-string">root@ansible</span> <span class="hljs-string">data</span>]<span class="hljs-comment"># ansible-playbook web_roles.yml</span><br></code></pre></td></tr></table></figure><h2 id="Ansible推荐学习资料"><a href="#Ansible推荐学习资料" class="headerlink" title="Ansible推荐学习资料"></a>Ansible推荐学习资料</h2><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs text">http://galaxy.ansible.com<br>https://galaxy.ansible.com/explore#/<br>http://github.com/<br>http://ansible.com.cn/<br>https://github.com/ansible/ansible<br>https://github.com/ansible/ansible-examples<br></code></pre></td></tr></table></figure></div><hr><div><div class="post-metas my-3"><div class="post-meta mr-3 d-flex align-items-center"><i class="iconfont icon-category"></i> <span class="category-chains"><span class="category-chain"><a href="/categories/Ansible/" class="category-chain-item">Ansible</a></span></span></div></div><div class="license-box my-3"><div class="license-title"><div>运维自动化工具Ansible(二)</div><div>https://itshare.work/2023/02/25/Ansible2/</div></div><div class="license-meta"><div class="license-meta-item"><div>作者</div><div>yuankun</div></div><div class="license-meta-item license-meta-date"><div>发布于</div><div>2023年2月25日</div></div><div class="license-meta-item license-meta-date"><div>更新于</div><div>2023年3月3日</div></div><div class="license-meta-item"><div>许可协议</div><div><a target="_blank" href="https://creativecommons.org/licenses/by/4.0/"><span class="hint--top hint--rounded" aria-label="BY - 署名"><i class="iconfont icon-by"></i></span></a></div></div></div><div class="license-icon iconfont"></div></div><div class="post-prevnext my-3"><article class="post-prev col-6"><a href="/2023/03/02/Zabbix/" title="Zabbix介绍和部署"><i class="iconfont icon-arrowleft"></i> <span class="hidden-mobile">Zabbix介绍和部署</span> <span class="visible-mobile">上一篇</span></a></article><article class="post-next col-6"><a href="/2023/02/21/Ansible/" title="运维自动化工具Ansible(一)"><span class="hidden-mobile">运维自动化工具Ansible(一)</span> <span class="visible-mobile">下一篇</span> <i class="iconfont icon-arrowright"></i></a></article></div></div><article id="comments" lazyload><div id="valine"></div><script type="text/javascript">Fluid.utils.loadComments("#valine",(function(){Fluid.utils.createScript("https://lib.baomitu.com/valine/1.5.1/Valine.min.js",(function(){var i=Object.assign({appId:"hQDROocUhxVs3CipuQjO33sY-gzGzoHsz",appKey:"CHcmi9bz6KRRaChFJVSY14g1",path:"window.location.pathname",placeholder:"请在这里书写你想说的话······",avatar:"retro",meta:["nick","mail","link"],requiredFields:[],pageSize:10,lang:"zh-CN",highlight:!1,recordIP:!1,serverURLs:"",emojiCDN:null,emojiMaps:null,enableQQ:!1},{el:"#valine",path:window.location.pathname});new Valine(i),Fluid.utils.waitElementVisible("#valine .vcontent",()=>{var i="#valine .vcontent img:not(.vemoji)";Fluid.plugins.imageCaption(i),Fluid.plugins.fancyBox(i)})}))}))</script><noscript>Please enable JavaScript to view the comments</noscript></article></article></div></div></div><div class="side-col d-none d-lg-block col-lg-2"><aside class="sidebar" style="margin-left:-1rem"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p><div class="toc-body" id="toc-body"></div></div></aside></div></div></div><a id="scroll-top-button" aria-label="TOP" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">搜索</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">关键词</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div></main><footer><div class="footer-inner"><div class="footer-content"><span>由<a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a>强力驱动</span> <i class="iconfont icon-love"></i> <span>主题</span> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> <i class="iconfont icon-love"></i> <span>©2022 - 2023</span></div><div class="statistics"><span id="leancloud-site-pv-container" style="display:none">总访问量 <span id="leancloud-site-pv"></span> 次 </span><span id="leancloud-site-uv-container" style="display:none">总访问客数 <span id="leancloud-site-uv"></span> 人</span></div><div class="beian"><span><a href="http://beian.miit.gov.cn/" target="_blank" rel="nofollow noopener">黔ICP备2022006994号-2 </a></span><span><a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=http://beian.miit.gov.cn/" rel="nofollow noopener" class="beian-police" target="_blank"><span style="visibility:hidden;width:0">|</span> <img src="/img/police_beian.png" srcset="/img/loading.gif" lazyload alt="police-icon"> <span>黔公网安备2022006994号</span></a></span></div></div></footer><script src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js"></script><link rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css"><script>NProgress.configure({showSpinner:!1,trickleSpeed:100}),NProgress.start(),window.addEventListener("load",(function(){NProgress.done()}))</script><script src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js"></script><script src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js"></script><script src="/js/events.js"></script><script src="/js/plugins.js"></script><script src="/js/img-lazyload.js"></script><script>Fluid.utils.createScript("https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js",(function(){var t=jQuery("#toc");if(0!==t.length&&window.tocbot){var i=jQuery("#board-ctn").offset().top;window.tocbot.init(Object.assign({tocSelector:"#toc-body",contentSelector:".markdown-body",linkClass:"tocbot-link",activeLinkClass:"tocbot-active-link",listClass:"tocbot-list",isCollapsedClass:"tocbot-is-collapsed",collapsibleClass:"tocbot-is-collapsible",scrollSmooth:!0,includeTitleTags:!0,headingsOffset:-i},CONFIG.toc)),t.find(".toc-list-item").length>0&&t.css("visibility","visible"),Fluid.events.registerRefreshCallback((function(){if("tocbot"in window){tocbot.refresh();var t=jQuery("#toc");if(0===t.length||!tocbot)return;t.find(".toc-list-item").length>0&&t.css("visibility","visible")}}))}}))</script><script src="https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js"></script><script>Fluid.plugins.codeWidget()</script><script>Fluid.utils.createScript("https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js",(function(){window.anchors.options={placement:CONFIG.anchorjs.placement,visible:CONFIG.anchorjs.visible},CONFIG.anchorjs.icon&&(window.anchors.options.icon=CONFIG.anchorjs.icon);var n=(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","),o=[];for(var s of n)o.push(".markdown-body > "+s.trim());"left"===CONFIG.anchorjs.placement&&(window.anchors.options.class="anchorjs-link-left"),window.anchors.add(o.join(", ")),Fluid.events.registerRefreshCallback((function(){if("anchors"in window){anchors.removeAll();var n=(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","),o=[];for(var s of n)o.push(".markdown-body > "+s.trim());"left"===CONFIG.anchorjs.placement&&(anchors.options.class="anchorjs-link-left"),anchors.add(o.join(", "))}}))}))</script><script>Fluid.utils.createScript("https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js",(function(){Fluid.plugins.fancyBox()}))</script><script>Fluid.plugins.imageCaption()</script><script defer src="/js/leancloud.js"></script><script src="/js/local-search.js"></script><script src="/js/caidai.js"></script><script src="/js/love.main.js"></script><script src="/js/boot.js"></script><noscript><div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div></noscript></body></html>