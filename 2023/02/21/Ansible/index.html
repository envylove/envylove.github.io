<!DOCTYPE html><html lang="zh-CN" data-default-color-scheme="auto"><head><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.ico"><link rel="icon" href="/img/favicon.ico"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="theme-color" content="#2f4154"><meta name="author" content="yuankun"><meta name="keywords" content="hexo,theme,fluid,linux,ops,运维,分享"><meta name="description" content="Ansible 的名称来自科幻小说《安德的游戏》中跨越时空的即时通信工具，使用它可以在相距数光年的距离,远程实时控制前线的舰队战斗"><meta property="og:type" content="article"><meta property="og:title" content="运维自动化工具Ansible(一)"><meta property="og:url" content="https://itshare.work/2023/02/21/Ansible/index.html"><meta property="og:site_name" content="Dream"><meta property="og:description" content="Ansible 的名称来自科幻小说《安德的游戏》中跨越时空的即时通信工具，使用它可以在相距数光年的距离,远程实时控制前线的舰队战斗"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://itshare.work/banner_img/default.png"><meta property="article:published_time" content="2023-02-21T11:12:21.000Z"><meta property="article:modified_time" content="2023-02-27T10:14:06.890Z"><meta property="article:author" content="yuankun"><meta property="article:tag" content="hexo,theme,fluid,linux,ops,运维,分享"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image" content="https://itshare.work/banner_img/default.png"><title>运维自动化工具Ansible(一) - Dream</title><link rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css"><link rel="stylesheet" href="/css/main.css"><link id="highlight-css" rel="stylesheet" href="/css/highlight.css"><link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css"><link rel="stylesheet" href="/css/tbdzj.css"><script id="fluid-configs">var Fluid=window.Fluid||{};Fluid.ctx=Object.assign({},Fluid.ctx);var CONFIG={hostname:"itshare.work",root:"/",version:"1.9.3",typing:{enable:!1,typeSpeed:70,cursorChar:" ",loop:!0,scope:[]},anchorjs:{enable:!0,element:"h1,h2,h3,h4,h5,h6",placement:"left",visible:"hover",icon:""},progressbar:{enable:!0,height_px:3,color:"#29d",options:{showSpinner:!1,trickleSpeed:100}},code_language:{enable:!0,default:"text"},copy_btn:!0,image_caption:{enable:!0},image_zoom:{enable:!0,img_url_replace:["",""]},toc:{enable:!0,placement:"right",headingSelector:"h1,h2,h3,h4,h5,h6",collapseDepth:0},lazyload:{enable:!0,loading_img:"/img/loading.gif",onlypost:!1,offset_factor:2},web_analytics:{enable:!0,follow_dnt:!0,baidu:null,google:null,gtag:null,tencent:{sid:null,cid:null},woyaola:null,cnzz:null,leancloud:{app_id:"hQDROocUhxVs3CipuQjO33sY-gzGzoHsz",app_key:"CHcmi9bz6KRRaChFJVSY14g1",server_url:"https://hqdroocu.lc-cn-n1-shared.com",path:"window.location.pathname",ignore_local:!0}},search_path:"/local-search.xml"};if(CONFIG.web_analytics.follow_dnt){var dntVal=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack;Fluid.ctx.dnt=dntVal&&(dntVal.startsWith("1")||dntVal.startsWith("yes")||dntVal.startsWith("on"))}</script><script src="/js/utils.js"></script><script src="/js/color-schema.js"></script><meta name="generator" content="Hexo 6.3.0"></head><body><header><div class="header-inner" style="height:70vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/"><strong>Dream</strong> </a><button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/"><i class="iconfont icon-home-fill"></i> 首页</a></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" target="_self" href="javascript:;" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><i class="iconfont icon-books"></i> 文章</a><div class="dropdown-menu" aria-labelledby="navbarDropdown"><a class="dropdown-item" href="/archives/"><i class="iconfont icon-archive-fill"></i> 归档 </a><a class="dropdown-item" href="/categories/"><i class="iconfont icon-category-fill"></i> 分类 </a><a class="dropdown-item" href="/tags/"><i class="iconfont icon-tags-fill"></i> 标签</a></div></li><li class="nav-item"><a class="nav-link" href="/about/"><i class="iconfont icon-user-fill"></i> 关于</a></li><li class="nav-item"><a class="nav-link" href="/links/"><i class="iconfont icon-link-fill"></i> 友链</a></li><li class="nav-item" id="search-btn"><a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">&nbsp;<i class="iconfont icon-search"></i>&nbsp;</a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a></li></ul></div></div></nav><div id="banner" class="banner" parallax="true" style="background:url(/img/default.png) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="banner-text text-center fade-in-up"><div class="h2"><span id="subtitle">运维自动化工具Ansible(一)</span></div><div class="mt-3"><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2023-02-21 19:12" pubdate>2023年2月21日 晚上</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 50k 字 </span><span class="post-meta mr-2"><i class="iconfont icon-clock-fill"></i> 418 分钟 </span><span id="leancloud-page-views-container" class="post-meta" style="display:none"><i class="iconfont icon-eye" aria-hidden="true"></i> <span id="leancloud-page-views"></span> 次</span></div></div></div></div></div></div></header><main><div class="container-fluid nopadding-x"><div class="row nomargin-x"><div class="side-col d-none d-lg-block col-lg-2"></div><div class="col-lg-8 nopadding-x-md"><div class="container nopadding-x-md" id="board-ctn"><div id="board"><article class="post-content mx-auto"><h1 style="display:none">运维自动化工具Ansible(一)</h1><div class="markdown-body"><h1 id="Ansible介绍和架构"><a href="#Ansible介绍和架构" class="headerlink" title="Ansible介绍和架构"></a>Ansible介绍和架构</h1><h2 id="Ansible发展史"><a href="#Ansible发展史" class="headerlink" title="Ansible发展史"></a>Ansible发展史</h2><p>Ansible 的名称来自科幻小说《安德的游戏》中跨越时空的即时通信工具，使用它可以在相距数光年的距离，远程实时控制前线的舰队战斗<br>2012-03-09，发布0.0.1版，2015-10-17，Red Hat宣布1.5亿美元收购<br>官网：<a target="_blank" rel="noopener" href="https://www.ansible.com/">https://www.ansible.com/</a><br>官方文档：<a target="_blank" rel="noopener" href="https://docs.ansible.com/">https://docs.ansible.com/</a></p><h2 id="Ansible-功能"><a href="#Ansible-功能" class="headerlink" title="Ansible 功能"></a>Ansible 功能</h2><ul><li>批量执行远程命令,可以对远程的多台主机同时进行命令的执行</li><li>批量安装和配置软件服务，可以对远程的多台主机进行自动化的方式配置和管理各种服务</li><li>编排高级的企业级复杂的IT架构任务, Ansible的Playbook和role可以轻松实现大型的IT复杂架构</li><li>提供自动化运维工具的开发API, 有很多运维工具,如jumpserver就是基于 ansible 实现自动化管工功能</li></ul><h2 id="Ansible-特点"><a href="#Ansible-特点" class="headerlink" title="Ansible 特点"></a>Ansible 特点</h2><p><strong>优点</strong></p><ul><li>功能丰富的模块：提供了多达数千个的各种功能的模块,完成特定任务只需调用特定模块即可，还</li><li>支持自定义模块，可使用任何编程语言写模块</li><li>使用和部署简单: 无需安装专用代理软件,基于python和SSH(默认已安装)实现</li><li>安全: 基于OpenSSH实现安全通讯无需专用协议</li><li>幂等性：一个任务执行1遍和执行n遍效果一样，不因重复执行带来意外情况,此特性和模块有关</li><li>支持playbook编排任务，YAML格式，编排任务，支持丰富的数据结构</li><li>较强大的多层解决方案 Role</li><li>Python语言实现, 基于Paramiko（python对ssh的实现），PyYAML，Jinja2（模板语言）三个关键模块</li><li>属于红帽(IBM)公司产品,背景强大,未来发展前景光明</li></ul><p><strong>缺点</strong></p><ul><li>如果管理的主机较多时,执行效率不如saltstack高</li><li>当前还不支持像MySQL数据库一样的事务回滚</li></ul><h2 id="Ansible-架构"><a href="#Ansible-架构" class="headerlink" title="Ansible 架构"></a>Ansible 架构</h2><h3 id="Ansible-组成"><a href="#Ansible-组成" class="headerlink" title="Ansible 组成"></a>Ansible 组成</h3><p>组合INVENTORY、API、MODULES、PLUGINS的绿框，为ansible命令工具，其为核心执行工具</p><p><img src="/../image.assets/1676984392121.png" srcset="/img/loading.gif" lazyload alt="1676984392121"></p><ul><li>INVENTORY：Ansible管理主机的清单文件,默认为 &#x2F;etc&#x2F;ansible&#x2F;hosts</li><li>MODULES：Ansible执行命令的功能模块，多数为内置核心模块，也可自定义</li><li>PLUGINS：模块功能的补充，如连接类型插件、循环插件、变量插件、过滤插件等，该功能不常用</li><li>API：供第三方程序调用的应用程序编程接口</li></ul><h3 id="Ansible-命令执行来源"><a href="#Ansible-命令执行来源" class="headerlink" title="Ansible 命令执行来源"></a>Ansible 命令执行来源</h3><ul><li>USER 普通用户，即SYSTEM ADMINISTRATOR</li><li>PLAYBOOKS：任务剧本（任务集），编排定义Ansible任务集的配置文件，由Ansible顺序依次执行，通常是JSON格式的YML文件</li><li>CMDB（配置管理数据库） API 调用</li><li>PUBLIC&#x2F;PRIVATE CLOUD API调用</li><li>USER-&gt; Ansible Playbook -&gt; Ansibile</li></ul><h3 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h3><ul><li>执行ansible的主机一般称为管理端, 主控端，中控，master或堡垒机</li><li>主控端Python版本需要2.6或以上</li><li>被控端Python版本小于2.4，需要安装python-simplejson</li><li>被控端如开启SELinux需要安装libselinux-python</li><li>windows 不能做为主控端,只能做为被控制端</li></ul><h1 id="Ansible-安装和常见模块"><a href="#Ansible-安装和常见模块" class="headerlink" title="Ansible 安装和常见模块"></a>Ansible 安装和常见模块</h1><h2 id="Ansible-安装"><a href="#Ansible-安装" class="headerlink" title="Ansible 安装"></a>Ansible 安装</h2><p>ansible的安装方法有多种<br>官方文档</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs text">https://docs.ansible.com/ansible/latest/installation_guide/intro_installation.html<br>https://docs.ansible.com/ansible/latest/installation_guide/index.html<br></code></pre></td></tr></table></figure><p>下载</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs text">https://releases.ansible.com/ansible/<br></code></pre></td></tr></table></figure><p>pip 下载</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs text">https://pypi.org/project/ansible/<br></code></pre></td></tr></table></figure><h3 id="包安装方式"><a href="#包安装方式" class="headerlink" title="包安装方式"></a>包安装方式</h3><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs text">#CentOS 的EPEL源的rpm包安装<br>[root@centos ~]#yum install ansible<br>#ubuntu 安装<br>[root@ubuntu ~]#apt -y install ansible<br></code></pre></td></tr></table></figure><h3 id="pip安装"><a href="#pip安装" class="headerlink" title="pip安装"></a>pip安装</h3><p>pip 是安装Python包的管理器，类似 yum<br>范例: 在rocky8上通过pip3安装ansible</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs text">[root@rocky8 ~]#yum -y install python39 rust<br>[root@rocky8 ~]#pip3 install ansible<br>[root@rocky8 ~]#ansible --version<br>ansible [core 2.12.6]<br>config file = None<br>configured module search path = [&#x27;/root/.ansible/plugins/modules&#x27;,<br>&#x27;/usr/share/ansible/plugins/modules&#x27;]<br>ansible python module location = /usr/lib/python3.9/site-packages/ansible<br>ansible collection location =<br>/root/.ansible/collections:/usr/share/ansible/collections<br>executable location = /usr/bin/ansible<br>python version = 3.9.6 (default, Nov 9 2021, 13:31:27) [GCC 8.5.0 20210514<br>(Red Hat 8.5.0-3)]<br>jinja version = 3.1.2<br>libyaml = True<br>[root@rocky8 ~]#ansible-doc -l 2&gt; /dev/null|wc -l<br>6763<br></code></pre></td></tr></table></figure><p>范例: 安装python3.8 支持ansible2.12以上版本</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs text">[root@rocky8 ~]#yum -y install python38 python38-pip<br>[root@rocky8 ~]#pip3 install --upgrade pip -i https://pypi.douban.com/simple<br>[root@rocky8 ~]#pip3 install ansible -i https://pypi.douban.com/simple/<br>[root@rocky8 ~]#ansible --version<br>ansible [core 2.12.6]<br>config file = None<br>configured module search path = [&#x27;/root/.ansible/plugins/modules&#x27;,<br>&#x27;/usr/share/ansible/plugins/modules&#x27;]<br>ansible python module location = /usr/local/lib/python3.8/site-<br>packages/ansible<br>ansible collection location =<br>/root/.ansible/collections:/usr/share/ansible/collections<br>executable location = /usr/local/bin/ansible<br>python version = 3.8.8 (default, Nov 9 2021, 13:31:34) [GCC 8.5.0 20210514<br>(Red Hat 8.5.0-3)]<br>jinja version = 3.1.2<br>libyaml = True<br></code></pre></td></tr></table></figure><p>范例: 安装默认的python3.6版本会有警报提示</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs text">[root@rocky8 ~]#yum -y install python3<br>[root@rocky8 ~]#pip3 install --upgrade pip -i https://pypi.douban.com/simple<br>[root@rocky8 ~]#pip3 install ansible -i https://pypi.douban.com/simple/<br>[root@rocky8 ~]#ansible --version<br>[DEPRECATION WARNING]: Ansible will require Python 3.8 or newer on the<br>controller starting with Ansible 2.12. Current version: 3.6.8 (default, Nov<br>9 2021, 14:44:26) [GCC 8.5.0 20210514 (Red Hat 8.5.0-3)]. This feature will be<br>removed from ansible-core in version 2.12. Deprecation warnings<br>can be disabled by setting deprecation_warnings=False in ansible.cfg.<br>/usr/local/lib/python3.6/site-packages/ansible/parsing/vault/__init__.py:44:<br>CryptographyDeprecationWarning: Python 3.6 is no longer supported by the Python<br>core team. Therefore, support for it is deprecated in cryptography and will be<br>removed in a future release.<br>from cryptography.exceptions import InvalidSignature<br>ansible [core 2.11.12]<br>config file = None<br>configured module search path = [&#x27;/root/.ansible/plugins/modules&#x27;,<br>&#x27;/usr/share/ansible/plugins/modules&#x27;]<br>ansible python module location = /usr/local/lib/python3.6/site-<br>packages/ansible<br>ansible collection location =<br>/root/.ansible/collections:/usr/share/ansible/collections<br>executable location = /usr/local/bin/ansible<br>python version = 3.6.8 (default, Nov 9 2021, 14:44:26) [GCC 8.5.0 20210514<br>(Red Hat 8.5.0-3)]<br>jinja version = 3.0.3<br>libyaml = True<br>[root@rocky8 ~]#ansible-doc -l 2&gt; /dev/null|wc -l<br>6141<br></code></pre></td></tr></table></figure><p><img src="/../image.assets/1676985923345.png" srcset="/img/loading.gif" lazyload alt="1676985923345"></p><p>范例</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs text">[root@centos7 ~]#yum -y install python-pip<br>[root@centos7 ~]#pip install --upgrade pip<br>[root@centos7 ~]#pip install ansible --upgrade<br>[root@centos7 ~]#ansible --version<br>/usr/lib64/python2.7/site-packages/cryptography/__init__.py:39:<br>CryptographyDeprecationWarning: Python 2 is no longer supported by the Python<br>core team. Support for it is now deprecated in cryptography, and will be removed<br>in a future release.<br>CryptographyDeprecationWarning,<br>ansible 2.9.12<br>config file = None<br>configured module search path = [u&#x27;/root/.ansible/plugins/modules&#x27;,<br>u&#x27;/usr/share/ansible/plugins/modules&#x27;]<br>ansible python module location = /usr/lib/python2.7/site-packages/ansible<br>executable location = /usr/bin/ansible<br>python version = 2.7.5 (default, Apr 2 2020, 13:16:51) [GCC 4.8.5 20150623<br>(Red Hat 4.8.5-39)]<br>[root@centos7 ~]#ll /opt/etc/ansible/ansible.cfg<br>-rw-r--r-- 1 wang bin 19980 Aug 11 21:34 /opt/etc/ansible/ansible.cfg<br></code></pre></td></tr></table></figure><h3 id="确认安装"><a href="#确认安装" class="headerlink" title="确认安装"></a>确认安装</h3><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs text">[root@ansible ~]#ansible --version<br>ansible 2.9.5<br>config file = /etc/ansible/ansible.cfg<br>configured module search path = [&#x27;/root/.ansible/plugins/modules&#x27;,<br>&#x27;/usr/share/ansible/plugins/modules&#x27;]<br>ansible python module location = /usr/lib/python3.6/site-packages/ansible<br>executable location = /usr/bin/ansible<br>python version = 3.6.8 (default, Nov 21 2019, 19:31:34) [GCC 8.3.1 20190507<br>(Red Hat 8.3.1-4)]<br></code></pre></td></tr></table></figure><h2 id="Ansible-相关文件"><a href="#Ansible-相关文件" class="headerlink" title="Ansible 相关文件"></a>Ansible 相关文件</h2><h3 id="Ansible-配置文件列表"><a href="#Ansible-配置文件列表" class="headerlink" title="Ansible 配置文件列表"></a>Ansible 配置文件列表</h3><ul><li>&#x2F;etc&#x2F;ansible&#x2F;ansible.cfg 主配置文件，配置ansible工作特性,也可以在项目的目录中创建此文件,当前目录下如果也有ansible.cfg,则此文件优先生效,建议每个项目目录下,创建独有的ansible.cfg文<br>件</li><li>&#x2F;etc&#x2F;ansible&#x2F;hosts 主机清单</li><li>&#x2F;etc&#x2F;ansible&#x2F;roles&#x2F; 存放角色的目录</li></ul><h3 id="Ansible-主配置文件"><a href="#Ansible-主配置文件" class="headerlink" title="Ansible 主配置文件"></a>Ansible 主配置文件</h3><p>Ansible 的配置文件可以放在多个不同地方,优先级从高到低顺序如下</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs text">ANSIBLE_CONFIG #环境变量,目录下的文件必须存在才能生效<br>./ansible.cfg #当前目录下的ansible.cfg,一般一个项目对应一个专用配置文件,推荐使用<br>~/.ansible.cfg #当前用户家目录下的.ansible.cfg<br>/etc/ansible/ansible.cfg #系统默认配置文件<br></code></pre></td></tr></table></figure><p>Ansible 的默认配置文件 &#x2F;etc&#x2F;ansible&#x2F;ansible.cfg ,其中大部分的配置内容无需进行修改</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs text">[defaults]<br>#inventory = /etc/ansible/hosts #主机列表配置文件<br>#library = /usr/share/my_modules/ #库文件存放目录<br>#remote_tmp = $HOME/.ansible/tmp #临时py命令文件存放在远程主机目录<br>#local_tmp = $HOME/.ansible/tmp #本机的临时命令执行目录<br>#forks = 5 #默认并发数<br>#sudo_user = root #默认sudo 用户<br>#ask_sudo_pass = True #每次执行ansible命令是否询问ssh密码<br>#ask_pass = True<br>#remote_port = 22<br>#host_key_checking = False #检查对应服务器的host_key，建议取消此行注释,实现第一次连<br>接自动信任目标主机<br>#log_path=/var/log/ansible.log #日志文件，建议启用<br>#module_name = command #默认模块，可以修改为shell模块<br>[privilege_escalation] #普通用户提权配置<br>#become=True<br>#become_method=sudo<br>#become_user=root<br>#become_ask_pass=False<br></code></pre></td></tr></table></figure><p>范例: 通过环境变量ANSIBLE_CONFIG指定ansible配置文件路径</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs text">[root@rocky8 ~]#cd /data/ansible/<br>[root@rocky8 ansible]#cat ansbile.cfg<br>[defaults]<br>inventory = ./hosts<br>[root@rocky8 ansible]#cat hosts<br>[ubuntu]<br>10.0.0.100<br>[centos]<br>10.0.0.7<br>10.0.0.8<br>#定义变量<br>[root@rocky8 ansible]#export ANSIBLE_CONFIG=./ansbile.cfg<br>[root@rocky8 ansible]#ansible --version<br>ansible [core 2.12.6]<br>config file = /data/ansible/ansbile.cfg<br>configured module search path = [&#x27;/root/.ansible/plugins/modules&#x27;,<br>&#x27;/usr/share/ansible/plugins/modules&#x27;]<br>ansible python module location = /usr/lib/python3.9/site-packages/ansible<br>ansible collection location =<br>/root/.ansible/collections:/usr/share/ansible/collections<br>executable location = /usr/bin/ansible<br><br>python version = 3.9.6 (default, Nov 9 2021, 13:31:27) [GCC 8.5.0 20210514<br>(Red Hat 8.5.0-3)]<br>jinja version = 3.1.2<br>libyaml = True<br>[root@rocky8 ansible]#ansible --list-hosts all<br>hosts (3):<br>10.0.0.100<br>10.0.0.7<br>10.0.0.8<br></code></pre></td></tr></table></figure><p>范例: 创建ansible 指定项目专用的配置文件</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs text">[root@ubuntu2004 ~]#ansible --version<br>ansible 2.9.6<br>config file = /etc/ansible/ansible.cfg<br>configured module search path = [&#x27;/root/.ansible/plugins/modules&#x27;,<br>&#x27;/usr/share/ansible/plugins/modules&#x27;]<br>ansible python module location = /usr/lib/python3/dist-packages/ansible<br>executable location = /usr/bin/ansible<br>python version = 3.8.10 (default, Mar 15 2022, 12:22:08) [GCC 9.4.0]<br>[root@ubuntu2004 ~]#mkdir /data/ansible -p<br>[root@ubuntu2004 ~]#cd /data/ansible/<br>[root@ubuntu2004 ansible]#touch ansible.cfg<br>[root@ubuntu2004 ansible]#ansible --version<br>ansible 2.9.6<br>config file = /data/ansible/ansible.cfg<br>configured module search path = [&#x27;/root/.ansible/plugins/modules&#x27;,<br>&#x27;/usr/share/ansible/plugins/modules&#x27;]<br>ansible python module location = /usr/lib/python3/dist-packages/ansible<br>executable location = /usr/bin/ansible<br>python version = 3.8.10 (default, Mar 15 2022, 12:22:08) [GCC 9.4.0]<br>[root@ubuntu2004 ansible]#cd<br>[root@ubuntu2004 ~]#ansible --version<br>ansible 2.9.6<br>config file = /etc/ansible/ansible.cfg<br>configured module search path = [&#x27;/root/.ansible/plugins/modules&#x27;,<br>&#x27;/usr/share/ansible/plugins/modules&#x27;]<br>ansible python module location = /usr/lib/python3/dist-packages/ansible<br>executable location = /usr/bin/ansible<br>python version = 3.8.10 (default, Mar 15 2022, 12:22:08) [GCC 9.4.0]<br></code></pre></td></tr></table></figure><p>范例: 当前目录下的ansible的配置文件优先生效</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs text">[root@ansible ~]#ansible --version<br>ansible 2.9.17<br>config file = /etc/ansible/ansible.cfg<br>configured module search path = [&#x27;/root/.ansible/plugins/modules&#x27;,<br>&#x27;/usr/share/ansible/plugins/modules&#x27;]<br>ansible python module location = /usr/lib/python3.6/site-packages/ansible<br>executable location = /usr/bin/ansible<br>python version = 3.6.8 (default, Apr 16 2020, 01:36:27) [GCC 8.3.1 20191121<br>(Red Hat 8.3.1-5)]<br>[root@ansible ~]#cp /etc/ansible/ansible.cfg .<br><br>[root@ansible ~]#ansible --version<br>ansible 2.9.17<br>config file = /root/ansible.cfg #注意配置文件路径<br>configured module search path = [&#x27;/root/.ansible/plugins/modules&#x27;,<br>&#x27;/usr/share/ansible/plugins/modules&#x27;]<br>ansible python module location = /usr/lib/python3.6/site-packages/ansible<br>executable location = /usr/bin/ansible<br>python version = 3.6.8 (default, Apr 16 2020, 01:36:27) [GCC 8.3.1 20191121<br>(Red Hat 8.3.1-5)]<br>[root@ansible ~]#<br></code></pre></td></tr></table></figure><h3 id="Inventory-主机清单文件"><a href="#Inventory-主机清单文件" class="headerlink" title="Inventory 主机清单文件"></a>Inventory 主机清单文件</h3><p>ansible的主要功用在于批量主机操作，为了便捷地使用其中的部分主机，可以在inventory 主机清单文件中将其分组组织<br>默认的inventory file为 &#x2F;etc&#x2F;ansible&#x2F;hosts<br>inventory file可以有多个，且也可以通过Dynamic Inventory来动态生成<br>注意:</p><ul><li>生产建议在每个项目目录下创建项目独立的hosts文件</li><li>通过项目目录下的ansible.cfg文件中的 inventory &#x3D; .&#x2F;hosts实现</li></ul><p>官方文档:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs url">https://docs.ansible.com/ansible/latest/user_guide/intro_inventory.html<br></code></pre></td></tr></table></figure><p><strong>主机清单文件格式</strong><br>inventory文件遵循INI文件风格，中括号中的字符为组名。可以将同一个主机同时归并到多个不同的组中,此外，当如若目标主机使用了非默认的SSH端口，还可以在主机名称之后使用冒号加端口号来标明,如果主机名称遵循相似的命名模式，还可以使用列表的方式标识各主机<br><strong>Inventory 参数说明</strong></p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs text">ansible_ssh_host #将要连接的远程主机名.与你想要设定的主机的别名不同的话,可通过此变量设置.<br>ansible_ssh_port #ssh端口号.如果不是默认的端口号,通过此变量设置.这种可以使用 ip:端口<br>192.168.1.100:2222<br>ansible_ssh_user #默认的 ssh 用户名<br>ansible_ssh_pass #ssh 密码(这种方式并不安全,我们强烈建议使用 --ask-pass 或 SSH 密钥)<br>ansible_sudo_pass #sudo 密码(这种方式并不安全,我们强烈建议使用 --ask-sudo-pass)<br>ansible_sudo_exe (new in version 1.8) #sudo 命令路径(适用于1.8及以上版本)<br>ansible_connection #与主机的连接类型.比如:local, ssh 或者 paramiko. Ansible 1.2 以前默认使用 paramiko.1.2 以后默认使用 &#x27;smart&#x27;,&#x27;smart&#x27; 方式会根据是否支持 ControlPersist,来判断&#x27;ssh&#x27; 方式是否可行.<br>ansible_ssh_private_key_file #ssh 使用的私钥文件.适用于有多个密钥,而你不想使用 SSH 代理的情况.<br>ansible_shell_type #目标系统的shell类型.默认情况下,命令的执行使用 &#x27;sh&#x27; 语法,可设置为&#x27;csh&#x27; 或 &#x27;fish&#x27;.<br>ansible_python_interpreter #目标主机的 python 路径.适用于的情况: 系统中有多个 Python,或者命令路径不是&quot;/usr/bin/python&quot;,比如 \*BSD, 或者 /usr/bin/python 不是 2.X 版本的Python.之所以不使用 &quot;/usr/bin/env&quot; 机制,因为这要求远程用户的路径设置正确,且要求 &quot;python&quot;可执行程序名不可为 python以外的名字(实际有可能名为python26).与ansible_python_interpreter 的工作方式相同,可设定如 ruby 或 perl 的路径....<br></code></pre></td></tr></table></figure><p>范例：</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs text">ntp.wang.org<br>[webservers]<br>www1.wang.org:2222<br>www2.wang.org<br>[dbservers]<br>db1.wang.org<br>db2.wang.org<br>db3.wang.org<br>#或者<br>db[1:3].wang.org<br></code></pre></td></tr></table></figure><p>范例: 组嵌套</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs text">[webservers]<br>www[1:100].example.com<br>[dbservers]<br>db-[a:f].example.com<br>[appservers]<br>10.0.0.[1:100]<br>#定义testsrvs组中包括两个其它分组,实现组嵌套<br>[testsrvs:children]<br>webservers<br>dbservers<br></code></pre></td></tr></table></figure><p>范例: 基于用户名和密码的ssh连接主机清单</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs text">[test]<br>10.0.0.8 ansible_connection=local #指定本地连接,无需ssh配置<br><br>#每个主机分别指定用户和密码,ansible_connection=ssh 需要StrictHostKeyChecking no 或者host_key_checking = False<br>10.0.0.7 ansible_connection=ssh ansible_ssh_port=2222 ansible_ssh_user=wangansible_ssh_password=123456<br>10.0.0.6 ansible_ssh_user=root ansible_ssh_password=123456<br>#对每个分组的所有主机统一定义用户和密码,执行ansible命令时显示别名,如web01<br>[websrvs]<br>web01 ansible_ssh_host=10.0.0.101<br>web02 ansible_ssh_host=10.0.0.102<br>[websrvs:vars]<br>ansible_ssh_password=magedu<br>some_host ansible_ssh_port=2222 ansible_ssh_user=manager<br>aws_host ansible_ssh_private_key_file=/home/example/.ssh/aws.pem<br>freebsd_host ansible_python_interpreter=/usr/local/bin/python<br>ruby_module_host ansible_ruby_interpreter=/usr/bin/ruby.1.9.3<br></code></pre></td></tr></table></figure><h2 id="Ansible相关工具"><a href="#Ansible相关工具" class="headerlink" title="Ansible相关工具"></a>Ansible相关工具</h2><ul><li><p>&#x2F;usr&#x2F;bin&#x2F;ansible 主程序，临时命令执行工具</p></li><li><p>&#x2F;usr&#x2F;bin&#x2F;ansible-doc 查看配置文档，模块功能查看工具,相当于man</p></li><li><p>&#x2F;usr&#x2F;bin&#x2F;ansible-playbook 定制自动化任务，编排剧本工具,相当于脚本</p></li><li><p>&#x2F;usr&#x2F;bin&#x2F;ansible-pull 远程执行命令的工具</p></li><li><p>&#x2F;usr&#x2F;bin&#x2F;ansible-vault 文件加密工具</p></li><li><p>&#x2F;usr&#x2F;bin&#x2F;ansible-console 基于Console界面与用户交互的执行工具</p></li><li><p>&#x2F;usr&#x2F;bin&#x2F;ansible-galaxy 下载&#x2F;上传优秀代码或Roles模块的官网平台</p></li></ul><p><strong>利用ansible实现管理的主要方式：</strong></p><ul><li><p>Ansible Ad-Hoc 即利用ansible命令，主要用于临时命令使用场景</p></li><li><p>Ansible playbook 主要用于长期规划好的，大型项目的场景，需要有前期的规划过程</p></li></ul><p><strong>ansible 使用前准备</strong><br>ansible 相关工具大多数是通过ssh协议，实现对远程主机的配置管理、应用部署、任务执行等功能<br>建议：使用此工具前，先配置ansible主控端能基于密钥认证的方式联系各个被管理节点<br>范例：利用sshpass批量实现基于key验证脚本1</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs text">[root@centos8 ~]#vim /etc/ssh/ssh_config<br>#修改下面一行<br>StrictHostKeyChecking no<br>[root@centos8 ~]#cat hosts.list<br>192.168.32.178<br>192.168.32.179<br>[root@centos8 ~]#vim push_ssh_key.sh<br>#!/bin/bash<br>rpm -ql shpass &amp;&gt; /dev/null || yum -y install sshpass<br>[ -f /root/.ssh/id_rsa ] || ssh-keygen -f /root/.ssh/id_rsa -P &#x27;&#x27;<br>export SSHPASS=123456<br>while read IP;do<br>	sshpass -e ssh-copy-id -o StrictHostKeyChecking=no $IP<br><br><br>done &lt; hosts.list<br></code></pre></td></tr></table></figure><p>范例: 实现基于key验证的脚本2</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs text">[root@centos8 ~]#cat ssh_key.sh<br><br>#!/bin/bash<br>PLIST=&quot;<br>192.168.32.178<br>192.168.32.179&quot;<br>rpm -q sshpass &amp;&gt; /dev/null || yum -y install sshpass<br>[ -f /root/.ssh/id_rsa ] || ssh-keygen -f /root/.ssh/id_rsa -P &#x27;&#x27;<br>export SSHPASS=123456<br>for IP in $IPLIST;do<br>       &#123; sshpass -e ssh-copy-id -o StrictHostKeyChecking=no $IP; &#125; &amp;<br><br>done<br>wait<br></code></pre></td></tr></table></figure><h3 id="ansible-doc"><a href="#ansible-doc" class="headerlink" title="ansible-doc"></a>ansible-doc</h3><p>此工具用来显示模块帮助,相当于man<br>格式</p><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli">ansible-doc [options] [module.<span class="hljs-string">..</span>]<br>-l, <span class="hljs-params">--list</span> <span class="hljs-comment">#列出可用模块</span><br>-s, <span class="hljs-params">--snippet</span> <span class="hljs-comment">#显示指定模块的playbook片段</span><br></code></pre></td></tr></table></figure><p>范例: 查看帮助</p><figure class="highlight inform7"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs inform7"><span class="hljs-comment">[root@rocky ~]</span># ansible-doc --help<br>usage: ansible-doc <span class="hljs-comment">[-h]</span> <span class="hljs-comment">[--version]</span> <span class="hljs-comment">[-v]</span> <span class="hljs-comment">[-M MODULE_PATH]</span> <span class="hljs-comment">[--playbook-dir BASEDIR]</span><br>                   <span class="hljs-comment">[-t &#123;become,cache,callback,cliconf,connection,httpapi,inventory,lookup,netconf,shell,vars,module,strategy,role,keyword&#125;]</span><br>                   <span class="hljs-comment">[-j]</span> <span class="hljs-comment">[-r ROLES_PATH]</span> <span class="hljs-comment">[-e ENTRY_POINT | -s | -F | -l | --metadata-dump]</span> <span class="hljs-comment">[--no-fail-on-errors]</span><br>                   <span class="hljs-comment">[plugin ...]</span><br><br>plugin documentation tool<br><br>positional arguments:<br>  plugin                Plugin<br><br></code></pre></td></tr></table></figure><p>范例：</p><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs autoit"><span class="hljs-meta">#列出所有模块</span><br>ansible-doc -l<br><span class="hljs-meta">#查看指定模块帮助用法</span><br>ansible-doc <span class="hljs-built_in">ping</span><br><span class="hljs-meta">#查看指定模块帮助用法</span><br>ansible-doc -s <span class="hljs-built_in">ping</span><br></code></pre></td></tr></table></figure><p>范例: 查看指定的插件</p><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs applescript">[root@rocky ~]<span class="hljs-comment"># ansible-doc -t connection -l</span><br><span class="hljs-keyword">local</span>        execute <span class="hljs-keyword">on</span> controller                                                                                                 <br>paramiko_ssh Run tasks via python ssh (paramiko)                                                                                   <br>psrp         Run tasks <span class="hljs-keyword">over</span> Microsoft PowerShell Remoting Protocol                                                                 <br>ssh          connect via SSH client binary                                                                                         <br>winrm        Run tasks <span class="hljs-keyword">over</span> Microsoft&#x27;s WinRM                                                                                      <br>[root@rocky ~]<span class="hljs-comment"># </span><br>[root@rocky ~]<span class="hljs-comment"># ansible-doc -t lookup -l</span><br>config              Lookup current Ansible configuration values                                                                    <br>csvfile             <span class="hljs-built_in">read</span> data <span class="hljs-keyword">from</span> a TSV <span class="hljs-keyword">or</span> CSV <span class="hljs-built_in">file</span>                                                                               <br>dict                returns key/value pair items <span class="hljs-keyword">from</span> dictionaries                                                                 <br>env                 Read <span class="hljs-keyword">the</span> value <span class="hljs-keyword">of</span> environment variables                                                                        <br><span class="hljs-built_in">file</span>                <span class="hljs-built_in">read</span> <span class="hljs-built_in">file</span> <span class="hljs-built_in">contents</span>                                                                                             <br>fileglob            <span class="hljs-built_in">list</span> files matching a pattern                                                                                  <br>first_found         <span class="hljs-literal">return</span> <span class="hljs-keyword">first</span> <span class="hljs-built_in">file</span> found <span class="hljs-keyword">from</span> <span class="hljs-built_in">list</span>                                                                              <br>indexed_items       rewrites lists <span class="hljs-keyword">to</span> <span class="hljs-literal">return</span> &#x27;indexed items&#x27;                                                                       <br>ini                 <span class="hljs-built_in">read</span> data <span class="hljs-keyword">from</span> an ini <span class="hljs-built_in">file</span>                                                                                     <br>inventory_hostnames <span class="hljs-built_in">list</span> <span class="hljs-keyword">of</span> inventory hosts matching a host pattern                                                                <br>items               <span class="hljs-built_in">list</span> <span class="hljs-keyword">of</span> items                                                                                                  <br>lines               <span class="hljs-built_in">read</span> lines <span class="hljs-keyword">from</span> command                                                                                        <br><span class="hljs-built_in">list</span>                simply returns what <span class="hljs-keyword">it</span> <span class="hljs-keyword">is</span> <span class="hljs-keyword">given</span>                                                                                <br>nested              composes a <span class="hljs-built_in">list</span> <span class="hljs-keyword">with</span> nested elements <span class="hljs-keyword">of</span> other lists                                                            <br>password            retrieve <span class="hljs-keyword">or</span> generate a random password, stored <span class="hljs-keyword">in</span> a <span class="hljs-built_in">file</span>                                                       <br>pipe                <span class="hljs-built_in">read</span> output <span class="hljs-keyword">from</span> a command                                                                                     <br>random_choice       <span class="hljs-literal">return</span> random element <span class="hljs-keyword">from</span> <span class="hljs-built_in">list</span>                                                                                <br>sequence            generate a <span class="hljs-built_in">list</span> based <span class="hljs-keyword">on</span> a <span class="hljs-built_in">number</span> sequence                                                                     <br>subelements         traverse nested key <span class="hljs-keyword">from</span> a <span class="hljs-built_in">list</span> <span class="hljs-keyword">of</span> dictionaries                                                                <br>template            retrieve <span class="hljs-built_in">contents</span> <span class="hljs-keyword">of</span> <span class="hljs-built_in">file</span> <span class="hljs-keyword">after</span> templating <span class="hljs-keyword">with</span> Jinja2                                                         <br>together            merges lists <span class="hljs-keyword">into</span> synchronized <span class="hljs-built_in">list</span>                                                                            <br>unvault             <span class="hljs-built_in">read</span> vaulted <span class="hljs-built_in">file</span>(s) <span class="hljs-built_in">contents</span>                                                                                  <br>url                 <span class="hljs-literal">return</span> <span class="hljs-built_in">contents</span> <span class="hljs-keyword">from</span> URL                                                                                       <br>varnames            Lookup matching variable names                                                                                 <br>vars                Lookup templated value <span class="hljs-keyword">of</span> variables                                                                            <br>[root@rocky ~]<span class="hljs-comment"># </span><br><br></code></pre></td></tr></table></figure><h3 id="ansible"><a href="#ansible" class="headerlink" title="ansible"></a>ansible</h3><h4 id="Ansible-Ad-Hoc-介绍"><a href="#Ansible-Ad-Hoc-介绍" class="headerlink" title="Ansible Ad-Hoc 介绍"></a>Ansible Ad-Hoc 介绍</h4><p>Ansible Ad-Hoc 的执行方式的主要工具就是 ansible<br>特点: 一次性的执行,不会保存执行命令信息,只适合临时性或测试性的任务</p><h4 id="ansible-命令用法"><a href="#ansible-命令用法" class="headerlink" title="ansible 命令用法"></a>ansible 命令用法</h4><p>格式：</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs css">ansible &lt;host-pattern&gt; <span class="hljs-selector-attr">[-m module_name]</span> <span class="hljs-selector-attr">[-a args]</span><br></code></pre></td></tr></table></figure><p>选项说明：</p><figure class="highlight ldif"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs ldif"><span class="hljs-literal">-</span>-version <span class="hljs-comment">#显示版本</span><br><span class="hljs-literal">-</span>m module <span class="hljs-comment">#指定模块，默认为command</span><br><span class="hljs-literal">-</span>v <span class="hljs-comment">#详细过程 -vv -vvv更详细</span><br><span class="hljs-literal">-</span>-list-hosts <span class="hljs-comment">#显示主机列表，可简写 --list</span><br><span class="hljs-literal">-</span>C, --check <span class="hljs-comment">#检查，并不执行</span><br><span class="hljs-literal">-</span>T, --timeout=TIMEOUT <span class="hljs-comment">#执行命令的超时时间，默认10s</span><br><span class="hljs-literal">-</span>k, --ask-pass <span class="hljs-comment">#提示输入ssh连接密码，默认Key验证</span><br><span class="hljs-literal">-</span>u, --user=REMOTE_USER <span class="hljs-comment">#执行远程执行的用户,默认root</span><br><span class="hljs-literal">-</span>b, --become <span class="hljs-comment">#代替旧版的sudo实现通过sudo机制实现提升权限</span><br><span class="hljs-literal">-</span>-become-user=USERNAME <span class="hljs-comment">#指定sudo的runas用户，默认为root</span><br><span class="hljs-literal">-</span>K, --ask-become-pass <span class="hljs-comment">#提示输入sudo时的口令</span><br><span class="hljs-literal">-</span>f FORKS, --forks FORKS <span class="hljs-comment">#指定并发同时执行ansible任务的主机数</span><br><span class="hljs-literal">-</span>i INVENTORY, --inventory INVENTORY <span class="hljs-comment">#指定主机清单文件</span><br></code></pre></td></tr></table></figure><p>范例:</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-comment">#以wang用户执行ping存活检测</span><br>ansible all -m<span class="hljs-built_in"> ping </span>-u wang -k<br><span class="hljs-comment">#以wang sudo至root执行ping存活检测</span><br>ansible all -m<span class="hljs-built_in"> ping </span>-u wang -k -b<br><span class="hljs-comment">#以wang sudo至mage用户执行ping存活检测</span><br>ansible all -m<span class="hljs-built_in"> ping </span>-u wang -k -b <span class="hljs-attribute">--become-user</span>=mage<br><span class="hljs-comment">#以wang sudo至root用户执行ls</span><br>ansible all -m command -u wang -a <span class="hljs-string">&#x27;ls /root&#x27;</span> -b <span class="hljs-attribute">--become-user</span>=root -k -K<br></code></pre></td></tr></table></figure><p>范例: 并发执行控制</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs stylus">#分别执行下面两条命令观察结果<br><span class="hljs-selector-attr">[root@ansible ~]</span><span class="hljs-selector-id">#ansible</span> <span class="hljs-attribute">all</span> -a <span class="hljs-string">&#x27;sleep 5&#x27;</span> -f1<br><span class="hljs-selector-attr">[root@ansible ~]</span><span class="hljs-selector-id">#ansible</span> <span class="hljs-attribute">all</span> -a <span class="hljs-string">&#x27;sleep 5&#x27;</span> -f10<br></code></pre></td></tr></table></figure><p>范例: 使用普能用户进行远程管理</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs ruby"><span class="hljs-comment">#在所有控制端和被控制端创建用户和密码</span><br>[root<span class="hljs-variable">@rocky8</span> ~]<span class="hljs-comment">#useradd wang</span><br>[root<span class="hljs-variable">@rocky8</span> ~]<span class="hljs-comment">#echo wang:123456 | chpasswd</span><br><span class="hljs-comment">#在所有被控制端对用户sudo授权</span><br>[root<span class="hljs-variable">@rocky8</span> ~]<span class="hljs-comment">#visudo</span><br>wang <span class="hljs-variable constant_">ALL</span>=(<span class="hljs-variable constant_">ALL</span>) <span class="hljs-variable constant_">NOPASSWD</span>: <span class="hljs-variable constant_">ALL</span><br>[root<span class="hljs-variable">@rocky8</span> ~]<span class="hljs-comment">#visudo -c</span><br>/etc/<span class="hljs-symbol">sudoers:</span> parsed <span class="hljs-variable constant_">OK</span><br><span class="hljs-comment">#实现从控制端到被控制端的基于key验证</span><br>[root<span class="hljs-variable">@ansible</span> ~]<span class="hljs-comment">#su - wang</span><br>wang<span class="hljs-variable">@ansible</span><span class="hljs-symbol">:~</span><span class="hljs-variable">$ssh</span>-keygen -f ~<span class="hljs-regexp">/.ssh/id</span>_rsa -P <span class="hljs-string">&#x27;&#x27;</span><br>wang<span class="hljs-variable">@ansible</span><span class="hljs-symbol">:~</span><span class="hljs-variable">$$</span>ssh-copy-id wang@<span class="hljs-string">&#x27;10.0.0.8&#x27;</span><br><span class="hljs-comment">#使用普通用户测试连接,默认连接权限不足失败</span><br>wang<span class="hljs-variable">@ansible</span><span class="hljs-symbol">:~</span><span class="hljs-variable">$ </span>ansible <span class="hljs-number">10.0</span>.<span class="hljs-number">0.8</span> -m shell -a <span class="hljs-string">&#x27;ls /root&#x27;</span><br><span class="hljs-number">10.0</span>.<span class="hljs-number">0.8</span> |<span class="hljs-params"> FAILED </span>| rc=<span class="hljs-number">2</span> &gt;&gt;<br><span class="hljs-symbol">ls:</span> cannot open directory <span class="hljs-string">&#x27;/root&#x27;</span>: Permission deniednon-zero <span class="hljs-keyword">return</span> code<br><span class="hljs-comment">#使用普通用户通过-b选项连接实现sudo提权后连接成功</span><br>wang<span class="hljs-variable">@ansible</span><span class="hljs-symbol">:~</span><span class="hljs-variable">$ </span>ansible <span class="hljs-number">10.0</span>.<span class="hljs-number">0.8</span> -m shell -a <span class="hljs-string">&#x27;ls /root&#x27;</span> -b --become-user root<br><span class="hljs-number">10.0</span>.<span class="hljs-number">0.8</span> |<span class="hljs-params"> CHANGED </span>| rc=<span class="hljs-number">0</span> &gt;&gt;<br>anaconda-ks.cfg<br><span class="hljs-comment">#修改配置文件指定sudo机制</span><br>[root<span class="hljs-variable">@ansible</span> ~]<span class="hljs-comment">#vim /etc/ansible/ansible.cfg</span><br><span class="hljs-comment">#取消下面行前面的注释</span><br>[privilege_escalation]<br>become=True<br>become_method=sudo<br>become_user=root<br>become_ask_pass=False<br><span class="hljs-comment">#再次测试</span><br>[root<span class="hljs-variable">@ansible</span> ~]<span class="hljs-comment">#su - wang</span><br>wang<span class="hljs-variable">@ansible</span><span class="hljs-symbol">:~</span><span class="hljs-variable">$ </span>ansible <span class="hljs-number">10.0</span>.<span class="hljs-number">0.8</span> -m shell -a <span class="hljs-string">&#x27;ls /root&#x27;</span><br><span class="hljs-number">10.0</span>.<span class="hljs-number">0.8</span> |<span class="hljs-params"> CHANGED </span>| rc=<span class="hljs-number">0</span> &gt;&gt;<br>anaconda-ks.cfg<br></code></pre></td></tr></table></figure><p>范例: 使用普通用户连接远程主机执行代替另一个用户身份执行操作</p><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs gherkin">[root<span class="hljs-meta">@centos8</span> ~]<span class="hljs-comment">#useradd wang</span><br>[root<span class="hljs-meta">@centos8</span> ~]<span class="hljs-comment">#echo wang:123456 | chpasswd</span><br><span class="hljs-comment">#先在被控制端能过sudo对普通用户授权</span><br>[root<span class="hljs-meta">@centos8</span> ~]<span class="hljs-comment">#grep wang /etc/sudoers</span><br>wang ALL=(ALL) NOPASSWD: ALL<br><span class="hljs-comment">#以wang的用户连接用户,并利用sudo代表mage执行whoami命令</span><br>[root<span class="hljs-meta">@ansible</span> ~]<span class="hljs-comment">#ansible 10.0.0.8 -m shell -a &#x27;whoami&#x27; -u wang -k -b --become-</span><br>user=mage<br>SSH password: <span class="hljs-comment">#输入远程主机wang用户ssh连接密码</span><br>10.0.0.8 |<span class="hljs-string"> CHANGED </span>|<span class="hljs-string"> rc=0 &gt;&gt;</span><br><span class="hljs-string">mage</span><br></code></pre></td></tr></table></figure><h4 id="ansible的Host-pattern"><a href="#ansible的Host-pattern" class="headerlink" title="ansible的Host-pattern"></a>ansible的Host-pattern</h4><p>用于匹配被控制的主机的列表<br>All ：表示所有Inventory中的所有主机<br>范例</p><figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ada">ansible <span class="hljs-keyword">all</span> -m ping<br></code></pre></td></tr></table></figure><p>*:通配符</p><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs autoit">ansible <span class="hljs-string">&quot;*&quot;</span> -m <span class="hljs-built_in">ping</span><br>ansible <span class="hljs-number">192.168</span><span class="hljs-number">.1</span>.* -m <span class="hljs-built_in">ping</span><br>ansible <span class="hljs-string">&quot;srvs&quot;</span> -m <span class="hljs-built_in">ping</span><br>ansible <span class="hljs-string">&quot;10.0.0.6 10.0.0.7&quot;</span> -m <span class="hljs-built_in">ping</span><br></code></pre></td></tr></table></figure><p>或关系</p><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs autoit">ansible <span class="hljs-string">&quot;websrvs:appsrvs&quot;</span> -m <span class="hljs-built_in">ping</span><br>ansible <span class="hljs-string">&quot;192.168.1.10:192.168.1.20&quot;</span> -m <span class="hljs-built_in">ping</span><br></code></pre></td></tr></table></figure><p>逻辑与</p><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs autoit"><span class="hljs-meta">#在websrvs组并且在dbsrvs组中的主机</span><br>ansible <span class="hljs-string">&quot;websrvs:&amp;dbsrvs&quot;</span> -m <span class="hljs-built_in">ping</span><br></code></pre></td></tr></table></figure><p>逻辑非</p><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs autoit"><span class="hljs-meta">#在所有主机,但不在websrvs组和dbsrvs组中的主机</span><br><span class="hljs-meta">#注意：此处为单引号</span><br>ansible <span class="hljs-string">&#x27;all:!dbsrvs:!websrvs&#x27;</span> -m <span class="hljs-built_in">ping</span><br></code></pre></td></tr></table></figure><p>综合逻辑</p><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs autoit">ansible <span class="hljs-string">&#x27;websrvs:dbsrvs:&amp;appsrvs:!ftpsrvs&#x27;</span> -m <span class="hljs-built_in">ping</span><br></code></pre></td></tr></table></figure><p>正则表达式</p><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs autoit">ansible <span class="hljs-string">&quot;websrvs:dbsrvs&quot;</span> -m <span class="hljs-built_in">ping</span><br>ansible <span class="hljs-string">&quot;~(web|db).*\.magedu\.com&quot;</span> -m <span class="hljs-built_in">ping</span><br></code></pre></td></tr></table></figure><h5 id="ansible-命令的执行过程"><a href="#ansible-命令的执行过程" class="headerlink" title="ansible 命令的执行过程"></a>ansible 命令的执行过程</h5><ol><li>加载自己的配置文件,默认&#x2F;etc&#x2F;ansible&#x2F;ansible.cfg</li><li>查找主机清单中对应的主机或主机组</li><li>加载自己对应的模块文件，如：command</li><li>通过ansible将模块或命令生成对应的临时py文件，并将该文件传输至远程服务器的对应执行用户<br>$HOME&#x2F;.ansible&#x2F;tmp&#x2F;ansible-tmp-数字&#x2F;XXX.PY文件</li><li>给文件+x执行</li><li>执行并返回结果</li><li>删除临时py文件，退出</li></ol><h5 id="ansible-命令的执行状态"><a href="#ansible-命令的执行状态" class="headerlink" title="ansible 命令的执行状态"></a>ansible 命令的执行状态</h5><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-selector-attr">[root@centos8 ~]</span><span class="hljs-selector-id">#grep</span> -A <span class="hljs-number">14</span> <span class="hljs-string">&#x27;\[colors\]&#x27;</span> /etc/ansible/ansible<span class="hljs-selector-class">.cfg</span><br><span class="hljs-selector-attr">[colors]</span><br><span class="hljs-selector-id">#highlight</span> = white<br><span class="hljs-selector-id">#verbose</span> = blue<br><span class="hljs-selector-id">#warn</span> = bright purple<br><span class="hljs-selector-id">#error</span> = red<br><span class="hljs-selector-id">#debug</span> = dark gray<br><span class="hljs-selector-id">#deprecate</span> = purple<br><span class="hljs-selector-id">#skip</span> = cyan<br><span class="hljs-selector-id">#unreachable</span> = red<br><span class="hljs-selector-id">#ok</span> = green<br><span class="hljs-selector-id">#changed</span> = yellow<br><span class="hljs-selector-id">#diff_add</span> = green<br><span class="hljs-selector-id">#diff_remove</span> = red<br><span class="hljs-selector-id">#diff_lines</span> = cyan<br></code></pre></td></tr></table></figure><ul><li>绿色：执行成功并且对目标主机不需要做改变的操作</li><li>黄色：执行成功并且对目标主机做变更</li><li>红色：执行失败</li></ul><h3 id="ansible-console"><a href="#ansible-console" class="headerlink" title="ansible-console"></a>ansible-console</h3><p>此工具可交互执行命令，支持tab，ansible 2.0+新增<br>提示符格式：</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs css">执行用户@当前操作的主机组 (当前组的主机数量)[<span class="hljs-attribute">f</span>:并发数]$<br></code></pre></td></tr></table></figure><p>常用子命令：</p><ul><li>设置并发数： forks n 例如： forks 10</li><li>切换组： cd 主机组 例如： cd web</li><li>列出当前组主机列表： list</li><li>列出所有的内置命令： ?或help</li></ul><p>范例</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs ruby">[root<span class="hljs-variable">@ansible</span> ~]<span class="hljs-comment">#ansible-console</span><br>Welcome to the ansible console.<br>Type help <span class="hljs-keyword">or</span> ? to list commands.<br>root<span class="hljs-variable">@all</span> (<span class="hljs-number">3</span>)[<span class="hljs-symbol">f:</span><span class="hljs-number">5</span>]<span class="hljs-variable">$ </span>ping<br><span class="hljs-meta prompt_">10.0.0.7 | SUCCESS =&gt;</span> &#123;<br><span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br><span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br>&#125;,<br><span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">false</span>,<br><span class="hljs-string">&quot;ping&quot;</span>: <span class="hljs-string">&quot;pong&quot;</span><br>&#125;<br><span class="hljs-meta prompt_">10.0.0.6 | SUCCESS =&gt;</span> &#123;<br><span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br><span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br>&#125;,<br><span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">false</span>,<br><span class="hljs-string">&quot;ping&quot;</span>: <span class="hljs-string">&quot;pong&quot;</span><br>&#125;<br><span class="hljs-meta prompt_">10.0.0.8 | SUCCESS =&gt;</span> &#123;<br><span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br><span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/libexec/platform-python&quot;</span><br>&#125;,<br><span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">false</span>,<br><span class="hljs-string">&quot;ping&quot;</span>: <span class="hljs-string">&quot;pong&quot;</span><br>&#125;<br>root<span class="hljs-variable">@all</span> (<span class="hljs-number">3</span>)[<span class="hljs-symbol">f:</span><span class="hljs-number">5</span>]<span class="hljs-variable">$ </span>list<br><span class="hljs-number">10.0</span>.<span class="hljs-number">0.8</span><br><span class="hljs-number">10.0</span>.<span class="hljs-number">0.7</span><br><span class="hljs-number">10.0</span>.<span class="hljs-number">0.6</span><br>root<span class="hljs-variable">@all</span> (<span class="hljs-number">3</span>)[<span class="hljs-symbol">f:</span><span class="hljs-number">5</span>]<span class="hljs-variable">$ </span>cd websrvs<br>root<span class="hljs-variable">@websrvs</span> (<span class="hljs-number">2</span>)[<span class="hljs-symbol">f:</span><span class="hljs-number">5</span>]<span class="hljs-variable">$ </span>list<br><span class="hljs-number">10.0</span>.<span class="hljs-number">0.7</span><br><span class="hljs-number">10.0</span>.<span class="hljs-number">0.8</span><br>root<span class="hljs-variable">@websrvs</span> (<span class="hljs-number">2</span>)[<span class="hljs-symbol">f:</span><span class="hljs-number">5</span>]<span class="hljs-variable">$ </span>forks <span class="hljs-number">10</span><br>root<span class="hljs-variable">@websrvs</span> (<span class="hljs-number">2</span>)[<span class="hljs-symbol">f:</span><span class="hljs-number">10</span>]<span class="hljs-variable">$ </span>cd appsrvs<br>root<span class="hljs-variable">@appsrvs</span> (<span class="hljs-number">2</span>)[<span class="hljs-symbol">f:</span><span class="hljs-number">5</span>]<span class="hljs-variable">$ </span>yum name=httpd state=present<br>root<span class="hljs-variable">@appsrvs</span> (<span class="hljs-number">2</span>)[<span class="hljs-symbol">f:</span><span class="hljs-number">5</span>]<span class="hljs-variable">$ </span>service name=httpd state=started<br></code></pre></td></tr></table></figure><h3 id="ansible-playbook"><a href="#ansible-playbook" class="headerlink" title="ansible-playbook"></a>ansible-playbook</h3><p>此工具用于执行编写好的 playbook 任务<br>范例：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">ansible-playbook</span> <span class="hljs-string">hello.yml</span><br><span class="hljs-string">cat</span> <span class="hljs-string">hello.yml</span><br><span class="hljs-meta">---</span><br><span class="hljs-comment">#hello world yml file</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span> <span class="hljs-string">websrvs</span><br>  <span class="hljs-attr">remote_user:</span> <span class="hljs-string">root</span><br>  <span class="hljs-attr">gather_facts:</span> <span class="hljs-literal">no</span><br>  <span class="hljs-attr">tasks:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">hello</span> <span class="hljs-string">world</span><br>    <span class="hljs-attr">command:</span> <span class="hljs-string">/usr/bin/wall</span> <span class="hljs-string">hello</span> <span class="hljs-string">world</span><br></code></pre></td></tr></table></figure><h3 id="ansible-vault"><a href="#ansible-vault" class="headerlink" title="ansible-vault"></a>ansible-vault</h3><p>此工具可以用于加密解密yml文件<br>格式：</p><figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs coq">ansible-vault [create|<span class="hljs-type">decrypt</span>|<span class="hljs-type">edit</span>|<span class="hljs-type">encrypt</span>|<span class="hljs-type">rekey</span>|<span class="hljs-type">view</span>]<br></code></pre></td></tr></table></figure><p>范例</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs stylus">ansible-vault encrypt hello<span class="hljs-selector-class">.yml</span> #加密<br>ansible-vault decrypt hello<span class="hljs-selector-class">.yml</span> #解密<br>ansible-vault view hello<span class="hljs-selector-class">.yml</span> #查看<br>ansible-vault edit hello<span class="hljs-selector-class">.yml</span> #编辑加密文件<br>ansible-vault rekey hello<span class="hljs-selector-class">.yml</span> #修改口令<br>ansible-vault create new<span class="hljs-selector-class">.yml</span> #创建新文件<br>#执行加密的playbook,交互式输入密码<br>chmod <span class="hljs-number">600</span> hello<span class="hljs-selector-class">.yml</span><br>ansible-playbook <span class="hljs-attr">--ask-vault-pass</span> hello<span class="hljs-selector-class">.yml</span><br>#从pass.txt文件中读取密码<br>ansible-playbook <span class="hljs-attr">--vault-password-file</span> pass<span class="hljs-selector-class">.txt</span> hello<span class="hljs-selector-class">.yml</span><br>#从配置文件中取得密码<br><span class="hljs-selector-id">#vi</span> /etc/ansible/ansible<span class="hljs-selector-class">.cfg</span><br><span class="hljs-selector-attr">[defaults]</span><br>ault-password-file=pass<span class="hljs-selector-class">.txt</span><br>#可以直接执行加密文件<br>ansible-playbook hello.yml<br></code></pre></td></tr></table></figure><h3 id="ansible-galaxy"><a href="#ansible-galaxy" class="headerlink" title="ansible-galaxy"></a>ansible-galaxy</h3><p>Galaxy 是一个免费网站, 类似于github网站, 网站上发布了很多的共享的roles角色。<br>Ansible 提供了ansible-galaxy命令行工具连接 <a target="_blank" rel="noopener" href="https://galaxy.ansible.com/">https://galaxy.ansible.com</a> 网站下载相应的roles, 进行init(初始化、search( 查拘、install(安装、 remove(移除)等操作。</p><p><img src="/../image.assets/1677156776774.png" srcset="/img/loading.gif" lazyload alt="1677156776774"></p><p>范例：</p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs cmake"><span class="hljs-comment">#搜索项目</span><br>[root@ansible ~]<span class="hljs-comment">#ansible-galaxy search lamp</span><br><span class="hljs-comment">#列出所有已安装的galaxy</span><br>ansible-galaxy <span class="hljs-keyword">list</span><br><span class="hljs-comment">#安装galaxy,默认下载到~/.ansible/roles下</span><br>ansible-galaxy <span class="hljs-keyword">install</span> geerlingguy.mysql<br>ansible-galaxy <span class="hljs-keyword">install</span> geerlingguy.redis<br><span class="hljs-comment">#删除galaxy</span><br>ansible-galaxy <span class="hljs-keyword">remove</span> geerlingguy.redis<br></code></pre></td></tr></table></figure><h2 id="Ansible常用模块"><a href="#Ansible常用模块" class="headerlink" title="Ansible常用模块"></a>Ansible常用模块</h2><p>2015年12月只270多个模块<br>2016年12年26日ansible 1.9.2 有540个模块<br>2018年01月12日ansible 2.3.8 有1378个模块<br>2018年05月28日ansible 2.5.3 有1562个模块<br>2018年07月15日ansible 2.6.3 有1852个模块<br>2018年11月19日ansible 2.7.2 有2080个模块<br>2020年03月02日ansible 2.9.5 有3387个模块<br>2021年12月22日ansible 2.11.8 有6141个模块<br>2022年06月04日ansible 2.12.6 有6763个模块<br>虽然模块众多，但最常用的模块也就2，30个而已，针对特定业务只需要熟悉10几个模块即可<br>常用模块帮助文档参考：</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs awk">https:<span class="hljs-regexp">//</span>docs.ansible.com<span class="hljs-regexp">/ansible/</span><span class="hljs-number">2.9</span><span class="hljs-regexp">/modules/m</span>odules_by_category.html<br>https:<span class="hljs-regexp">//</span>docs.ansible.com<span class="hljs-regexp">/ansible/</span><span class="hljs-number">2.9</span><span class="hljs-regexp">/modules/</span>list_of_all_modules.html<br>https:<span class="hljs-regexp">//</span>docs.ansible.com<span class="hljs-regexp">/ansible/</span>latest<span class="hljs-regexp">/modules/</span>list_of_all_modules.html<br>https:<span class="hljs-regexp">//</span>docs.ansible.com<span class="hljs-regexp">/ansible/</span>latest<span class="hljs-regexp">/modules/m</span>odules_by_category.html<br></code></pre></td></tr></table></figure><h3 id="Command-模块"><a href="#Command-模块" class="headerlink" title="Command 模块"></a>Command 模块</h3><p>功能：在远程主机执行命令，此为默认模块，可忽略 -m 选项<br>注意：此命令不支持 $VARNAME &lt; &gt; | ; &amp; 等，可用shell模块实现<br>注意：此模块不具有幂等性<br>常见选项</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">chdir</span>=dir <span class="hljs-comment">#执行命令前,先切换至目录dir</span><br><span class="hljs-attr">creates</span>=file <span class="hljs-comment">#当file不存在时才会执行</span><br><span class="hljs-attr">removes</span>=file <span class="hljs-comment">#当file存在时才会执行</span><br></code></pre></td></tr></table></figure><p>范例：</p><figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs accesslog"><span class="hljs-string">[root@ansible ~]</span>#ansible websrvs -m command -a &#x27;chdir=/etc cat centos-release&#x27;<br><span class="hljs-number">10.0.0.7</span> | CHANGED | rc=<span class="hljs-number">0</span> &gt;&gt;<br>CentOS Linux release <span class="hljs-number">7</span>.<span class="hljs-number">7</span>.<span class="hljs-number">1908</span> (Core)<br><span class="hljs-number">10.0.0.8</span> | CHANGED | rc=<span class="hljs-number">0</span> &gt;&gt;<br>CentOS Linux release <span class="hljs-number">8</span>.<span class="hljs-number">1</span>.<span class="hljs-number">1911</span> (Core)<br><span class="hljs-string">[root@ansible ~]</span>#ansible websrvs -m command -a &#x27;chdir=/etc creates=/data/f1.txt cat centos-release&#x27;<br><span class="hljs-number">10.0.0.7</span> | CHANGED | rc=<span class="hljs-number">0</span> &gt;&gt;<br>CentOS Linux release <span class="hljs-number">7</span>.<span class="hljs-number">7</span>.<span class="hljs-number">1908</span> (Core)<br><span class="hljs-number">10.0.0.8</span> | SUCCESS | rc=<span class="hljs-number">0</span> &gt;&gt;<br>skipped, since /data/f1.txt exists<br><span class="hljs-string">[root@ansible ~]</span>#ansible websrvs -m command -a &#x27;chdir=/etc removes=/data/f1.txt cat centos-release&#x27;<br><span class="hljs-number">10.0.0.7</span> | SUCCESS | rc=<span class="hljs-number">0</span> &gt;&gt;<br>skipped, since /data/f1.txt does not exist<br><span class="hljs-number">10.0.0.8</span> | CHANGED | rc=<span class="hljs-number">0</span> &gt;&gt;<br>CentOS Linux release <span class="hljs-number">8</span>.<span class="hljs-number">1</span>.<span class="hljs-number">1911</span> (Core)<br>ansible websrvs -m command -a &#x27;service vsftpd start&#x27;<br>ansible websrvs -m command -a &#x27;echo magedu |passwd --stdin wang&#x27;<br>ansible websrvs -m command -a &#x27;rm -rf /data/&#x27;<br>ansible websrvs -m command -a &#x27;echo hello &gt; /data/hello.log&#x27;<br><br>ansible websrvs -m command -a <span class="hljs-string">&quot;echo $HOSTNAME&quot;</span><br></code></pre></td></tr></table></figure><h3 id="Shell-模块"><a href="#Shell-模块" class="headerlink" title="Shell 模块"></a>Shell 模块</h3><p>功能：和command相似，用shell执行命令,支持各种符号,比如:*,$, &gt; , 相当于增强版的command模块<br>注意：此模块不具有幂等性,建议能不能就用此模块,最好使用专用模块<br>常见选项</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">chdir</span>=dir <span class="hljs-comment">#执行命令前,先切换至目录dir</span><br><span class="hljs-attr">creates</span>=file <span class="hljs-comment">#当file不存在时才会执行</span><br><span class="hljs-attr">removes</span>=file <span class="hljs-comment">#当file存在时才会执行</span><br></code></pre></td></tr></table></figure><p>范例：</p><figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs accesslog"><span class="hljs-string">[root@ansible ~]</span>#ansible websrvs -m shell -a <span class="hljs-string">&quot;echo $HOSTNAME&quot;</span><br><span class="hljs-number">10.0.0.7</span> | CHANGED | rc=<span class="hljs-number">0</span> &gt;&gt;<br>ansible<br><span class="hljs-number">10.0.0.8</span> | CHANGED | rc=<span class="hljs-number">0</span> &gt;&gt;<br>ansible<br><span class="hljs-string">[root@ansible ~]</span>#ansible websrvs -m shell -a &#x27;echo $HOSTNAME&#x27;<br><span class="hljs-number">10.0.0.7</span> | CHANGED | rc=<span class="hljs-number">0</span> &gt;&gt;<br>centos7.wangxiaochun.com<br><span class="hljs-number">10.0.0.8</span> | CHANGED | rc=<span class="hljs-number">0</span> &gt;&gt;<br>centos8.localdomain<br><span class="hljs-string">[root@ansible ~]</span>#ansible websrvs -m shell -a &#x27;echo centos | passwd --stdin wang&#x27;<br><span class="hljs-number">10.0.0.7</span> | CHANGED | rc=<span class="hljs-number">0</span> &gt;&gt;<br>Changing password for user wang.<br>passwd: all authentication tokens updated successfully.<br><span class="hljs-number">10.0.0.8</span> | CHANGED | rc=<span class="hljs-number">0</span> &gt;&gt;<br>Changing password for user wang.<br>passwd: all authentication tokens updated successfully.<br><span class="hljs-string">[root@ansible ~]</span>#ansible websrvs -m shell -a &#x27;ls -l /etc/shadow&#x27;<br><span class="hljs-number">10.0.0.7</span> | CHANGED | rc=<span class="hljs-number">0</span> &gt;&gt;<br>---------- <span class="hljs-number">1</span> root root <span class="hljs-number">889</span> Mar <span class="hljs-number">2</span> <span class="hljs-number">14</span>:<span class="hljs-number">34</span> /etc/shadow<br><span class="hljs-number">10.0.0.8</span> | CHANGED | rc=<span class="hljs-number">0</span> &gt;&gt;<br>---------- <span class="hljs-number">1</span> root root <span class="hljs-number">944</span> Mar <span class="hljs-number">2</span> <span class="hljs-number">14</span>:<span class="hljs-number">34</span> /etc/shadow<br><span class="hljs-string">[root@ansible ~]</span>#ansible websrvs -m shell -a &#x27;echo hello &gt; /data/hello.log&#x27;<br><span class="hljs-number">10.0.0.7</span> | CHANGED | rc=<span class="hljs-number">0</span> &gt;&gt;<br><span class="hljs-number">10.0.0.8</span> | CHANGED | rc=<span class="hljs-number">0</span> &gt;&gt;<br><span class="hljs-string">[root@ansible ~]</span>#ansible websrvs -m shell -a &#x27;cat /data/hello.log&#x27;<br><span class="hljs-number">10.0.0.7</span> | CHANGED | rc=<span class="hljs-number">0</span> &gt;&gt;<br>hello<br><span class="hljs-number">10.0.0.8</span> | CHANGED | rc=<span class="hljs-number">0</span> &gt;&gt;<br>hello<br></code></pre></td></tr></table></figure><p>注意：调用bash执行命令 类似 cat &#x2F;tmp&#x2F;test.md | awk -F’|’ ‘{print $1,$2}’ &amp;&gt; &#x2F;tmp&#x2F;example.txt 这些复杂命令，即使使用shell也可能会失败，解决办法：写到脚本时，copy到远程，执行，再把需要的结果拉回执行命令的机器<br>范例：将shell模块代替command，设为模块</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[root@ansible ~]</span><span class="hljs-comment">#vim /etc/ansible/ansible.cfg</span><br><span class="hljs-comment">#修改下面一行</span><br><span class="hljs-attr">module_name</span> = shell<br></code></pre></td></tr></table></figure><h3 id="Script-模块"><a href="#Script-模块" class="headerlink" title="Script 模块"></a>Script 模块</h3><p>功能：在远程主机上运行ansible服务器上的脚本(无需执行权限)<br>注意：此模块不具有幂等性<br>常见选项</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs makefile">chdir=dir <span class="hljs-comment">#执行命令前,先切换至目录dir</span><br>cmd <span class="hljs-comment">#指定ansible主机的命令</span><br>creates=file <span class="hljs-comment">#当file不存在时才会执行</span><br>removes=file <span class="hljs-comment">#当file存在时才会执行</span><br></code></pre></td></tr></table></figure><p>范例：</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">ansible websrvs -m script -a <span class="hljs-regexp">/data/</span>test.sh<br></code></pre></td></tr></table></figure><h3 id="Copy-模块"><a href="#Copy-模块" class="headerlink" title="Copy 模块"></a>Copy 模块</h3><p>功能：复制ansible服务器主控端或远程的本机的文件到远程主机<br>注意: src&#x3D;file 如果是没指明路径,则为当前目录或当前目录下的files目录下的file文件<br>常见选项</p><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs crmsh">src <span class="hljs-comment">#控制端的源文件路径</span><br>dest <span class="hljs-comment">#被控端的文件路径</span><br>owner <span class="hljs-comment">#属主</span><br><span class="hljs-keyword">group</span> <span class="hljs-title">#属组</span><br><span class="hljs-title">mode</span> <span class="hljs-comment">#权限</span><br>backup <span class="hljs-comment">#是否备份</span><br>validate <span class="hljs-comment">#验证成功才会执行copy</span><br>remote_src <span class="hljs-comment">#no是默认值,表示src文件在ansible主机,yes表示src文件在远程主机</span><br></code></pre></td></tr></table></figure><p>范例:</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs gradle">#如目标存在，默认覆盖，此处指定先备<br>ansible websrvs -m <span class="hljs-keyword">copy</span> -a <span class="hljs-string">&quot;src=/root/test1.sh dest=/tmp/test2.sh owner=wang mode=600 backup=yes&quot;</span><br>#指定内容，直接生成目标文件<br>ansible websrvs -m <span class="hljs-keyword">copy</span> -a <span class="hljs-string">&quot;content=&#x27;wang 123456\nxiao 654321\n&#x27; dest=/etc/rsync.pas owner=root group=root mode=0600&quot;</span><br>#复制<span class="hljs-regexp">/etc目录自身,注意/</span>etc<span class="hljs-regexp">/后面没有/</span><br>ansible websrvs -m <span class="hljs-keyword">copy</span> -a <span class="hljs-string">&quot;src=/etc dest=/backup&quot;</span><br>#复制<span class="hljs-regexp">/etc/</span>下的文件，不包括<span class="hljs-regexp">/etc/</span>目录自身,注意<span class="hljs-regexp">/etc/</span>后面有/<br>ansible websrvs -m <span class="hljs-keyword">copy</span> -a <span class="hljs-string">&quot;src=/etc/ dest=/backup&quot;</span><br>#复制<span class="hljs-regexp">/etc/</span>suders,并校验语法<br>ansible websrvs -m <span class="hljs-keyword">copy</span> -a <span class="hljs-string">&quot;src=/etc/suders dest=/etc/sudoers.edit remote_src=yes validate=/usr/sbin/visudo -csf %s&quot;</span><br></code></pre></td></tr></table></figure><h3 id="Get-url-模块"><a href="#Get-url-模块" class="headerlink" title="Get_url 模块"></a>Get_url 模块</h3><p>功能: 用于将文件从http、https或ftp下载到被管理机节点上<br>常用参数如下：</p><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs crmsh">url <span class="hljs-comment">#下载文件的URL,支持HTTP，HTTPS或FTP协议</span><br>dest <span class="hljs-comment">#下载到目标路径（绝对路径），如果目标是一个目录，就用原文件名，如果目标设置了名称就用目标</span><br>设置的名称<br>owner <span class="hljs-comment">#指定属主</span><br><span class="hljs-keyword">group</span> <span class="hljs-title">#指定属组</span><br><span class="hljs-title">mode</span> <span class="hljs-comment">#指定权限</span><br>force <span class="hljs-comment">#如果yes，dest不是目录，将每次下载文件，如果内容改变替换文件。如果no，则只有在目标不存</span><br>在时才会下载<br>checksum <span class="hljs-comment">#对目标文件在下载后计算摘要，以确保其完整性</span><br><span class="hljs-comment">#示例: checksum=&quot;sha256:D98291AC[...]B6DC7B97&quot;,</span><br><span class="hljs-attr">checksum=</span><span class="hljs-string">&quot;sha256:http://example.com/path/sha256sum.txt&quot;</span><br>url_username <span class="hljs-comment">#用于HTTP基本认证的用户名。 对于允许空密码的站点，此参数可以不使用`url_password&#x27;</span><br>url_password <span class="hljs-comment">#用于HTTP基本认证的密码。 如果未指定`url_username&#x27;参数，则不会使用`url_password&#x27;参数</span><br>validate_certs <span class="hljs-comment">#如果“no”，SSL证书将不会被验证。 适用于自签名证书在私有网站上使用</span><br>timeout <span class="hljs-comment">#URL请求的超时时间,秒为单位</span><br></code></pre></td></tr></table></figure><p>范例: 下载并MD5验证</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-selector-attr">[root@ansible ~]</span><span class="hljs-selector-id">#ansible</span> websrvs -m get_url -<span class="hljs-selector-tag">a</span> <span class="hljs-string">&#x27;url=http://nginx.org/download/nginx-1.18.0.tar.gz dest=/usr/local/src/nginx.tar.gz checksum=&quot;md5:b2d33d24d89b8b1f87ff5d251aa27eb8&quot;&#x27;</span><br></code></pre></td></tr></table></figure><h3 id="Fetch-模块"><a href="#Fetch-模块" class="headerlink" title="Fetch 模块"></a>Fetch 模块</h3><p>功能：从远程主机提取文件至ansible的主控端，copy相反，目前不支持目录<br>常见选项</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">src</span> <span class="hljs-comment">#被控制端的源文件路径,只支持文件</span><br>dest <span class="hljs-comment">#ansible控制端的目录路径</span><br></code></pre></td></tr></table></figure><p>范例：</p><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs haskell"><span class="hljs-title">ansible</span> websrvs -m fetch -a &#x27;src=/root/test.sh dest=/<span class="hljs-class"><span class="hljs-keyword">data</span>/scripts&#x27;</span><br></code></pre></td></tr></table></figure><p>范例：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs sql">[root<span class="hljs-variable">@ansible</span> <span class="hljs-operator">~</span>]#ansible <span class="hljs-keyword">all</span> <span class="hljs-operator">-</span>m <span class="hljs-keyword">fetch</span> <span class="hljs-operator">-</span>a <span class="hljs-string">&#x27;src=/etc/redhat-release</span><br><span class="hljs-string">dest=/data/os&#x27;</span><br>[root<span class="hljs-variable">@ansible</span> <span class="hljs-operator">~</span>]#tree <span class="hljs-operator">/</span>data<span class="hljs-operator">/</span>os<span class="hljs-operator">/</span><br><span class="hljs-operator">/</span>data<span class="hljs-operator">/</span>os<span class="hljs-operator">/</span><br>├── <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.6</span><br>│ └── etc<br>│ └── redhat<span class="hljs-operator">-</span><span class="hljs-keyword">release</span><br>├── <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.7</span><br>│ └── etc<br>│ └── redhat<span class="hljs-operator">-</span><span class="hljs-keyword">release</span><br>└── <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.8</span><br>└── etc<br>└── redhat<span class="hljs-operator">-</span><span class="hljs-keyword">release</span><br><span class="hljs-number">6</span> directories, <span class="hljs-number">3</span> files<br></code></pre></td></tr></table></figure><h3 id="File-模块"><a href="#File-模块" class="headerlink" title="File 模块"></a>File 模块</h3><p>功能：设置文件属性,创建文件,目录和软链接等<br>常见选项</p><figure class="highlight excel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs excel">path #在被控端创建的路径<br>owner #属主<br>group #属组<br><span class="hljs-built_in">mode</span> #权限<br>state #状态<br>=touch #创建文件<br>=directory #创建目录<br>=link #软链接<br>=hard #硬链接<br>recurse #yes表示递归授权<br></code></pre></td></tr></table></figure><p>范例：</p><figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs pf"><span class="hljs-comment">#创建空文件</span><br>ansible <span class="hljs-literal">all</span> -m file -a &#x27;path=/data/test.txt <span class="hljs-keyword">state</span>=touch&#x27;<br>ansible <span class="hljs-literal">all</span> -m file -a &#x27;path=/data/test.txt <span class="hljs-keyword">state</span>=absent&#x27;<br>ansible <span class="hljs-literal">all</span> -m file -a <span class="hljs-string">&quot;path=/root/test.sh owner=wang mode=755&quot;</span><br><span class="hljs-comment">#创建目录</span><br>ansible <span class="hljs-literal">all</span> -m file -a <span class="hljs-string">&quot;path=/data/mysql state=directory owner=mysql group=mysql&quot;</span><br><span class="hljs-comment">#创建软链接</span><br>ansible <span class="hljs-literal">all</span> -m file -a &#x27;src=/data/testfile path|dest|name=/data/testfile-link <span class="hljs-keyword">state</span>=link&#x27;<br><span class="hljs-comment">#创建目录</span><br>ansible <span class="hljs-literal">all</span> -m file -a &#x27;path=/data/testdir <span class="hljs-keyword">state</span>=directory&#x27;<br><span class="hljs-comment">#递归修改目录属性,但不递归至子目录</span><br>ansible <span class="hljs-literal">all</span> -m file -a <span class="hljs-string">&quot;path=/data/mysql state=directory owner=mysql group=mysql&quot;</span><br><span class="hljs-comment">#递归修改目录及子目录的属性</span><br>ansible <span class="hljs-literal">all</span> -m file -a <span class="hljs-string">&quot;path=/data/mysql state=directory owner=mysql group=mysql recurse=yes&quot;</span><br></code></pre></td></tr></table></figure><h3 id="stat-模块"><a href="#stat-模块" class="headerlink" title="stat 模块"></a>stat 模块</h3><p>功能：检查文件或文件系统的状态<br>注意：对于Windows目标，请改用win_stat模块</p><p>常见选项</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">path</span> <span class="hljs-comment">#文件/对象的完整路径（必须）</span><br></code></pre></td></tr></table></figure><p>常用的返回值判断：</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs arduino">exists： 判断是否存在<br>isuid： 调用用户的ID与所有者ID是否匹配<br></code></pre></td></tr></table></figure><p>范例:</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs ruby">[root<span class="hljs-variable">@ansible</span> ~]<span class="hljs-comment">#ansible 127.0.0.1 -m stat -a &#x27;path=/etc/passwd&#x27;</span><br><span class="hljs-meta prompt_">127.0.0.1 | SUCCESS =&gt;</span> &#123;<br><span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">false</span>,<br><span class="hljs-string">&quot;stat&quot;</span>: &#123;<br><span class="hljs-string">&quot;atime&quot;</span>: <span class="hljs-number">1614601466.7493012</span>,<br><span class="hljs-string">&quot;attr_flags&quot;</span>: <span class="hljs-string">&quot;&quot;</span>,<br><span class="hljs-string">&quot;attributes&quot;</span>: [],<br><span class="hljs-string">&quot;block_size&quot;</span>: <span class="hljs-number">4096</span>,<br><span class="hljs-string">&quot;blocks&quot;</span>: <span class="hljs-number">8</span>,<br><span class="hljs-string">&quot;charset&quot;</span>: <span class="hljs-string">&quot;us-ascii&quot;</span>,<br><span class="hljs-string">&quot;checksum&quot;</span>: <span class="hljs-string">&quot;8f7a9a996d24de98bf1eab4a047f8e89e9c708cf&quot;</span>,<br><span class="hljs-string">&quot;ctime&quot;</span>: <span class="hljs-number">1614334259.4498665</span>,<br><span class="hljs-string">&quot;dev&quot;</span>: <span class="hljs-number">2050</span>,<br><span class="hljs-string">&quot;device_type&quot;</span>: <span class="hljs-number">0</span>,<br><span class="hljs-string">&quot;executable&quot;</span>: <span class="hljs-literal">false</span>,<br><span class="hljs-string">&quot;exists&quot;</span>: <span class="hljs-literal">true</span>,<br><span class="hljs-string">&quot;gid&quot;</span>: <span class="hljs-number">0</span>,<br><span class="hljs-string">&quot;gr_name&quot;</span>: <span class="hljs-string">&quot;root&quot;</span>,<br><span class="hljs-string">&quot;inode&quot;</span>: <span class="hljs-number">134691833</span>,<br><span class="hljs-string">&quot;isblk&quot;</span>: <span class="hljs-literal">false</span>,<br><span class="hljs-string">&quot;ischr&quot;</span>: <span class="hljs-literal">false</span>,<br><span class="hljs-string">&quot;isdir&quot;</span>: <span class="hljs-literal">false</span>,<br><span class="hljs-string">&quot;isfifo&quot;</span>: <span class="hljs-literal">false</span>,<br><span class="hljs-string">&quot;isgid&quot;</span>: <span class="hljs-literal">false</span>,<br><span class="hljs-string">&quot;islnk&quot;</span>: <span class="hljs-literal">false</span>,<br><span class="hljs-string">&quot;isreg&quot;</span>: <span class="hljs-literal">true</span>,<br><span class="hljs-string">&quot;issock&quot;</span>: <span class="hljs-literal">false</span>,<br><span class="hljs-string">&quot;isuid&quot;</span>: <span class="hljs-literal">false</span>,<br><span class="hljs-string">&quot;mimetype&quot;</span>: <span class="hljs-string">&quot;text/plain&quot;</span>,<br><span class="hljs-string">&quot;mode&quot;</span>: <span class="hljs-string">&quot;0000&quot;</span>,<br><span class="hljs-string">&quot;mtime&quot;</span>: <span class="hljs-number">1614334259.4498665</span>,<br><span class="hljs-string">&quot;nlink&quot;</span>: <span class="hljs-number">1</span>,<br><span class="hljs-string">&quot;path&quot;</span>: <span class="hljs-string">&quot;/etc/passwd&quot;</span>,<br><span class="hljs-string">&quot;pw_name&quot;</span>: <span class="hljs-string">&quot;root&quot;</span>,<br><span class="hljs-string">&quot;readable&quot;</span>: <span class="hljs-literal">true</span>,<br><span class="hljs-string">&quot;rgrp&quot;</span>: <span class="hljs-literal">false</span>,<br><span class="hljs-string">&quot;roth&quot;</span>: <span class="hljs-literal">false</span>,<br><span class="hljs-string">&quot;rusr&quot;</span>: <span class="hljs-literal">false</span>,<br><span class="hljs-string">&quot;size&quot;</span>: <span class="hljs-number">1030</span>,<br><span class="hljs-string">&quot;uid&quot;</span>: <span class="hljs-number">0</span>,<br><span class="hljs-string">&quot;version&quot;</span>: <span class="hljs-string">&quot;671641160&quot;</span>,<br><span class="hljs-string">&quot;wgrp&quot;</span>: <span class="hljs-literal">false</span>,<br><span class="hljs-string">&quot;woth&quot;</span>: <span class="hljs-literal">false</span>,<br><span class="hljs-string">&quot;writeable&quot;</span>: <span class="hljs-literal">true</span>,<br><span class="hljs-string">&quot;wusr&quot;</span>: <span class="hljs-literal">false</span>,<br><span class="hljs-string">&quot;xgrp&quot;</span>: <span class="hljs-literal">false</span>,<br><span class="hljs-string">&quot;xoth&quot;</span>: <span class="hljs-literal">false</span>,<br><span class="hljs-string">&quot;xusr&quot;</span>: <span class="hljs-literal">false</span><br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>案例：</p><figure class="highlight handlebars"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs handlebars"><span class="language-xml">- name: install | Check if file is already configured.</span><br><span class="language-xml">  stat: path=</span><span class="hljs-template-variable">&#123;&#123; <span class="hljs-name">nginx_file_path</span> &#125;&#125;</span><span class="language-xml"></span><br><span class="language-xml">  connection: local</span><br><span class="language-xml">  register: nginx_file_result</span><br><span class="language-xml">- name: install | Download nginx file</span><br><span class="language-xml">  get_url: url=</span><span class="hljs-template-variable">&#123;&#123; <span class="hljs-name">nginx_file_url</span> &#125;&#125;</span><span class="language-xml"> dest=</span><span class="hljs-template-variable">&#123;&#123; <span class="hljs-name">software_files_path</span> &#125;&#125;</span><span class="language-xml"></span><br><span class="language-xml">  validate_certs=no</span><br><span class="language-xml">  connection: local</span><br><span class="language-xml">  when:，not. nginx_file_result.stat.exists</span><br></code></pre></td></tr></table></figure><p>范例:</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs asciidoc">[root@ansible ansible]#cat stat.yml<br><span class="hljs-bullet">---</span><br><span class="hljs-bullet"></span><span class="hljs-bullet">- </span>hosts: websrvs<br><span class="hljs-code">  tasks:</span><br><span class="hljs-code">  - name: check file</span><br><span class="hljs-code">    stat: path=/data/mysql</span><br><span class="hljs-code">    register: st</span><br><span class="hljs-code">  - name: debug</span><br><span class="hljs-code">    debug:</span><br><span class="hljs-code">      msg: &quot;/data/mysql is not exist&quot;</span><br><span class="hljs-code">    when: not st.stat.exists</span><br>[root@ansible ansible]#ansible-playbook stat.yml<br>PLAY [websrvs]<br>********************************************************************************<br>***************************************<br>TASK [Gathering Facts]<br>********************************************************************************<br>*******************************<br>ok: [10.0.0.7]<br>ok: [10.0.0.8]<br>TASK [check file]<br>********************************************************************************<br>************************************<br>ok: [10.0.0.7]<br>ok: [10.0.0.8]<br>TASK [debug]<br>********************************************************************************<br>*****************************************<br>ok: [10.0.0.7] =&gt; &#123;<br>&quot;msg&quot;: &quot;/data/mysql is not exist&quot;<br>&#125;<br>ok: [10.0.0.8] =&gt; &#123;<br>&quot;msg&quot;: &quot;/data/mysql is not exist&quot;<br>&#125;<br>PLAY RECAP<br>********************************************************************************<br>*******************************************<br>10.0.0.7 : ok=3 changed=0 unreachable=0 failed=0<br>skipped=0 rescued=0 ignored=0<br>10.0.0.8 : ok=3 changed=0 unreachable=0 failed=0<br>skipped=0 rescued=0 ignored=0<br></code></pre></td></tr></table></figure><h3 id="unarchive-模块"><a href="#unarchive-模块" class="headerlink" title="unarchive 模块"></a>unarchive 模块</h3><p>功能：解包解压缩<br>实现有两种用法：</p><ul><li>将ansible主机上的压缩包传到远程主机后解压缩至特定目录，设置remote_src&#x3D;no,此为默认值,可省略</li><li>将远程本主机上或非ansible的其它主机的某个压缩包解压缩到远程主机本机的指定路径下，需要设置remote_src&#x3D;yes</li></ul><p>常见参数：</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs gradle">remote_src #和<span class="hljs-keyword">copy</span>功能一样且选项互斥，yes表示源文件在远程被控主机或其它非ansible的其它主机上，no表示文件在ansible主机上,默认值为no, 此选项代替<span class="hljs-keyword">copy</span>选项<br><span class="hljs-keyword">copy</span> #默认为yes，当<span class="hljs-keyword">copy</span>=yes，拷贝的文件是从ansible主机复制到远程主机上，如果设置为<span class="hljs-keyword">copy</span>=no，会在远程主机上寻找src源文件,此选项已废弃<br>src #源路径，可以是ansible主机上的路径，也可以是远程主机(被管理端或者第三方主机)上的路径，如果是远程主机上的路径，则需要设置remote_src=yes<br>dest #远程主机上的目标路径<br>mode #设置解压缩后的文件权限<br>creates=<span class="hljs-regexp">/path/</span><span class="hljs-keyword">file</span> #当绝对路径<span class="hljs-regexp">/path/</span><span class="hljs-keyword">file</span>不存在时才会执行<br></code></pre></td></tr></table></figure><p>范例：</p><figure class="highlight nsis"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs nsis">ansible <span class="hljs-literal">all</span> -m un<span class="hljs-params">archive</span> -a <span class="hljs-string">&#x27;src=/data/foo.tgz dest=/var/lib/foo owner=wang group=bin&#x27;</span><br><br>ansible <span class="hljs-literal">all</span> -m un<span class="hljs-params">archive</span> -a <span class="hljs-string">&#x27;src=/tmp/foo.zip dest=/data  mode=0777&#x27;</span><br><br>ansible <span class="hljs-literal">all</span> -m un<span class="hljs-params">archive</span> -a <span class="hljs-string">&#x27;src=https://example.com/example.zip dest=/data &#x27;</span><br><br>ansible websrvs -m un<span class="hljs-params">archive</span> -a <span class="hljs-string">&#x27;src=https://releases.ansible.com/ansible/ansible-2.1.6.0-0.1.rc1.tar.gz dest=/data/ owner=root remote_src=yes&#x27;</span><br><br>ansible websrvs -m un<span class="hljs-params">archive</span> -a <span class="hljs-string">&#x27;src=http://nginx.org/download/nginx- 1.18.0.tar.gz dest=/usr/local/src/ remote_src=yes&#x27;</span><span class="hljs-string">&#x27;</span><br></code></pre></td></tr></table></figure><h3 id="Archive-模块"><a href="#Archive-模块" class="headerlink" title="Archive 模块"></a>Archive 模块</h3><p>功能：打包压缩保存在被管理节点</p><p>常见选项</p><figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs gauss">path <span class="hljs-meta">#压缩的文件或目录</span><br>dest <span class="hljs-meta">#压缩后的文件</span><br><span class="hljs-keyword">format</span> <span class="hljs-meta">#压缩格式,支持gz,bz2,xz,tar,zip</span><br></code></pre></td></tr></table></figure><p>范例：</p><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stata">ansible websrvs -<span class="hljs-keyword">m</span> archive -a &#x27;path=/<span class="hljs-keyword">var</span>/<span class="hljs-keyword">log</span>/ dest=/data/<span class="hljs-keyword">log</span>.tar.bz2 <span class="hljs-keyword">format</span>=bz2 owner=wang mode=0600&#x27;<br></code></pre></td></tr></table></figure><h3 id="Hostname-模块"><a href="#Hostname-模块" class="headerlink" title="Hostname 模块"></a>Hostname 模块</h3><p>功能：管理主机名<br>常见选项</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">name</span> <span class="hljs-comment">#修改后的主机名称</span><br></code></pre></td></tr></table></figure><p>范例：</p><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs livecodeserver">ansible node1 -m hostname -<span class="hljs-keyword">a</span> <span class="hljs-string">&quot;name=websrv&quot;</span><br>ansible <span class="hljs-number">10.0</span><span class="hljs-number">.0</span><span class="hljs-number">.18</span> -m hostname -<span class="hljs-keyword">a</span> <span class="hljs-string">&#x27;name=node18.wang.org&#x27;</span><br></code></pre></td></tr></table></figure><h3 id="Cron-模块"><a href="#Cron-模块" class="headerlink" title="Cron 模块"></a>Cron 模块</h3><p>功能：计划任务<br>支持时间：minute，hour，day，month，weekday<br>常见选项</p><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs crmsh">name <span class="hljs-comment">#描述脚本的作用</span><br>minute <span class="hljs-comment">#分钟</span><br>hour <span class="hljs-comment">#小时</span><br>weekday <span class="hljs-comment">#周</span><br><span class="hljs-keyword">user</span> <span class="hljs-title">#任务由哪个用户运行；默认root</span><br>job <span class="hljs-comment">#任务</span><br></code></pre></td></tr></table></figure><p>范例：</p><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli"><span class="hljs-comment">#备份数据库脚本</span><br>[root@centos8 ~]<span class="hljs-comment">#cat /root/mysql_backup.sh</span><br><span class="hljs-comment">#!/bin/bash</span><br>mysqldump -A -F <span class="hljs-params">--single-transaction</span> <span class="hljs-params">--master-data=2</span> -q -uroot |gzip &gt; <span class="hljs-string">/data/mysql_</span>`date +%F_%T`<span class="hljs-string">.sql.gz</span><br><span class="hljs-comment">#创建任务</span><br>ansible 10.0.0.8 -m cron -a &#x27;hour=2 minute=30 weekday=1-5 name=<span class="hljs-string">&quot;backup mysql&quot;</span> job=<span class="hljs-string">/root/mysql_backup.sh</span>&#x27;<br><br>ansible websrvs -m cron -a <span class="hljs-string">&quot;minute=*/5 job=&#x27;/usr/sbin/ntpdate ntp.aliyun.com &amp;&gt;/dev/null&#x27; name=Synctime&quot;</span><br><br><span class="hljs-comment">#禁用计划任务</span><br>ansible websrvs -m cron -a <span class="hljs-string">&quot;minute=*/5 job=&#x27;/usr/sbin/ntpdate 172.20.0.1 &amp;&gt;/dev/null&#x27; name=Synctime disabled=yes&quot;</span><br><br><span class="hljs-comment">#启用计划任务</span><br>ansible websrvs -m cron -a <span class="hljs-string">&quot;minute=*/5 job=&#x27;/usr/sbin/ntpdate 172.20.0.1 &amp;&gt; /dev/null&#x27; name=Synctime disabled=no&quot;</span><br><br><span class="hljs-comment">#删除任务</span><br>ansible websrvs -m cron -a <span class="hljs-string">&quot;name=&#x27;backup mysql&#x27; state=absent&quot;</span><br>ansible websrvs -m cron -a &#x27;state=absent name=Synctime&#x27;<br></code></pre></td></tr></table></figure><h3 id="Yum-和-Apt-模块"><a href="#Yum-和-Apt-模块" class="headerlink" title="Yum 和 Apt 模块"></a>Yum 和 Apt 模块</h3><p>功能：管理软件包<br>yum 管理软件包，只支持RHEL，CentOS，fedora，不支持Ubuntu其它版本<br>apt 模块管理 Debian 相关版本的软件包<br>yum常见选项</p><figure class="highlight excel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs excel">name #软件包名称<br>state #状态<br>=present #安装,此为默认值<br>=absent #删除<br>=latest #最新版<br>list #列出指定包<br>enablerepo #启用哪个仓库安装<br>disablerepo #不使用哪些仓库的包<br>exclude #排除指定的包<br>validate #是否检验,默认为yes<br></code></pre></td></tr></table></figure><p>范例：</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-selector-attr">[root@ansible ~]</span><span class="hljs-selector-id">#ansible</span> websrvs -m yum -<span class="hljs-selector-tag">a</span> <span class="hljs-string">&#x27;name=httpd state=present&#x27;</span><br>#安装zabbix agent rpm包<br><br><span class="hljs-selector-attr">[root@ansible ~]</span><span class="hljs-selector-id">#ansible</span> websrvs -m yum -<span class="hljs-selector-tag">a</span> <span class="hljs-string">&#x27;name=https://mirrors.tuna.tsinghua.edu.cn/zabbix/zabbix/5.0/rhel/8/x86_64/zabbix-agent2-5.0.24-1.el8.x86_64.rpm state=present validate_certs=no&#x27;</span><br><br>#启用epel源进行安装<br><span class="hljs-selector-attr">[root@ansible ~]</span><span class="hljs-selector-id">#ansible</span> websrvs -m yum -<span class="hljs-selector-tag">a</span> <span class="hljs-string">&#x27;name=nginx state=present enablerepo=epel&#x27;</span><br><br>#升级除kernel和foo开头以外的所有包<br><span class="hljs-selector-attr">[root@ansible ~]</span><span class="hljs-selector-id">#ansible</span> websrvs -m yum -<span class="hljs-selector-tag">a</span> <span class="hljs-string">&#x27;name=* state=lastest exclude=kernel*,foo*&#x27;</span><br><br>#删除<br><span class="hljs-selector-attr">[root@ansible ~]</span><span class="hljs-selector-id">#ansible</span> websrvs -m yum -<span class="hljs-selector-tag">a</span> <span class="hljs-string">&#x27;name=httpd state=absent&#x27;</span><br><span class="hljs-selector-attr">[root@ansible ~]</span><span class="hljs-selector-id">#ansible</span> websrvs -m yum -<span class="hljs-selector-tag">a</span> <span class="hljs-string">&#x27;name=sl,cowsay&#x27;</span><br></code></pre></td></tr></table></figure><h3 id="yum-repository-模块"><a href="#yum-repository-模块" class="headerlink" title="yum_repository 模块"></a>yum_repository 模块</h3><p>功能: 此模块实现yum的仓库配置管理<br>常见选项</p><figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs pf">name <span class="hljs-comment">#仓库id</span><br>description <span class="hljs-comment">#仓库描述名称,对应配置文件中的name=</span><br>baseurl <span class="hljs-comment">#仓库的地址</span><br>gpgcheck <span class="hljs-comment">#验证开启</span><br>gpgkey <span class="hljs-comment">#仓库公钥路径</span><br><span class="hljs-keyword">state</span>=absen  <span class="hljs-comment">#删除</span><br></code></pre></td></tr></table></figure><p>范例：</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs awk">ansible websrvs -m yum_repository -a <span class="hljs-string">&#x27;name=ansible_nginx description=&quot;nginx repo&quot; baseurl=&quot;http://nginx.org/packages/centos/$releasever/$basearch/&quot; gpgcheck=yes gpgkey=&quot;https://nginx.org/keys/nginx_signing.key&quot;&#x27;</span><br><br>[root@rocky8 ~]<span class="hljs-comment">#cat /etc/yum.repos.d/ansible_nginx.repo</span><br>[ansible_nginx]<br>baseurl = http:<span class="hljs-regexp">//</span>nginx.org<span class="hljs-regexp">/packages/</span>centos<span class="hljs-regexp">/$releasever/</span><span class="hljs-variable">$basearch</span>/<br>gpgcheck = <span class="hljs-number">1</span><br>gpgkey = https:<span class="hljs-regexp">//</span>nginx.org<span class="hljs-regexp">/keys/</span>nginx_signing.key<br>name = nginx repo<br></code></pre></td></tr></table></figure><h3 id="Service-模块"><a href="#Service-模块" class="headerlink" title="Service 模块"></a>Service 模块</h3><p>此模块和sytemd功能相似,选项很多相同<br>功能：管理服务<br>常见选项</p><figure class="highlight excel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs excel">name #服务名称<br>state #服务状态<br>=started #启动<br>=stopped #停止<br>=restarted #重启<br>=reloaded #重载<br>enabled #开启自启动<br>daemon_reload #加载新的配置文件,适用于systemd模块<br></code></pre></td></tr></table></figure><p>范例：</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs vim">ansible <span class="hljs-keyword">all</span> -<span class="hljs-keyword">m</span> service -<span class="hljs-keyword">a</span> <span class="hljs-string">&#x27;name=httpd state=started enabled=yes&#x27;</span><br>ansible <span class="hljs-keyword">all</span> -<span class="hljs-keyword">m</span> service -<span class="hljs-keyword">a</span> <span class="hljs-string">&#x27;name=httpd state=stopped&#x27;</span><br>ansible <span class="hljs-keyword">all</span> -<span class="hljs-keyword">m</span> service -<span class="hljs-keyword">a</span> <span class="hljs-string">&#x27;name=httpd state=reloaded&#x27;</span><br>ansible <span class="hljs-keyword">all</span> -<span class="hljs-keyword">m</span> <span class="hljs-keyword">shell</span> -<span class="hljs-keyword">a</span> <span class="hljs-comment">&quot;sed -i &#x27;s/^Listen 80/Listen 8080/&#x27;</span><br>/etc/httpd/<span class="hljs-keyword">conf</span>/httpd.<span class="hljs-keyword">conf</span><span class="hljs-comment">&quot;</span><br>ansible <span class="hljs-keyword">all</span> -<span class="hljs-keyword">m</span> service -<span class="hljs-keyword">a</span> <span class="hljs-string">&#x27;name=httpd state=restarted&#x27;</span><br>#重启动指定网卡服务<br>ansible <span class="hljs-keyword">all</span> -<span class="hljs-keyword">m</span> service -<span class="hljs-keyword">a</span> <span class="hljs-string">&#x27;name=network state=absent args=eth0&#x27;</span><br></code></pre></td></tr></table></figure><h3 id="User-模块"><a href="#User-模块" class="headerlink" title="User 模块"></a>User 模块</h3><p>功能：管理用户<br>常见选项</p><figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs pf">name <span class="hljs-comment">#创建的名称</span><br>uid <span class="hljs-comment">#指定uid</span><br><span class="hljs-keyword">group</span> <span class="hljs-comment">#指定基本组</span><br>shell <span class="hljs-comment">#登录shell类型默认/bin/bash</span><br>create_home <span class="hljs-comment">#是否创建家目录</span><br>password <span class="hljs-comment">#设定对应的密码，必须是加密后的字符串才行，否则不生效</span><br>system <span class="hljs-comment">#yes表示系统用户</span><br>groups <span class="hljs-comment">#附加组</span><br>append <span class="hljs-comment">#追加附加组使用,yes表示增加新的附加组</span><br><span class="hljs-keyword">state</span> <span class="hljs-comment">#absen删除</span><br>remove <span class="hljs-comment">#yes表示删除用户时将家目录一起删除</span><br>generate_ssh_key <span class="hljs-comment">#创建私钥</span><br>ssh_keyu_bits <span class="hljs-comment">#私钥位数</span><br>ssh_key_file <span class="hljs-comment">#私钥文件路径</span><br></code></pre></td></tr></table></figure><p>范例：</p><figure class="highlight nsis"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs nsis"><span class="hljs-comment">#创建用户</span><br>ansible <span class="hljs-literal">all</span> -m <span class="hljs-literal">user</span> -a <span class="hljs-string">&#x27;name=user1 comment=&quot;test user&quot; uid=2048 home=/app/user1group=root&#x27;</span><br>ansible <span class="hljs-literal">all</span> -m <span class="hljs-literal">user</span> -a <span class="hljs-string">&#x27;name=nginx comment=nginx uid=88 group=nginxgroups=&quot;root,daemon&quot; shell=/sbin/nologin system=yes create_home=nohome=/data/nginx non_unique=yes&#x27;</span><br><span class="hljs-comment">#remove=yes表示删除用户及家目录等数据,默认remove=no</span><br>ansible <span class="hljs-literal">all</span> -m <span class="hljs-literal">user</span> -a <span class="hljs-string">&#x27;name=nginx state=absent remove=yes&#x27;</span><br><span class="hljs-comment">#生成123456加密的密码</span><br>ansible localhost -m debug -a <span class="hljs-string">&quot;msg=&#123;&#123; &#x27;123456&#x27;| password_hash(&#x27;sha512&#x27;,&#x27;salt&#x27;)&#125;&#125;&quot;</span> localhost | SUCCESS =&gt; &#123; <span class="hljs-string">&quot;msg&quot;</span>: <span class="hljs-string">&quot;<span class="hljs-variable">$6</span><span class="hljs-variable">$salt</span><span class="hljs-variable">$MktMKPZJ6t59GfxcJU20DwcwQzfMvOlHFVZiOVD71w.</span>&quot;</span><br>&#125;<br><span class="hljs-comment">#用上面创建的密码创建用户</span><br>ansible websrvs -m <span class="hljs-literal">user</span> -a <span class="hljs-string">&#x27;name=www group=www system=yes shell=/sbin/nlogin password=&quot;<span class="hljs-variable">$6</span><span class="hljs-variable">$salt</span><span class="hljs-variable">$MktMKPZJ6t59GfxcJU20DwcwQzfMvOlHFVZiOVD71w.</span>&quot;&#x27;</span><br><span class="hljs-comment">#创建用户test,并生成4096bit的私钥</span><br>ansible websrvs -m <span class="hljs-literal">user</span> -a <span class="hljs-string">&#x27;name=test generate_ssh_key=yes ssh_key_bits=4096 ssh_key_file=.ssh/id_rsa&#x27;</span><br></code></pre></td></tr></table></figure><h3 id="Group-模块"><a href="#Group-模块" class="headerlink" title="Group 模块"></a>Group 模块</h3><p>功能：管理组<br>常见选项</p><figure class="highlight excel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs excel">name #指定组名称<br>gid #指定gid<br>state<br>=present #创建,默认<br>=absent #删除<br></code></pre></td></tr></table></figure><p>范例：</p><figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs pf"><span class="hljs-comment">#创建组</span><br>ansible websrvs -m <span class="hljs-keyword">group</span> -a &#x27;name=nginx gid=<span class="hljs-number">88</span> system=yes&#x27;<br><span class="hljs-comment">#删除组</span><br>ansible websrvs -m <span class="hljs-keyword">group</span> -a &#x27;name=nginx <span class="hljs-keyword">state</span>=absent&#x27;<br></code></pre></td></tr></table></figure><h3 id="Lineinfile-模块"><a href="#Lineinfile-模块" class="headerlink" title="Lineinfile 模块"></a>Lineinfile 模块</h3><p>ansible在使用sed进行替换时，经常会遇到需要转义的问题，而且ansible在遇到特殊符号进行替换时，<br>会存在问题，无法正常进行替换 。</p><p>ansible自身提供了两个模块：lineinfile模块和replace模块，可以方便的进行替换一般在ansible当中去修改某个文件的单行进行替换的时候需要使用lineinfile模块<br>功能：相当于sed，主要用于修改一行的文件内容<br>常见选项</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">path <span class="hljs-comment">#被控端文件的路径</span><br>regexp <span class="hljs-comment">#正则匹配语法格式,表示被替换的内容</span><br>line <span class="hljs-comment">#替换为的内容</span><br>state <span class="hljs-comment">#absent表示删除</span><br><span class="hljs-keyword">insertafter </span><span class="hljs-comment">#插入到替换内容前面,如和regexp同时存在,只在没找到与regexp匹配时才使用</span><br><span class="hljs-keyword">insertafter</span><br><span class="hljs-keyword"></span><span class="hljs-keyword">insertbefore </span><span class="hljs-comment">#插入到替换内容后面,如和regexp同时存在,只在没找到与regexp匹配时才使用</span><br><span class="hljs-keyword">insertafter</span><br><span class="hljs-keyword"></span><span class="hljs-keyword">backrefs </span><span class="hljs-comment">#支持后面引用,yes和no</span><br><span class="hljs-keyword">backup </span><span class="hljs-comment">#修改前先备份</span><br>create <span class="hljs-comment">#如果文件不存在,则创建,默认不存在会出错</span><br>mode <span class="hljs-comment">#指定权限</span><br>owner <span class="hljs-comment">#指定用户</span><br>group <span class="hljs-comment">#指定组</span><br><span class="hljs-comment">#注意</span><br>regexp参数 ：使用正则表达式匹配对应的行，当替换文本时，如果有多行文本都能被匹配，则只有最后面被<br>匹配到的那行文本才会被替换，当删除文本时，如果有多行文本都能被匹配，这么这些行都会被删除。<br></code></pre></td></tr></table></figure><p>注意: 如果想进行多行匹配进行替换需要使用replace模块<br>范例：</p><figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs pf"><span class="hljs-comment">#修改监听端口</span><br>ansible websrvs -m lineinfile -a <span class="hljs-string">&quot;path=/etc/httpd/conf/httpd.conf regexp=&#x27;^Listen&#x27; line=&#x27;Listen 8080&#x27;&quot;</span><br><br><span class="hljs-comment">#修改SELinux</span><br>ansible <span class="hljs-literal">all</span> -m lineinfile -a <span class="hljs-string">&quot;path=/etc/selinux/config regexp=&#x27;^SELINUX=&#x27;line=&#x27;SELINUX=disabled&#x27;&quot;</span><br><br><span class="hljs-comment">#添加网关</span><br>ansible webservers -m lineinfile -a &#x27;path=/etc/sysconfig/network-scripts/ifcfg-eth0 line=<span class="hljs-string">&quot;GATEWAY=10.0.0.254&quot;</span>&#x27;<br><br><span class="hljs-comment">#给主机增加一个网关，但需要增加到NAME=下面</span><br>ansible webservers -m lineinfile -a &#x27;path=/etc/sysconfig/network-scripts/ifcfg-eth0 insertafter=<span class="hljs-string">&quot;^NAME=&quot;</span> line=<span class="hljs-string">&quot;GATEWAY=10.0.0.254&quot;</span>&#x27;<br><span class="hljs-comment">#效果如下</span><br>cat /etc/sysconfig/network-scripts/ifcfg-eth0<br>DEVICE=eth0<br>NAME=eth0<br>GATEWAY=<span class="hljs-number">10.0</span>.<span class="hljs-number">0.254</span><br><span class="hljs-comment">#给主机增加一个网关，但需要增加到NAME=上面</span><br>ansible webservers -m lineinfile -a &#x27;path=/etc/sysconfig/network-scripts/ifcfg-<br>eth0 insertbefore=<span class="hljs-string">&quot;^NAME=&quot;</span> line=<span class="hljs-string">&quot;GATEWAY=10.0.0.254&quot;</span>&#x27;<br><span class="hljs-comment">#效果如下</span><br>cat /etc/sysconfig/network-scripts/ifcfg-eth0<br>DEVICE=eth0<br>GATEWAY=<span class="hljs-number">10.0</span>.<span class="hljs-number">0.254</span><br>NAME=eth0<br><span class="hljs-comment">#删除网关</span><br>ansible webservers -m lineinfile -a &#x27;path=/etc/sysconfig/network-scripts/ifcfg-eth0 regexp=<span class="hljs-string">&quot;^GATEWAY&quot;</span> <span class="hljs-keyword">state</span>=absent&#x27;<br><span class="hljs-comment">#删除#开头的行</span><br>ansible <span class="hljs-literal">all</span> -m lineinfile -a &#x27;dest=/etc/fstab <span class="hljs-keyword">state</span>=absent regexp=<span class="hljs-string">&quot;^#&quot;</span>&#x27;<br></code></pre></td></tr></table></figure><h3 id="Replace-模块"><a href="#Replace-模块" class="headerlink" title="Replace 模块"></a>Replace 模块</h3><p>该模块有点类似于sed命令，主要也是基于正则进行匹配和替换，建议使用<br>功能: 多行修改替换<br>常见选项</p><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs livecodeserver">path <span class="hljs-comment">#被控端文件的路径</span><br>regexp <span class="hljs-comment">#正则匹配语法格式,表示被替换的内容</span><br><span class="hljs-built_in">replace</span> <span class="hljs-comment">#替换为的内容</span><br><span class="hljs-keyword">after</span> <span class="hljs-comment">#插入到替换内容前面,</span><br><span class="hljs-keyword">before</span> <span class="hljs-comment">#插入到替换内容后面</span><br>backup <span class="hljs-comment">#修改前先备份</span><br>mode <span class="hljs-comment">#指定权限</span><br>owner <span class="hljs-comment">#指定用户</span><br>group <span class="hljs-comment">#指定组</span><br></code></pre></td></tr></table></figure><p>范例</p><figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs arcade">ansible <span class="hljs-built_in">all</span> -m <span class="hljs-built_in">replace</span> -a <span class="hljs-string">&quot;path=/etc/fstab regexp=&#x27;^(UUID.*)&#x27; replace=&#x27;#\1&#x27;&quot;</span><br>ansible <span class="hljs-built_in">all</span> -m <span class="hljs-built_in">replace</span> -a <span class="hljs-string">&quot;path=/etc/fstab regexp=&#x27;^#(UUID.*)&#x27; replace=&#x27;\1&#x27;&quot;</span><br></code></pre></td></tr></table></figure><h3 id="SELinux-模块"><a href="#SELinux-模块" class="headerlink" title="SELinux 模块"></a>SELinux 模块</h3><p>功能: 该模块管理 SELInux 策略<br>常见选项</p><figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs pf">policy <span class="hljs-comment">#指定SELINUXTYPE=targeted</span><br><span class="hljs-keyword">state</span> <span class="hljs-comment">#指定SELINUX=disabled</span><br></code></pre></td></tr></table></figure><p>范例</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs ruby">[root<span class="hljs-variable">@rocky</span> ansible-apps]<span class="hljs-comment"># ansible 192.168.32.132 -m selinux -a &#x27;state=disabled&#x27;</span><br><span class="hljs-meta prompt_">192.168.32.132 | FAILED! =&gt;</span> &#123;<br>    <span class="hljs-string">&quot;msg&quot;</span>: <span class="hljs-string">&quot;The module selinux was redirected to ansible.posix.selinux, which could not be loaded.&quot;</span><br>&#125;<br><br><span class="hljs-comment"># ansible版本2.13.3出现如下错误</span><br> <span class="hljs-string">&quot;msg&quot;</span>: <span class="hljs-string">&quot;The module selinux was redirected to ansible.posix.selinux, which could not be loaded.&quot;</span><br> <br> <span class="hljs-comment"># 解决方法</span><br> [root<span class="hljs-variable">@rocky</span> ansible-apps]<span class="hljs-comment"># ansible-galaxy collection install ansible.posix</span><br><br><br><span class="hljs-comment"># 再次执行，显示成功</span><br>[root<span class="hljs-variable">@rocky</span> ansible-apps]<span class="hljs-comment"># ansible 192.168.32.132 -m selinux -a &#x27;state=disabled&#x27;</span><br>[<span class="hljs-variable constant_">WARNING</span>]: SELinux state temporarily changed from <span class="hljs-string">&#x27;enforcing&#x27;</span> to <span class="hljs-string">&#x27;permissive&#x27;</span>. State change will take effect <span class="hljs-keyword">next</span> reboot.<br><span class="hljs-meta prompt_">192.168.32.132 | CHANGED =&gt;</span> &#123;<br>    <span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br>        <span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/libexec/platform-python&quot;</span><br>    &#125;,<br>    <span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">true</span>,<br>    <span class="hljs-string">&quot;configfile&quot;</span>: <span class="hljs-string">&quot;/etc/selinux/config&quot;</span>,<br>    <span class="hljs-string">&quot;msg&quot;</span>: <span class="hljs-string">&quot;Config SELinux state changed from &#x27;enforcing&#x27; to &#x27;disabled&#x27;&quot;</span>,<br>    <span class="hljs-string">&quot;policy&quot;</span>: <span class="hljs-string">&quot;targeted&quot;</span>,<br>    <span class="hljs-string">&quot;reboot_required&quot;</span>: <span class="hljs-literal">true</span>,<br>    <span class="hljs-string">&quot;state&quot;</span>: <span class="hljs-string">&quot;disabled&quot;</span><br>&#125;<br><br></code></pre></td></tr></table></figure><h3 id="reboot-模块"><a href="#reboot-模块" class="headerlink" title="reboot 模块"></a>reboot 模块</h3><p>功能: 重启<br>常见选项</p><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli">msg <span class="hljs-comment">#重启提示</span><br>pre_reboot_delay <span class="hljs-comment">#重启前延迟时间的秒数</span><br>post_reboot_delay <span class="hljs-comment">#重启后延迟时间的秒数后,再验证系统正常启动</span><br>reboot_timeout <span class="hljs-comment">#重启后延迟时间再执行测试成功与否的命令</span><br>test_<span class="hljs-keyword">command</span> <span class="hljs-comment">#执行测试成功与否的命令</span><br></code></pre></td></tr></table></figure><p>范例:</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-selector-attr">[root@ansible ~]</span><span class="hljs-selector-id">#ansible</span> websrvs -m reboot -<span class="hljs-selector-tag">a</span> <span class="hljs-string">&#x27;msg=&quot;host will be reboot&quot;&#x27;</span><br></code></pre></td></tr></table></figure><h3 id="mount-模块"><a href="#mount-模块" class="headerlink" title="mount 模块"></a>mount 模块</h3><p>功能: 挂载和卸载文件系统<br>常见选项</p><figure class="highlight excel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs excel">src #源设备路径，或网络地址<br>path #挂载至本地哪个路径下<br>fstype #设备类型； nfs<br>opts #挂载的选项<br>state #挂载还是卸载<br>=present #永久挂载，但没有立即生效<br>=absent #卸载临时挂载,并删除永久挂载<br>=mounted #临时挂载<br>=unmounted #临时卸载<br></code></pre></td></tr></table></figure><p>范例:</p><figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs pf"><span class="hljs-comment">#修改fstab文件永久挂载,但不立即生效</span><br>mount websrvs -m mount -a &#x27;src=<span class="hljs-string">&quot;UUID=b3e48f45-f933-4c8e-a700-22a159ec9077&quot;</span> path=/home fstype=xfs opts=noatime <span class="hljs-keyword">state</span>=present&#x27;<br><span class="hljs-comment">#临时取消挂载</span><br>mount websrvs -m mount -a &#x27;path=/home fstype=xfs opts=noatime <span class="hljs-keyword">state</span>=unmounted&#x27;<br><span class="hljs-comment">#永久挂载,并立即生效</span><br>ansible websrvs -m mount -a &#x27;src=<span class="hljs-number">10.0</span>.<span class="hljs-number">0.8</span>:/data/wordpress path=/var/www/html/wp- content/uploads opts=<span class="hljs-string">&quot;_netdev&quot;</span> <span class="hljs-keyword">state</span>=mounted&#x27;<br><span class="hljs-comment">#永久卸载,并立即生效</span><br>ansible websrvs -m mount -a &#x27;src=<span class="hljs-number">10.0</span>.<span class="hljs-number">0.8</span>:/data/wordpress path=/var/www/html/wp- content/uploads <span class="hljs-keyword">state</span>=absent&#x27;<br></code></pre></td></tr></table></figure><h3 id="Setup-模块"><a href="#Setup-模块" class="headerlink" title="Setup 模块"></a>Setup 模块</h3><p>功能： setup 模块来收集主机的系统信息，这些 facts 信息可以直接以变量的形式使用，但是如果主机<br>较多，会影响执行速度<br>可以使用 gather_facts: no 来禁止 Ansible 收集 facts 信息<br>常见选项</p><figure class="highlight golo"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs golo"><span class="hljs-keyword">filter</span> <span class="hljs-comment">#指定过滤条件</span><br></code></pre></td></tr></table></figure><p>范例:</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs stylus">ansible <span class="hljs-attribute">all</span> -m setup<br>ansible <span class="hljs-attribute">all</span> -m setup -a <span class="hljs-string">&quot;filter=ansible_nodename&quot;</span><br>ansible <span class="hljs-attribute">all</span> -m setup -a <span class="hljs-string">&quot;filter=ansible_hostname&quot;</span>  #  主机名称<br>ansible <span class="hljs-attribute">all</span> -m setup -a <span class="hljs-string">&quot;filter=ansible_domain&quot;</span><br>ansible <span class="hljs-attribute">all</span> -m setup -a <span class="hljs-string">&quot;filter=ansible_memtotal_mb&quot;</span><br>ansible <span class="hljs-attribute">all</span> -m setup -a <span class="hljs-string">&quot;filter=ansible_memory_mb&quot;</span><br>ansible <span class="hljs-attribute">all</span> -m setup -a <span class="hljs-string">&quot;filter=ansible_memfree_mb&quot;</span><br>ansible <span class="hljs-attribute">all</span> -m setup -a <span class="hljs-string">&quot;filter=ansible_os_family&quot;</span><br>ansible <span class="hljs-attribute">all</span> -m setup -a <span class="hljs-string">&quot;filter=ansible_distribution&quot;</span><br>ansible <span class="hljs-attribute">all</span> -m setup -a <span class="hljs-string">&quot;filter=ansible_distribution_major_version&quot;</span><br>ansible <span class="hljs-attribute">all</span> -m setup -a <span class="hljs-string">&quot;filter=ansible_distribution_version&quot;</span><br>ansible <span class="hljs-attribute">all</span> -m setup -a <span class="hljs-string">&quot;filter=ansible_processor_vcpus&quot;</span><br>ansible <span class="hljs-attribute">all</span> -m setup -a <span class="hljs-string">&quot;filter=ansible_all_ipv4_addresses&quot;</span><br>ansible <span class="hljs-attribute">all</span> -m setup -a <span class="hljs-string">&quot;filter=ansible_architecture&quot;</span><br>ansible <span class="hljs-attribute">all</span> -m setup -a <span class="hljs-string">&quot;filter=ansible_uptime_seconds&quot;</span><br>ansible <span class="hljs-attribute">all</span> -m setup -a <span class="hljs-string">&quot;filter=ansible_processor*&quot;</span><br>ansible <span class="hljs-attribute">all</span> -m setup -a <span class="hljs-string">&#x27;filter=ansible_env&#x27;</span><br></code></pre></td></tr></table></figure><p>范例：</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs ruby">[root<span class="hljs-variable">@ansible</span> ~]<span class="hljs-comment">#ansible all -m setup -a &#x27;filter=ansible_python_version&#x27;</span><br><span class="hljs-meta prompt_">10.0.0.7 | SUCCESS =&gt;</span> &#123;<br><span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br><span class="hljs-string">&quot;ansible_python_version&quot;</span>: <span class="hljs-string">&quot;2.7.5&quot;</span>,<br><span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br>&#125;,<br><span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">false</span><br>&#125;<br><span class="hljs-meta prompt_">10.0.0.6 | SUCCESS =&gt;</span> &#123;<br><span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br><span class="hljs-string">&quot;ansible_python_version&quot;</span>: <span class="hljs-string">&quot;2.6.6&quot;</span>,<br><span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/bin/python&quot;</span><br>&#125;,<br><span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">false</span><br>&#125;<br><span class="hljs-meta prompt_">10.0.0.8 | SUCCESS =&gt;</span> &#123;<br><span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br><span class="hljs-string">&quot;ansible_python_version&quot;</span>: <span class="hljs-string">&quot;3.6.8&quot;</span>,<br><span class="hljs-string">&quot;discovered_interpreter_python&quot;</span>: <span class="hljs-string">&quot;/usr/libexec/platform-python&quot;</span><br>&#125;,<br><span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">false</span><br>&#125;<br>[root<span class="hljs-variable">@ansible</span> ~]<span class="hljs-comment">#</span><br></code></pre></td></tr></table></figure><p>范例：取IP地址</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs ruby"><span class="hljs-comment">#取所有IP</span><br>ansible <span class="hljs-number">10.0</span>.<span class="hljs-number">0.101</span> -m setup -a <span class="hljs-string">&#x27;filter=ansible_all_ipv4_addresses&#x27;</span><br><span class="hljs-meta prompt_">10.0.0.101 | SUCCESS =&gt;</span> &#123;<br><span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br><span class="hljs-string">&quot;ansible_all_ipv4_addresses&quot;</span>: [<br><span class="hljs-string">&quot;192.168.0.1&quot;</span>,<br><span class="hljs-string">&quot;192.168.0.2&quot;</span>,<br><span class="hljs-string">&quot;192.168.64.238&quot;</span>,<br><span class="hljs-string">&quot;192.168.13.36&quot;</span>,<br><span class="hljs-string">&quot;10.0.0.101&quot;</span>,<br><span class="hljs-string">&quot;172.16.1.0&quot;</span>,<br><span class="hljs-string">&quot;172.17.0.1&quot;</span><br>]<br>&#125;,<br><span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">false</span><br>&#125;<br><span class="hljs-comment">#取默认IP</span><br>ansible all -m setup -a <span class="hljs-string">&#x27;filter=&quot;ansible_default_ipv4&quot;&#x27;</span><br><span class="hljs-meta prompt_">10.0.0.101 | SUCCESS =&gt;</span> &#123;<br><span class="hljs-string">&quot;ansible_facts&quot;</span>: &#123;<br><span class="hljs-string">&quot;ansible_default_ipv4&quot;</span>: &#123;<br><span class="hljs-string">&quot;address&quot;</span>: <span class="hljs-string">&quot;10.0.0.101&quot;</span>,<br><span class="hljs-string">&quot;alias&quot;</span>: <span class="hljs-string">&quot;eth0&quot;</span>,<br><span class="hljs-string">&quot;broadcast&quot;</span>: <span class="hljs-string">&quot;10.0.0.255&quot;</span>,<br><span class="hljs-string">&quot;gateway&quot;</span>: <span class="hljs-string">&quot;10.0.0.2&quot;</span>,<br><span class="hljs-string">&quot;interface&quot;</span>: <span class="hljs-string">&quot;eth0&quot;</span>,<br><span class="hljs-string">&quot;macaddress&quot;</span>: <span class="hljs-string">&quot;00:0c:29:e8:c7:9b&quot;</span>,<br><span class="hljs-string">&quot;mtu&quot;</span>: <span class="hljs-number">1500</span>,<br><span class="hljs-string">&quot;netmask&quot;</span>: <span class="hljs-string">&quot;255.255.255.0&quot;</span>,<br><span class="hljs-string">&quot;network&quot;</span>: <span class="hljs-string">&quot;10.0.0.0&quot;</span>,<br><span class="hljs-string">&quot;type&quot;</span>: <span class="hljs-string">&quot;ether&quot;</span><br>&#125;<br>&#125;,<br><span class="hljs-string">&quot;changed&quot;</span>: <span class="hljs-literal">false</span><br>&#125;<br></code></pre></td></tr></table></figure><h3 id="debug-模块"><a href="#debug-模块" class="headerlink" title="debug 模块"></a>debug 模块</h3><p>功能: 此模块可以用于输出信息,并且通过 msg 定制输出的信息内容,功能类似于echo命令<br>注意: msg后面的变量有时需要加 “ “ 引起来<br>常见选项</p><figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs axapta">msg <span class="hljs-meta">#指定命令输出的信息</span><br><span class="hljs-built_in">var</span> <span class="hljs-meta">#指定变量名,和msg互斥</span><br>verbosity <span class="hljs-meta">#详细度</span><br></code></pre></td></tr></table></figure><p>范例: debug 模块默认输出Hello world</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs markdown">[root@ansible ~]#ansible 10.0.0.18 -m debug<br>10.0.0.18 | SUCCESS =&gt; &#123;<br>&quot;msg&quot;: &quot;Hello world!&quot;<br>&#125;<br><span class="hljs-section">[root@ansible ansible]#cat debug.yml</span><br><span class="hljs-section">---</span><br><span class="hljs-bullet">-</span> hosts: websrvs<br>tasks:<br><span class="hljs-bullet">-</span> name: output Hello world<br>debug:<br><span class="hljs-section">#默认没有指定msg,默认输出&quot;Hello world!&quot;</span><br>[root@ansible ansible]#ansible-playbook debug.yml<br>.....<br>TASK [output variables]<br><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><br><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">**</span><br><span class="hljs-strong">ok: [10.0.0.7] =&gt; &#123;</span><br><span class="hljs-strong">&quot;msg&quot;: &quot;Hello world!&quot;</span><br><span class="hljs-strong">&#125;</span><br><span class="hljs-strong">ok: [10.0.0.8] =&gt; &#123;</span><br><span class="hljs-strong">&quot;msg&quot;: &quot;Hello world!&quot;</span><br><span class="hljs-strong">&#125;</span><br><span class="hljs-strong">PLAY RECAP</span><br><span class="hljs-strong">**</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">**</span><br><span class="hljs-strong">**</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-emphasis">*</span><br><span class="hljs-emphasis">10.0.0.7 : ok=2 changed=0 unreachable=0 failed=0</span><br><span class="hljs-emphasis">skipped=0 rescued=0 ignored=0</span><br><span class="hljs-emphasis">10.0.0.8 : ok=2 changed=0 unreachable=0 failed=0</span><br><span class="hljs-emphasis">skipped=0 rescued=0 ignored=0</span><br></code></pre></td></tr></table></figure><p>范例: 利用debug 模块输出变量</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs markdown"><span class="hljs-section">[root@centos8 ~]#cat debug.yaml</span><br><span class="hljs-section">---</span><br><span class="hljs-bullet">-</span> hosts: websrvs<br>tasks:<br><span class="hljs-bullet">-</span> name: output variables<br>debug:<br>msg: Host &quot;&#123;&#123; ansible<span class="hljs-emphasis">_nodename &#125;&#125;&quot; Ip &quot;&#123;&#123; ansible_</span>default<span class="hljs-emphasis">_ipv4.address</span><br><span class="hljs-emphasis">&#125;&#125;&quot;</span><br><span class="hljs-emphasis">[root@centos8 ~]#ansible-playbook debug.yaml</span><br><span class="hljs-emphasis">PLAY [websrvs]</span><br><span class="hljs-emphasis"><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span></span><br><span class="hljs-emphasis"><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">***</span></span><br><span class="hljs-strong"><span class="hljs-emphasis">TASK [Gathering Facts]</span></span><br><span class="hljs-strong"><span class="hljs-emphasis">**</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">**</span></span><br><span class="hljs-strong"><span class="hljs-emphasis">**</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span>*</span><br><span class="hljs-emphasis">ok: [10.0.0.7]</span><br><span class="hljs-emphasis">ok: [10.0.0.8]</span><br><span class="hljs-emphasis">TASK [output variables]</span><br><span class="hljs-emphasis"><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span></span><br><span class="hljs-emphasis"><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">**</span></span><br><span class="hljs-strong"><span class="hljs-emphasis">ok: [10.0.0.7] =&gt; &#123;</span></span><br><span class="hljs-strong"><span class="hljs-emphasis">&quot;msg&quot;: &quot;Host \&quot;centos7.wangxiaochun.com\&quot; Ip \&quot;10.0.0.7\&quot;&quot;</span></span><br><span class="hljs-strong"><span class="hljs-emphasis">&#125;</span></span><br><span class="hljs-strong"><span class="hljs-emphasis">ok: [10.0.0.8] =&gt; &#123;</span></span><br><span class="hljs-strong"><span class="hljs-emphasis">&quot;msg&quot;: &quot;Host \&quot;centos8.wangxiaochun.com\&quot; Ip \&quot;10.0.0.8\&quot;&quot;</span></span><br><span class="hljs-strong"><span class="hljs-emphasis">&#125;</span></span><br><span class="hljs-strong"><span class="hljs-emphasis">PLAY RECAP</span></span><br><span class="hljs-strong"><span class="hljs-emphasis">**</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">**</span></span><br><span class="hljs-strong"><span class="hljs-emphasis">**</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span>*</span><br><span class="hljs-emphasis">10.0.0.7 : ok=2 changed=0 unreachable=0 failed=0</span><br><span class="hljs-emphasis">skipped=0 rescued=0 ignored=0</span><br><span class="hljs-emphasis">10.0.0.8 : ok=2 changed=0 unreachable=0 failed=0</span><br><span class="hljs-emphasis">skipped=0 rescued=0 ignored=0</span><br></code></pre></td></tr></table></figure><p>范例: 显示字符串特定字符</p><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs dts"><span class="hljs-meta"># cat debug.yml</span><br>- hosts: all<br><span class="hljs-symbol">  gather_facts:</span> no<br><span class="hljs-symbol">  vars:</span><br><span class="hljs-symbol">    a:</span> <span class="hljs-string">&quot;12345&quot;</span><br><span class="hljs-symbol">  tasks:</span><br>  - debug:<br><span class="hljs-symbol">    msg:</span><br>      - <span class="hljs-string">&quot;&#123;&#123;a[0]&#125;&#125;&quot;</span><br>      - <span class="hljs-string">&quot;&#123;&#123;a[1]&#125;&#125;&quot;</span><br>      - <span class="hljs-string">&quot;&#123;&#123;a[2]&#125;&#125;&quot;</span><br><span class="hljs-meta">#定义了一个字符串变量a，如果想要获取a字符串的第3个字符，则可以使用”a[2]”获取，索引从0开始，执行上例playbook，debug的输出信息如下：</span><br>TASK [debug] *************************<br><span class="hljs-symbol">ok:</span> [test1] =&gt; <span class="hljs-punctuation">&#123;</span><br><span class="hljs-string">&quot;msg&quot;</span>: <span class="hljs-string">&quot;1&quot;</span><br><span class="hljs-string">&quot;msg&quot;</span>: <span class="hljs-string">&quot;2&quot;</span><br><span class="hljs-string">&quot;msg&quot;</span>: <span class="hljs-string">&quot;3&quot;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure><h3 id="sysctl-模块"><a href="#sysctl-模块" class="headerlink" title="sysctl 模块"></a>sysctl 模块</h3><p>功能: 修改内核参数<br>常见选项</p><figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs pf">name <span class="hljs-comment">#内核参数</span><br>value <span class="hljs-comment">#指定值</span><br><span class="hljs-keyword">state</span> <span class="hljs-comment">#是否保存在sysctl.conf文件中,默认present</span><br>sysctl_set <span class="hljs-comment">#使用sysctl -w 验证值生效</span><br></code></pre></td></tr></table></figure><p>范例:</p><figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs pf">ansible websrvs -m sysctl -a &#x27;name=net.ipv4.ip_forward value=<span class="hljs-number">1</span> <span class="hljs-keyword">state</span>=present&#x27;<br></code></pre></td></tr></table></figure><p>范例: 内核参数优化</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Change</span> <span class="hljs-string">Port</span> <span class="hljs-string">Range</span><br>  <span class="hljs-attr">sysctl:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">net.ipv4.ip_local_port_range</span><br>	<span class="hljs-attr">value:</span> <span class="hljs-string">&#x27;1024 65000&#x27;</span><br>	<span class="hljs-attr">sysctl_set:</span> <span class="hljs-literal">yes</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Enabled</span> <span class="hljs-string">Forward</span><br>  <span class="hljs-attr">sysctl:</span><br>	<span class="hljs-attr">name:</span> <span class="hljs-string">net.ipv4.ip_forward</span><br>	<span class="hljs-attr">value:</span> <span class="hljs-string">&#x27;1&#x27;</span><br>	<span class="hljs-attr">sysctl_set:</span> <span class="hljs-literal">yes</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Enabled</span> <span class="hljs-string">tcp_reuse</span><br>  <span class="hljs-attr">sysctl:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">net.ipv4.tcp_tw_reuse</span><br>    <span class="hljs-attr">value:</span> <span class="hljs-string">&#x27;1&#x27;</span><br>    <span class="hljs-attr">sysctl_set:</span> <span class="hljs-literal">yes</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Chanage</span> <span class="hljs-string">tcp</span> <span class="hljs-string">tw_buckets</span><br>  <span class="hljs-attr">sysctl:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">net.ipv4.tcp_max_tw_buckets</span><br>    <span class="hljs-attr">value:</span> <span class="hljs-string">&#x27;5000&#x27;</span><br>    <span class="hljs-attr">sysctl_set:</span> <span class="hljs-literal">yes</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Chanage</span> <span class="hljs-string">tcp_syncookies</span><br>  <span class="hljs-attr">sysctl:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">net.ipv4.tcp_syncookies</span><br>    <span class="hljs-attr">value:</span> <span class="hljs-string">&#x27;1&#x27;</span><br>    <span class="hljs-attr">sysctl_set:</span> <span class="hljs-literal">yes</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Chanage</span> <span class="hljs-string">tcp</span> <span class="hljs-string">max_syn_backlog</span><br>  <span class="hljs-attr">sysctl:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">net.ipv4.tcp_max_syn_backlog</span><br>    <span class="hljs-attr">value:</span> <span class="hljs-string">&#x27;8192&#x27;</span><br>    <span class="hljs-attr">sysctl_set:</span> <span class="hljs-literal">yes</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Chanage</span> <span class="hljs-string">tcp</span> <span class="hljs-string">Established</span> <span class="hljs-string">Maxconn</span><br>  <span class="hljs-attr">sysctl:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">net.core.somaxconn</span><br>    <span class="hljs-attr">value:</span> <span class="hljs-string">&#x27;32768&#x27;</span><br>    <span class="hljs-attr">sysctl_set:</span> <span class="hljs-literal">yes</span><br>    <span class="hljs-attr">state:</span> <span class="hljs-string">present</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Chanage</span> <span class="hljs-string">tcp_syn_retries</span><br>  <span class="hljs-attr">sysctl:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">net.ipv4.tcp_syn_retries</span><br>    <span class="hljs-attr">value:</span> <span class="hljs-string">&#x27;2&#x27;</span><br>    <span class="hljs-attr">sysctl_set:</span> <span class="hljs-literal">yes</span><br>    <span class="hljs-attr">state:</span> <span class="hljs-string">present</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Chanage</span> <span class="hljs-string">net.ipv4.tcp_synack_retries</span><br>  <span class="hljs-attr">sysctl:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">net.ipv4.tcp_synack_retries</span><br>    <span class="hljs-attr">value:</span> <span class="hljs-string">&#x27;2&#x27;</span><br>    <span class="hljs-attr">sysctl_set:</span> <span class="hljs-literal">yes</span><br>    <span class="hljs-attr">state:</span> <span class="hljs-string">presen</span><br></code></pre></td></tr></table></figure><h3 id="pam-limits"><a href="#pam-limits" class="headerlink" title="pam_limits"></a>pam_limits</h3><p>功能: 管理资源限制<br>范例</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Change</span> <span class="hljs-string">Limit</span> <span class="hljs-string">/etc/security/limit.conf</span><br>  <span class="hljs-attr">pam_limits:</span><br>  <span class="hljs-attr">domain:</span> <span class="hljs-string">&quot;*&quot;</span><br>    <span class="hljs-attr">limit_type:</span> <span class="hljs-string">&quot;<span class="hljs-template-variable">&#123;&#123; item.limit_type &#125;&#125;</span>&quot;</span><br>    <span class="hljs-attr">limit_item:</span> <span class="hljs-string">&quot;<span class="hljs-template-variable">&#123;&#123; item.limit_item &#125;&#125;</span>&quot;</span><br>    <span class="hljs-attr">value:</span> <span class="hljs-string">&quot;<span class="hljs-template-variable">&#123;&#123; item.value &#125;&#125;</span>&quot;</span><br>  <span class="hljs-attr">loop:</span><br>    <span class="hljs-bullet">-</span> &#123; <span class="hljs-attr">limit_type:</span> <span class="hljs-string">&#x27;soft&#x27;</span>, <span class="hljs-attr">limit_item:</span> <span class="hljs-string">&#x27;nofile&#x27;</span>,<span class="hljs-attr">value:</span> <span class="hljs-string">&#x27;100000&#x27;</span> &#125;<br>    <span class="hljs-bullet">-</span> &#123; <span class="hljs-attr">limit_type:</span> <span class="hljs-string">&#x27;hard&#x27;</span>, <span class="hljs-attr">limit_item:</span> <span class="hljs-string">&#x27;nofile&#x27;</span>,<span class="hljs-attr">value:</span> <span class="hljs-string">&#x27;10000&#x27;</span> &#125;<br></code></pre></td></tr></table></figure><h3 id="apt-repository-模块"><a href="#apt-repository-模块" class="headerlink" title="apt_repository 模块"></a>apt_repository 模块</h3><p>功能: 此模块实现apt的仓库配置管理<br>常见选项</p><figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs pf">repo <span class="hljs-comment">#仓库信息</span><br><span class="hljs-keyword">state</span> <span class="hljs-comment">#添加或删除</span><br>update_cache <span class="hljs-comment">#是否apt update,默认yes</span><br>filename <span class="hljs-comment">#仓库文件,默认放在/etc/apt/sources.list.d/file.list</span><br></code></pre></td></tr></table></figure><p>范例:</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">ansible</span> ubuntu-servers -m apt_repository -a <span class="hljs-string">&#x27;repo=&quot;deb</span><br><span class="hljs-string">http://archive.canonical.com/ubuntu focal partner&quot; filename=google-chrome&#x27;</span><br>[root<span class="hljs-variable">@ubuntu2004</span> ~]<span class="hljs-comment">#cat /etc/apt/sources.list.d/google-chrome.list</span><br>deb http://archive.canonical.com/ubuntu focal partner<br></code></pre></td></tr></table></figure><h3 id="apt-key-模块"><a href="#apt-key-模块" class="headerlink" title="apt_key 模块"></a>apt_key 模块</h3><p>功能: 添加和删除apt key<br>常见选项</p><figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs pf">url <span class="hljs-comment">#key路径</span><br><span class="hljs-keyword">state</span> <span class="hljs-comment">#添加或删除</span><br></code></pre></td></tr></table></figure><p>范例: 生成ceph仓库配置</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment">#先导入key,注意先后顺序</span><br><span class="hljs-attribute">ansible</span> ubuntu-servers -m apt_key -a<br><span class="hljs-string">&#x27;url=https://download.ceph.com/keys/release.asc state=present&#x27;</span><br><span class="hljs-comment">#再生成apt配置,如果不导入key此步会出错</span><br>ansible ubuntu-servers -m apt_repository -a <span class="hljs-string">&#x27;repo=&quot;deb</span><br><span class="hljs-string">http://mirror.tuna.tsinghua.edu.cn/ceph/debian-pacific focal main&quot;</span><br><span class="hljs-string">filename=ansible_ceph&#x27;</span><br><span class="hljs-comment">#验证结果</span><br>[root<span class="hljs-variable">@ubuntu2004</span> ~]<span class="hljs-comment">#cat /etc/apt/sources.list.d/ansible_ceph.list</span><br>deb http://mirror.tuna.tsinghua.edu.cn/ceph/debian-pacific focal main<br></code></pre></td></tr></table></figure><h3 id="其它模块"><a href="#其它模块" class="headerlink" title="其它模块"></a>其它模块</h3><p>ansible 还提供了很多针对各种应用的模块,比如</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">nginx_status_info</span><br>nginx_status_facts<br>mysql_db <span class="hljs-comment">#需要安装MySQL-python包</span><br>mysql_user <span class="hljs-comment">#需要安装MySQL-python包</span><br>redis<br>mongodb*<br>postgresql*<br>haproxy<br>git<br></code></pre></td></tr></table></figure></div><hr><div><div class="post-metas my-3"><div class="post-meta mr-3 d-flex align-items-center"><i class="iconfont icon-category"></i> <span class="category-chains"><span class="category-chain"><a href="/categories/Ansible/" class="category-chain-item">Ansible</a></span></span></div></div><div class="license-box my-3"><div class="license-title"><div>运维自动化工具Ansible(一)</div><div>https://itshare.work/2023/02/21/Ansible/</div></div><div class="license-meta"><div class="license-meta-item"><div>作者</div><div>yuankun</div></div><div class="license-meta-item license-meta-date"><div>发布于</div><div>2023年2月21日</div></div><div class="license-meta-item license-meta-date"><div>更新于</div><div>2023年2月27日</div></div><div class="license-meta-item"><div>许可协议</div><div><a target="_blank" href="https://creativecommons.org/licenses/by/4.0/"><span class="hint--top hint--rounded" aria-label="BY - 署名"><i class="iconfont icon-by"></i></span></a></div></div></div><div class="license-icon iconfont"></div></div><div class="post-prevnext my-3"><article class="post-prev col-6"><a href="/2023/02/25/Ansible2/" title="运维自动化工具Ansible(二)"><i class="iconfont icon-arrowleft"></i> <span class="hidden-mobile">运维自动化工具Ansible(二)</span> <span class="visible-mobile">上一篇</span></a></article><article class="post-next col-6"><a href="/2023/01/11/%E5%B8%B8%E7%94%A8shell%E8%84%9A%E6%9C%AC/" title="常用shell脚本"><span class="hidden-mobile">常用shell脚本</span> <span class="visible-mobile">下一篇</span> <i class="iconfont icon-arrowright"></i></a></article></div></div><article id="comments" lazyload><div id="valine"></div><script type="text/javascript">Fluid.utils.loadComments("#valine",(function(){Fluid.utils.createScript("https://lib.baomitu.com/valine/1.5.1/Valine.min.js",(function(){var i=Object.assign({appId:"hQDROocUhxVs3CipuQjO33sY-gzGzoHsz",appKey:"CHcmi9bz6KRRaChFJVSY14g1",path:"window.location.pathname",placeholder:"请在这里书写你想说的话······",avatar:"retro",meta:["nick","mail","link"],requiredFields:[],pageSize:10,lang:"zh-CN",highlight:!1,recordIP:!1,serverURLs:"",emojiCDN:null,emojiMaps:null,enableQQ:!1},{el:"#valine",path:window.location.pathname});new Valine(i),Fluid.utils.waitElementVisible("#valine .vcontent",()=>{var i="#valine .vcontent img:not(.vemoji)";Fluid.plugins.imageCaption(i),Fluid.plugins.fancyBox(i)})}))}))</script><noscript>Please enable JavaScript to view the comments</noscript></article></article></div></div></div><div class="side-col d-none d-lg-block col-lg-2"><aside class="sidebar" style="margin-left:-1rem"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p><div class="toc-body" id="toc-body"></div></div></aside></div></div></div><a id="scroll-top-button" aria-label="TOP" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">搜索</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">关键词</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div></main><footer><div class="footer-inner"><div class="footer-content"><span>由<a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a>强力驱动</span> <i class="iconfont icon-love"></i> <span>主题</span> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> <i class="iconfont icon-love"></i> <span>©2022 - 2023</span></div><div class="statistics"><span id="leancloud-site-pv-container" style="display:none">总访问量 <span id="leancloud-site-pv"></span> 次 </span><span id="leancloud-site-uv-container" style="display:none">总访问客数 <span id="leancloud-site-uv"></span> 人</span></div><div class="beian"><span><a href="http://beian.miit.gov.cn/" target="_blank" rel="nofollow noopener">黔ICP备2022006994号-2 </a></span><span><a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=http://beian.miit.gov.cn/" rel="nofollow noopener" class="beian-police" target="_blank"><span style="visibility:hidden;width:0">|</span> <img src="/img/police_beian.png" srcset="/img/loading.gif" lazyload alt="police-icon"> <span>黔公网安备2022006994号</span></a></span></div></div></footer><script src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js"></script><link rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css"><script>NProgress.configure({showSpinner:!1,trickleSpeed:100}),NProgress.start(),window.addEventListener("load",(function(){NProgress.done()}))</script><script src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js"></script><script src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js"></script><script src="/js/events.js"></script><script src="/js/plugins.js"></script><script src="/js/img-lazyload.js"></script><script>Fluid.utils.createScript("https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js",(function(){var t=jQuery("#toc");if(0!==t.length&&window.tocbot){var i=jQuery("#board-ctn").offset().top;window.tocbot.init(Object.assign({tocSelector:"#toc-body",contentSelector:".markdown-body",linkClass:"tocbot-link",activeLinkClass:"tocbot-active-link",listClass:"tocbot-list",isCollapsedClass:"tocbot-is-collapsed",collapsibleClass:"tocbot-is-collapsible",scrollSmooth:!0,includeTitleTags:!0,headingsOffset:-i},CONFIG.toc)),t.find(".toc-list-item").length>0&&t.css("visibility","visible"),Fluid.events.registerRefreshCallback((function(){if("tocbot"in window){tocbot.refresh();var t=jQuery("#toc");if(0===t.length||!tocbot)return;t.find(".toc-list-item").length>0&&t.css("visibility","visible")}}))}}))</script><script src="https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js"></script><script>Fluid.plugins.codeWidget()</script><script>Fluid.utils.createScript("https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js",(function(){window.anchors.options={placement:CONFIG.anchorjs.placement,visible:CONFIG.anchorjs.visible},CONFIG.anchorjs.icon&&(window.anchors.options.icon=CONFIG.anchorjs.icon);var n=(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","),o=[];for(var s of n)o.push(".markdown-body > "+s.trim());"left"===CONFIG.anchorjs.placement&&(window.anchors.options.class="anchorjs-link-left"),window.anchors.add(o.join(", ")),Fluid.events.registerRefreshCallback((function(){if("anchors"in window){anchors.removeAll();var n=(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","),o=[];for(var s of n)o.push(".markdown-body > "+s.trim());"left"===CONFIG.anchorjs.placement&&(anchors.options.class="anchorjs-link-left"),anchors.add(o.join(", "))}}))}))</script><script>Fluid.utils.createScript("https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js",(function(){Fluid.plugins.fancyBox()}))</script><script>Fluid.plugins.imageCaption()</script><script defer src="/js/leancloud.js"></script><script src="/js/local-search.js"></script><script src="/js/caidai.js"></script><script src="/js/love.main.js"></script><script src="/js/boot.js"></script><noscript><div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div></noscript></body></html>