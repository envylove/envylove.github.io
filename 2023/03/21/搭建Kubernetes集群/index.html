<!DOCTYPE html><html lang="zh-CN" data-default-color-scheme="auto"><head><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.ico"><link rel="icon" href="/img/favicon.ico"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta name="theme-color" content="#2f4154"><meta name="author" content="yuankun"><meta name="keywords" content="hexo,theme,fluid,linux,ops,运维,分享"><meta name="description" content="Kubernetes 是一个开源的容器编排引擎，用来对容器化应用进行自动化部署、 扩缩和管理"><meta property="og:type" content="article"><meta property="og:title" content="搭建Kubernetes集群"><meta property="og:url" content="https://itshare.work/2023/03/21/%E6%90%AD%E5%BB%BAKubernetes%E9%9B%86%E7%BE%A4/index.html"><meta property="og:site_name" content="Cookie Blog"><meta property="og:description" content="Kubernetes 是一个开源的容器编排引擎，用来对容器化应用进行自动化部署、 扩缩和管理"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://itshare.work/image.assets/1679388005874.png"><meta property="article:published_time" content="2023-03-20T16:14:18.000Z"><meta property="article:modified_time" content="2023-03-21T14:07:06.860Z"><meta property="article:author" content="yuankun"><meta property="article:tag" content="Kubernetes"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image" content="https://itshare.work/image.assets/1679388005874.png"><title>搭建Kubernetes集群 - Cookie Blog</title><link rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css"><link rel="stylesheet" href="/css/main.css"><link id="highlight-css" rel="stylesheet" href="/css/highlight.css"><link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css"><link rel="stylesheet" href="/css/tbdzj.css"><script id="fluid-configs">var Fluid=window.Fluid||{};Fluid.ctx=Object.assign({},Fluid.ctx);var CONFIG={hostname:"itshare.work",root:"/",version:"1.9.3",typing:{enable:!1,typeSpeed:70,cursorChar:" ",loop:!0,scope:[]},anchorjs:{enable:!0,element:"h1,h2,h3,h4,h5,h6",placement:"left",visible:"hover",icon:""},progressbar:{enable:!0,height_px:3,color:"#29d",options:{showSpinner:!1,trickleSpeed:100}},code_language:{enable:!0,default:"text"},copy_btn:!0,image_caption:{enable:!0},image_zoom:{enable:!0,img_url_replace:["",""]},toc:{enable:!0,placement:"right",headingSelector:"h1,h2,h3,h4,h5,h6",collapseDepth:0},lazyload:{enable:!0,loading_img:"/img/loading.gif",onlypost:!1,offset_factor:2},web_analytics:{enable:!0,follow_dnt:!0,baidu:null,google:null,gtag:null,tencent:{sid:null,cid:null},woyaola:null,cnzz:null,leancloud:{app_id:"hQDROocUhxVs3CipuQjO33sY-gzGzoHsz",app_key:"CHcmi9bz6KRRaChFJVSY14g1",server_url:"https://hqdroocu.lc-cn-n1-shared.com",path:"window.location.pathname",ignore_local:!0}},search_path:"/local-search.xml"};if(CONFIG.web_analytics.follow_dnt){var dntVal=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack;Fluid.ctx.dnt=dntVal&&(dntVal.startsWith("1")||dntVal.startsWith("yes")||dntVal.startsWith("on"))}</script><script src="/js/utils.js"></script><script src="/js/color-schema.js"></script><meta name="generator" content="Hexo 6.3.0"></head><body><header><div class="header-inner" style="height:70vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/"><strong>Cookie</strong> </a><button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/"><i class="iconfont icon-home-fill"></i> 首页</a></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" target="_self" href="javascript:;" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><i class="iconfont icon-books"></i> 文章</a><div class="dropdown-menu" aria-labelledby="navbarDropdown"><a class="dropdown-item" href="/archives/"><i class="iconfont icon-archive-fill"></i> 归档 </a><a class="dropdown-item" href="/categories/"><i class="iconfont icon-category-fill"></i> 分类 </a><a class="dropdown-item" href="/tags/"><i class="iconfont icon-tags-fill"></i> 标签</a></div></li><li class="nav-item"><a class="nav-link" href="/about/"><i class="iconfont icon-user-fill"></i> 关于</a></li><li class="nav-item"><a class="nav-link" href="/links/"><i class="iconfont icon-link-fill"></i> 友链</a></li><li class="nav-item" id="search-btn"><a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">&nbsp;<i class="iconfont icon-search"></i>&nbsp;</a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a></li></ul></div></div></nav><div id="banner" class="banner" parallax="true" style="background:url(/img/default.png) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="banner-text text-center fade-in-up"><div class="h2"><span id="subtitle">搭建Kubernetes集群</span></div><div class="mt-3"><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2023-03-21 00:14" pubdate>2023年3月21日 凌晨</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 14k 字 </span><span class="post-meta mr-2"><i class="iconfont icon-clock-fill"></i> 115 分钟 </span><span id="leancloud-page-views-container" class="post-meta" style="display:none"><i class="iconfont icon-eye" aria-hidden="true"></i> <span id="leancloud-page-views"></span> 次</span></div></div></div></div></div></div></header><main><div class="container-fluid nopadding-x"><div class="row nomargin-x"><div class="side-col d-none d-lg-block col-lg-2"></div><div class="col-lg-8 nopadding-x-md"><div class="container nopadding-x-md" id="board-ctn"><div id="board"><article class="post-content mx-auto"><h1 style="display:none">搭建Kubernetes集群</h1><div class="markdown-body"><h1 id="部署前提"><a href="#部署前提" class="headerlink" title="部署前提"></a>部署前提</h1><ul><li>使用kubeadm部署Kubernetes集群的前提条件</li><li>支持Kubernetes运行的Linux主机，例如Debian、RedHat及其变体等</li><li>每主机2GB以上的内存，以及2颗以上的CPU</li><li>各主机间能够通过网络无障碍通信</li><li>独占的hostname、MAC地址以及product_uuid，主机名能够正常解析</li><li>放行由Kubernetes使用到的各端口，或直接禁用iptables</li><li>禁用各主机的上的Swap设备</li><li>各主机时间同步</li></ul><h1 id="部署环境"><a href="#部署环境" class="headerlink" title="部署环境"></a>部署环境</h1><ul><li>OS: Ubuntu 20.04.2 LTS</li><li>Docker：20.10.10，CGroup Driver: systemd</li><li>Kubernetes：v1.26.3, CRI: containerd, CNI: Flannel</li><li>主机</li></ul><table><thead><tr><th>主机IP</th><th>主机名称</th><th>角色</th></tr></thead><tbody><tr><td>192.168.32.200</td><td>k8s-master01.org</td><td>master</td></tr><tr><td>192.168.32.203</td><td>k8s-node01.org</td><td>node01</td></tr><tr><td>192.168.32.204</td><td>k8s-node02.org</td><td>node02</td></tr><tr><td>192.168.32.205</td><td>k8s-node03.org</td><td>node03</td></tr></tbody></table><h1 id="修改主机名称"><a href="#修改主机名称" class="headerlink" title="修改主机名称"></a>修改主机名称</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># 修改192.168.32.200的主机名称为k8s-master01.org</span><br><span class="hljs-comment"># 修改192.168.32.203的主机名称为k8s-node01.org</span><br><span class="hljs-comment"># 修改192.168.32.204的主机名称为k8s-node02.org</span><br><span class="hljs-comment"># 修改192.168.32.205的主机名称为k8s-node03.org</span><br></code></pre></td></tr></table></figure><h1 id="主机时间同步"><a href="#主机时间同步" class="headerlink" title="主机时间同步"></a>主机时间同步</h1><p>在所有主机上安装 chrony</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># 所有主机上执行</span><br>root@k8s-master01:~<span class="hljs-comment"># apt install -y chrony</span><br></code></pre></td></tr></table></figure><p>建议用户配置使用本地的的时间服务器，在节点数量众多时尤其如此。存在可用的本地时间服务器时，修改节点的&#x2F;etc&#x2F;chrony&#x2F;chrony.conf配置文件，并将时间服务器指向相应的主机即可，配置格式如下：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">server CHRONY-SERVER-NAME-OR-IP iburst<br></code></pre></td></tr></table></figure><h1 id="主机名称解析"><a href="#主机名称解析" class="headerlink" title="主机名称解析"></a>主机名称解析</h1><p>出于简化配置步骤的目的，本测试环境使用hosts文件进行各节点名称解析，文件内容如下所示。其中，我们使用kubeapi主机名作为API Server在高可用环境中的专用接入名称，也为控制平面的高可用配置留下便于配置的余地。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># 编辑/etc/hosts文件加入如下内容</span><br>root@k8s-master01:~<span class="hljs-comment"># vim /etc/hosts</span><br>192.168.32.200 k8s-master01.org<br>192.168.32.203 k8s-node01.org<br>192.168.32.204 k8s-node02.org<br>192.168.32.205 k8s-node03.org<br></code></pre></td></tr></table></figure><h1 id="禁用Swap设备"><a href="#禁用Swap设备" class="headerlink" title="禁用Swap设备"></a>禁用Swap设备</h1><p>部署集群时，kubeadm默认会预先检查当前主机是否禁用了Swap设备，并在未禁用时强制终止部署过程。因此，在主机内存资源充裕的条件下，需要禁用所有的Swap设备，否则，就需要在后文的kubeadm init及kubeadm join命令执行时额外使用相关的选项忽略检查错误。</p><p>关闭Swap设备，需要分两步完成。首先是关闭当前已启用的所有Swap设备：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># 临时关闭，所有机器执行</span><br>root@k8s-master01:~<span class="hljs-comment"># swapoff -a</span><br></code></pre></td></tr></table></figure><p>而后编辑&#x2F;etc&#x2F;fstab配置文件，注释用于挂载Swap设备的所有行</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># 所有机器执行</span><br>root@k8s-master01:~<span class="hljs-comment">#vim /etc/fstab</span><br><span class="hljs-comment"># 注释如下一行</span><br><span class="hljs-comment">#/swap.img      none    swap    sw      0       0</span><br></code></pre></td></tr></table></figure><h4 id="禁用默认的防火墙服务"><a href="#禁用默认的防火墙服务" class="headerlink" title="禁用默认的防火墙服务"></a>禁用默认的防火墙服务</h4><p>Ubuntu和Debian等Linux发行版默认使用ufw（Uncomplicated FireWall）作为前端来简化 iptables的使用，处于启用状态时，它默认会生成一些规则以加强系统安全。出于降低配置复杂度之目的，本文选择直接将其禁用。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sh">root@k8s-master01:~<span class="hljs-comment"># ufw disable</span><br>Firewall stopped and disabled on system startup<br>root@k8s-master01:~<span class="hljs-comment"># ufw status</span><br>Status: inactive<br>root@k8s-master01:~<span class="hljs-comment"># </span><br></code></pre></td></tr></table></figure><h1 id="安装程序包"><a href="#安装程序包" class="headerlink" title="安装程序包"></a>安装程序包</h1><p>提示：以下操作需要在本示例中的所有四台主机上分别进行。</p><h2 id="安装并启动docker"><a href="#安装并启动docker" class="headerlink" title="安装并启动docker"></a>安装并启动docker</h2><p>首先，生成docker-ce相关程序包的仓库，这里以阿里云的镜像服务器为例进行说明：</p><p><a target="_blank" rel="noopener" href="https://developer.aliyun.com/mirror/docker-ce?spm=a2c6h.13651102.0.0.3e221b11ewAl2r">docker-ce镜像_docker-ce下载地址_docker-ce安装教程-阿里巴巴开源镜像站 (aliyun.com)</a></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># step 1: 安装必要的一些系统工具</span><br>sudo apt-get update<br>sudo apt-get -y install apt-transport-https ca-certificates curl software-properties-common<br><span class="hljs-comment"># step 2: 安装GPG证书</span><br>curl -fsSL https://mirrors.aliyun.com/docker-ce/linux/ubuntu/gpg | sudo apt-key add -<br><span class="hljs-comment"># Step 3: 写入软件源信息</span><br>sudo add-apt-repository <span class="hljs-string">&quot;deb [arch=amd64] https://mirrors.aliyun.com/docker-ce/linux/ubuntu <span class="hljs-subst">$(lsb_release -cs)</span> stable&quot;</span><br><span class="hljs-comment"># Step 4: 更新并安装Docker-CE</span><br>sudo apt-get -y update<br>sudo apt-get -y install docker-ce<br><br><span class="hljs-comment"># 安装指定版本的Docker-CE:</span><br><span class="hljs-comment"># Step 1: 查找Docker-CE的版本:</span><br><span class="hljs-comment"># apt-cache madison docker-ce</span><br><span class="hljs-comment">#   docker-ce | 17.03.1~ce-0~ubuntu-xenial | https://mirrors.aliyun.com/docker-ce/linux/ubuntu xenial/stable amd64 Packages</span><br><span class="hljs-comment">#   docker-ce | 17.03.0~ce-0~ubuntu-xenial | https://mirrors.aliyun.com/docker-ce/linux/ubuntu xenial/stable amd64 Packages</span><br><span class="hljs-comment"># Step 2: 安装指定版本的Docker-CE: (VERSION例如上面的17.03.1~ce-0~ubuntu-xenial)</span><br><span class="hljs-comment"># sudo apt-get -y install docker-ce=[VERSION]</span><br></code></pre></td></tr></table></figure><p>本文以为20.10.10版本为例</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">root@k8s-node3:~<span class="hljs-comment"># apt install docker-ce=5:20.10.10~3-0~ubuntu-focal docker-ce-cli=5:20.10.10~3-0~ubuntu-focal</span><br></code></pre></td></tr></table></figure><p>kubelet需要让docker容器引擎使用systemd作为CGroup的驱动，其默认值为cgroupfs，因而，我们还需要编辑docker的配置文件&#x2F;etc&#x2F;docker&#x2F;daemon.json，添加如下内容，其中的registry-mirrors用于指明使用的镜像加速服务。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs sh">vim /etc/docker/daemon.json<br>&#123;<br><span class="hljs-string">&quot;registry-mirrors&quot;</span>: [<br>  <span class="hljs-string">&quot;https://ung2thfc.mirror.aliyuncs.com&quot;</span>,<br>  <span class="hljs-string">&quot;https://mirror.ccs.tencentyun.com&quot;</span>,<br>  <span class="hljs-string">&quot;https://registry.docker-cn.com&quot;</span>,<br>  <span class="hljs-string">&quot;http://hub-mirror.c.163.com&quot;</span>,<br>  <span class="hljs-string">&quot;https://docker.mirrors.ustc.edu.cn&quot;</span>],<br><span class="hljs-string">&quot;exec-opts&quot;</span>: [<span class="hljs-string">&quot;native.cgroupdriver=systemd&quot;</span>]<br>&#125;<br><br>systemctl daemon-reload &amp;&amp; systemctl restart docker<br></code></pre></td></tr></table></figure><h1 id="安装cri-dockerd"><a href="#安装cri-dockerd" class="headerlink" title="安装cri-dockerd"></a>安装cri-dockerd</h1><p>Kubernetes自v1.24移除了对docker-shim的支持，而Docker Engine默认又不支持CRI规范，因而二者将无法直接完成整合。为此，Mirantis和Docker联合创建了cri-dockerd项目，用于为Docker Engine提供一个能够支持到CRI规范的垫片，从而能够让Kubernetes基于CRI控制Docker 。</p><blockquote><p>项目地址：<a target="_blank" rel="noopener" href="https://github.com/Mirantis/cri-dockerd">https://github.com/Mirantis/cri-dockerd</a></p></blockquote><p>cri-dockerd项目提供了预制的二进制格式的程序包，用户按需下载相应的系统和对应平台的版本即可完成安装，这里以Ubuntu 2004 64bits系统环境，以及cri-dockerd目前最新的程序版本v0.3.0为例。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs sh">wget https://github.com/Mirantis/cri-dockerd/releases/download/v0.3.0/cri-dockerd_0.3.0.3-0.ubuntu-focal_amd64.deb<br><br>dpkg -i cri-dockerd_0.3.0.3-0.ubuntu-focal_amd64.deb<br></code></pre></td></tr></table></figure><p>完成安装后，相应的服务cri-dockerd.service便会自动启动。我们也可以使用如下命令进行验证，若服务处于Running状态即可进行后续步骤 。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs sh">root@k8s-master01:~<span class="hljs-comment"># systemctl status cri-docker.service</span><br>● cri-docker.service - CRI Interface <span class="hljs-keyword">for</span> Docker Application Container Engine<br>     Loaded: loaded (/lib/systemd/system/cri-docker.service; enabled; vendor preset: enabled)<br>     Active: active (running) since Tue 2023-03-21 10:59:57 CST; 1min 20s ago<br>TriggeredBy: ● cri-docker.socket<br>       Docs: https://docs.mirantis.com<br>   Main PID: 17591 (cri-dockerd)<br>      Tasks: 7<br>     Memory: 11.9M<br>     CGroup: /system.slice/cri-docker.service<br>             └─17591 /usr/bin/cri-dockerd --container-runtime-endpoint fd://<br><br>Mar 21 10:59:57 k8s-master01.org cri-dockerd[17591]: time=<span class="hljs-string">&quot;2023-03-21T10:59:57+08:00&quot;</span> level=info msg=<span class="hljs-string">&quot;Start docker client with request timeout 0s&quot;</span><br>Mar 21 10:59:57 k8s-master01.org cri-dockerd[17591]: time=<span class="hljs-string">&quot;2023-03-21T10:59:57+08:00&quot;</span> level=info msg=<span class="hljs-string">&quot;Hairpin mode is set to none&quot;</span><br>Mar 21 10:59:57 k8s-master01.org cri-dockerd[17591]: time=<span class="hljs-string">&quot;2023-03-21T10:59:57+08:00&quot;</span> level=info msg=<span class="hljs-string">&quot;Loaded network plugin cni&quot;</span><br>Mar 21 10:59:57 k8s-master01.org cri-dockerd[17591]: time=<span class="hljs-string">&quot;2023-03-21T10:59:57+08:00&quot;</span> level=info msg=<span class="hljs-string">&quot;Docker cri networking managed by network plugin cni&quot;</span><br>Mar 21 10:59:57 k8s-master01.org systemd[1]: Started CRI Interface <span class="hljs-keyword">for</span> Docker Application Container Engine.<br>Mar 21 10:59:58 k8s-master01.org cri-dockerd[17591]: time=<span class="hljs-string">&quot;2023-03-21T10:59:57+08:00&quot;</span> level=info msg=<span class="hljs-string">&quot;Docker Info: &amp;&#123;ID:WQBA:P7R2:H6ZI:KWU3:FVFW:MHLC:QTT7:CJCX&gt;</span><br><span class="hljs-string">Mar 21 10:59:58 k8s-master01.org cri-dockerd[17591]: time=&quot;</span>2023-03-21T10:59:57+08:00<span class="hljs-string">&quot; level=info msg=&quot;</span>Setting cgroupDriver cgroupfs<span class="hljs-string">&quot;</span><br><span class="hljs-string">Mar 21 10:59:58 k8s-master01.org cri-dockerd[17591]: time=&quot;</span>2023-03-21T10:59:57+08:00<span class="hljs-string">&quot; level=info msg=&quot;</span>Docker cri received runtime config &amp;RuntimeConfig&#123;Network&gt;<br>Mar 21 10:59:58 k8s-master01.org cri-dockerd[17591]: time=<span class="hljs-string">&quot;2023-03-21T10:59:57+08:00&quot;</span> level=info msg=<span class="hljs-string">&quot;Starting the GRPC backend for the Docker CRI interface.&quot;</span><br>Mar 21 10:59:58 k8s-master01.org cri-dockerd[17591]: time=<span class="hljs-string">&quot;2023-03-21T10:59:57+08:00&quot;</span> level=info msg=<span class="hljs-string">&quot;Start cri-dockerd grpc backend&quot;</span><br>lines 1-21/21 (END)<br></code></pre></td></tr></table></figure><h1 id="安装kubelet、kubeadm和kubectl"><a href="#安装kubelet、kubeadm和kubectl" class="headerlink" title="安装kubelet、kubeadm和kubectl"></a>安装kubelet、kubeadm和kubectl</h1><p>首先，在各主机上生成kubelet和kubeadm等相关程序包的仓库，这里以阿里云的镜像服务为例：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs sh">apt-get update &amp;&amp; apt-get install -y apt-transport-https<br>curl https://mirrors.aliyun.com/kubernetes/apt/doc/apt-key.gpg | apt-key add - <br><span class="hljs-built_in">cat</span> &lt;&lt;<span class="hljs-string">EOF &gt;/etc/apt/sources.list.d/kubernetes.list</span><br><span class="hljs-string">deb https://mirrors.aliyun.com/kubernetes/apt/ kubernetes-xenial main</span><br><span class="hljs-string">EOF</span><br>apt-get update<br>apt-get install -y kubelet kubeadm kubectl<br></code></pre></td></tr></table></figure><p>安装完成后，要确保kubeadm等程序文件的版本，这将也是后面初始化Kubernetes集群时需要明确指定的版本号。</p><h3 id="整合kubelet和cri-dockerd"><a href="#整合kubelet和cri-dockerd" class="headerlink" title="整合kubelet和cri-dockerd"></a>整合kubelet和cri-dockerd</h3><p>仅支持CRI规范的kubelet需要经由遵循该规范的cri-dockerd完成与docker-ce的整合。</p><h4 id="配置cri-dockerd"><a href="#配置cri-dockerd" class="headerlink" title="配置cri-dockerd"></a>配置cri-dockerd</h4><p>配置cri-dockerd，确保其能够正确加载到CNI插件。编辑&#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;cri-docker.service文件，确保其[Service]配置段中的ExecStart的值类似如下内容。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">ExecStart=/usr/bin/cri-dockerd --container-runtime-endpoint fd:// --network-plugin=cni --pod-infra-container-image=registry.aliyuncs.com/google_containers/pause:3.7 --cni-bin-dir=/opt/cni/bin --cni-cache-dir=/var/lib/cni/cache --cni-conf-dir=/etc/cni/net.d<br></code></pre></td></tr></table></figure><p>需要添加的各配置参数（各参数的值要与系统部署的CNI插件的实际路径相对应）：</p><ul><li>–network-plugin：指定网络插件规范的类型，这里要使用CNI；</li><li>–cni-bin-dir：指定CNI插件二进制程序文件的搜索目录；</li><li>–cni-cache-dir：CNI插件使用的缓存目录；</li><li>–cni-conf-dir：CNI插件加载配置文件的目录；</li></ul><p>配置完成后，重载并重启cri-docker.service服务。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">root@k8s-master01:~<span class="hljs-comment"># systemctl daemon-reload;systemctl restart cri-docker</span><br></code></pre></td></tr></table></figure><h1 id="配置kubelet"><a href="#配置kubelet" class="headerlink" title="配置kubelet"></a>配置kubelet</h1><p>配置kubelet，为其指定cri-dockerd在本地打开的Unix Sock文件的路径，该路径一般默认为“&#x2F;run&#x2F;cri-dockerd.sock“。编辑文件&#x2F;etc&#x2F;sysconfig&#x2F;kubelet，为其添加 如下指定参数。</p><blockquote><p>提示：若&#x2F;etc&#x2F;sysconfig目录不存在，则需要先创建该目录。</p></blockquote><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">KUBELET_KUBEADM_ARGS=<span class="hljs-string">&quot;--container-runtime=remote --container-runtime-endpoint=/run/cri-dockerd.sock&quot;</span><br></code></pre></td></tr></table></figure><p>需要说明的是，该配置也可不进行，而是直接在后面的各kubeadm命令上使用“–cri-socket unix:&#x2F;&#x2F;&#x2F;run&#x2F;cri-dockerd.sock”选项。</p><h3 id="初始化第一个主节点"><a href="#初始化第一个主节点" class="headerlink" title="初始化第一个主节点"></a>初始化第一个主节点</h3><p>该步骤开始尝试构建Kubernetes集群的master节点，配置完成后，各worker节点直接加入到集群中的即可。需要特别说明的是，由kubeadm部署的Kubernetes集群上，集群核心组件kube-apiserver、kube-controller-manager、kube-scheduler和etcd等均会以静态Pod的形式运行，它们所依赖的镜像文件默认来自于registry.k8s.io这一Registry服务之上。但我们无法直接访问该服务，常用的解决办法有如下两种</p><ul><li>使用能够到达该服务的代理服务；</li><li>使用国内的镜像服务器上的服务，例如registry.aliyuncs.com&#x2F;google_containers等。</li></ul><h4 id="初始化master节点（在k8s-master01上完成如下操作）"><a href="#初始化master节点（在k8s-master01上完成如下操作）" class="headerlink" title="初始化master节点（在k8s-master01上完成如下操作）"></a>初始化master节点（在k8s-master01上完成如下操作）</h4><p>运行如下命令完成k8s-master01节点的初始化：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">kubeadm init --image-repository registry.aliyuncs.com/google_containers --kubernetes-version=v1.26.3 --pod-network-cidr=10.244.0.0/16 --service-cidr=10.96.0.0/12 --token-ttl=0 --cri-socket unix:///run/cri-dockerd.sock<br></code></pre></td></tr></table></figure><p>命令中的各选项简单说明如下：</p><ul><li>–image-repository：指定要使用的镜像仓库，默认为registry.k8s.io；</li><li>–kubernetes-version：kubernetes程序组件的版本号，它必须要与安装的kubelet程序包的版本号相同；</li><li>–control-plane-endpoint：控制平面的固定访问端点，可以是IP地址或DNS名称，会被用于集群管理员及集群组件的kubeconfig配置文件的API Server的访问地址；单控制平面部署时可以不使用该选项；</li><li>–pod-network-cidr：Pod网络的地址范围，其值为CIDR格式的网络地址，通常，Flannel网络插件的默认为10.244.0.0&#x2F;16，Project Calico插件的默认值为192.168.0.0&#x2F;16；</li><li>–service-cidr：Service的网络地址范围，其值为CIDR格式的网络地址，默认为10.96.0.0&#x2F;12；通常，仅Flannel一类的网络插件需要手动指定该地址；</li><li>–apiserver-advertise-address：apiserver通告给其他组件的IP地址，一般应该为Master节点的用于集群内部通信的IP地址，0.0.0.0表示节点上所有可用地址；</li><li>–token-ttl：共享令牌（token）的过期时长，默认为24小时，0表示永不过期；为防止不安全存储等原因导致的令牌泄露危及集群安全，建议为其设定过期时长。未设定该选项时，在token过期后，若期望再向集群中加入其它节点，可以使用如下命令重新创建token，并生成节点加入命令。</li></ul><h5 id="初始化完成后的操作步骤"><a href="#初始化完成后的操作步骤" class="headerlink" title="初始化完成后的操作步骤"></a>初始化完成后的操作步骤</h5><p>对于Kubernetes系统的新用户来说，无论使用上述哪种方法，命令运行结束后，请记录最后的kubeadm join命令输出的最后提示的操作步骤。下面的内容是需要用户记录的一个命令输出示例，它提示了后续需要的操作步骤。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs sh"><span class="hljs-comment"># 下面是成功完成第一个控制平面节点初始化的提示信息及后续需要完成的步骤</span><br>Your Kubernetes control-plane has initialized successfully!<br><br><span class="hljs-comment"># 为了完成初始化操作，管理员需要额外手动完成几个必要的步骤</span><br>To start using your cluster, you need to run the following as a regular user:<br><br><span class="hljs-comment"># 第1个步骤提示， Kubernetes集群管理员认证到Kubernetes集群时使用的kubeconfig配置文件</span><br><span class="hljs-built_in">mkdir</span> -p <span class="hljs-variable">$HOME</span>/.kube<br>sudo <span class="hljs-built_in">cp</span> -i /etc/kubernetes/admin.conf <span class="hljs-variable">$HOME</span>/.kube/config<br>sudo <span class="hljs-built_in">chown</span> $(<span class="hljs-built_in">id</span> -u):$(<span class="hljs-built_in">id</span> -g) <span class="hljs-variable">$HOME</span>/.kube/config<br><br><span class="hljs-comment"># 我们也可以不做上述设定，而使用环境变量KUBECONFIG为kubectl等指定默认使用的kubeconfig；</span><br>Alternatively, <span class="hljs-keyword">if</span> you are the root user, you can run:<br><br><span class="hljs-built_in">export</span> KUBECONFIG=/etc/kubernetes/admin.conf<br><br><span class="hljs-comment"># 第2个步骤提示，为Kubernetes集群部署一个网络插件，具体选用的插件则取决于管理员；</span><br>You should now deploy a pod network to the cluster.<br>Run <span class="hljs-string">&quot;kubectl apply -f [podnetwork].yaml&quot;</span> with one of the options listed at:<br>https://kubernetes.io/docs/concepts/cluster-administration/addons/<br><br><span class="hljs-comment"># 第3个步骤提示，向集群添加额外的控制平面节点，但本文会略过该步骤，并将在其它文章介绍其实现方式。</span><br>You can now <span class="hljs-built_in">join</span> any number of the control-plane node running the following <span class="hljs-built_in">command</span> on each as root:<br><br><span class="hljs-comment"># 第4个步骤提示，向集群添加工作节点</span><br>Then you can <span class="hljs-built_in">join</span> any number of worker nodes by running the following on each as root:<br><br><span class="hljs-comment"># 在部署好kubeadm等程序包的各工作节点上以root用户运行类似如下命令；</span><br><span class="hljs-comment"># 提示：与cri-dockerd结合使用docker-ce作为container runtime时，通常需要为下面的命令</span><br><span class="hljs-comment">#     额外附加“--cri-socket unix:///run/cri-dockerd.sock”选项；</span><br>kubeadm <span class="hljs-built_in">join</span> 192.168.32.200:6443 --token ivu3t7.pogk70dd5pualoz2 \<br>	--discovery-token-ca-cert-hash sha256:3edb3c8e3e6c944afe65b2616d46b49305c1420e6967c1fab966ddf8f149502d<br></code></pre></td></tr></table></figure><h4 id="设定kubectl"><a href="#设定kubectl" class="headerlink" title="设定kubectl"></a>设定kubectl</h4><p>kubectl是kube-apiserver的命令行客户端程序，实现了除系统部署之外的几乎全部的管理操作，是kubernetes管理员使用最多的命令之一。kubectl需经由API server认证及授权后方能执行相应的管理操作，kubeadm部署的集群为其生成了一个具有管理员权限的认证配置文件&#x2F;etc&#x2F;kubernetes&#x2F;admin.conf，它可由kubectl通过默认的“$HOME&#x2F;.kube&#x2F;config”的路径进行加载。当然，用户也可在kubectl命令上使用–kubeconfig选项指定一个别的位置。</p><p>下面复制认证为Kubernetes系统管理员的配置文件至目标用户（例如当前用户root）的家目录下：</p><p>~# mkdir ~&#x2F;.kube</p><p>~# cp &#x2F;etc&#x2F;kubernetes&#x2F;admin.conf ~&#x2F;.kube&#x2F;config</p><h4 id="部署网络插件"><a href="#部署网络插件" class="headerlink" title="部署网络插件"></a>部署网络插件</h4><p>Kubernetes系统上Pod网络的实现依赖于第三方插件进行，这类插件有近数十种之多，较为著名的有flannel、calico、canal和kube-router等，简单易用的实现是为CoreOS提供的flannel项目。下面的命令用于在线部署flannel至Kubernetes系统之上：</p><p>首先，下载适配系统及硬件平台环境的flanneld至每个节点，并放置于&#x2F;opt&#x2F;bin&#x2F;目录下。我们这里选用flanneld-amd64，目前最新的版本为v0.21.3，因而，我们需要在集群的每个节点上执行如下命令：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs sh">~<span class="hljs-comment"># mkdir /opt/cni/bin/</span><br><br>~<span class="hljs-comment"># curl -L https://github.com/flannel-io/flannel/releases/download/v0.20.2/flanneld-amd64  -o /opt/cni/bin/flanneld</span><br><br>~<span class="hljs-comment"># chmod +x /opt/cni/bin/flanneld</span><br><br>提示：下载flanneld的地址为 https://github.com/flannel-io/flannel/releases<br></code></pre></td></tr></table></figure><p>随后，在初始化的第一个master节点k8s-master01上运行如下命令，向Kubernetes部署kube-flannel。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">kubectl apply -f https://raw.githubusercontent.com/flannel-io/flannel/v0.21.3/Documentation/kube-flannel.yml<br></code></pre></td></tr></table></figure><p>而后使用如下命令确认其输出结果中Pod的状态为“Running”，类似如下命令及其输入的结果所示：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sh">root@k8s-master01:~<span class="hljs-comment">#  kubectl get pods -n kube-flannel</span><br>NAME                    READY   STATUS    RESTARTS   AGE<br>kube-flannel-ds-jgkxd   1/1     Running   0          2m59s<br>root@k8s-master01:~<span class="hljs-comment"># </span><br></code></pre></td></tr></table></figure><h4 id="验证master节点已经就绪"><a href="#验证master节点已经就绪" class="headerlink" title="验证master节点已经就绪"></a>验证master节点已经就绪</h4><p>kubectl get nodes</p><p>上述命令应该会得到类似如下输出，这表示k8s-master01节点已经就绪</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sh">root@k8s-master01:~<span class="hljs-comment"># kubectl get nodes</span><br>NAME               STATUS   ROLES           AGE   VERSION<br>k8s-master01.org   Ready    control-plane   62m   v1.26.3<br>root@k8s-master01:~<span class="hljs-comment"># </span><br></code></pre></td></tr></table></figure><h4 id="添加节点到集群中"><a href="#添加节点到集群中" class="headerlink" title="添加节点到集群中"></a>添加节点到集群中</h4><p>下面的两个步骤，需要分别在k8s-node01、k8s-node02和k8s-node03上各自完成。</p><p>1、若未禁用Swap设备，编辑kubelet的配置文件&#x2F;etc&#x2F;default&#x2F;kubelet，设置其忽略Swap启用的状态错误，内容如下：KUBELET_EXTRA_ARGS&#x3D;”–fail-swap-on&#x3D;false”</p><p>2、将节点加入第二步中创建的master的集群中，要使用主节点初始化过程中记录的kubeadm join命令；</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">root@k8s-node01:/opt/cni/bin<span class="hljs-comment"># kubeadm join 192.168.32.200:6443 --token ivu3t7.pogk70dd5pualoz2 --discovery-token-ca-cert-hash sha256:3edb3c8e3e6c944afe65b2616d46b49305c1420e6967c1fab966ddf8f149502d --cri-socket unix:///run/cri-dockerd.sock</span><br></code></pre></td></tr></table></figure><h4 id="验证节点添加结果"><a href="#验证节点添加结果" class="headerlink" title="验证节点添加结果"></a>验证节点添加结果</h4><p>在每个节点添加完成后，即可通过kubectl验证添加结果。下面的命令及其输出是在所有的三个节点均添加完成后运行的，其输出结果表明三个Worker Node已经准备就绪。</p><p>~# kubectl get nodes</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs sh">root@k8s-master01:~<span class="hljs-comment"># kubectl get nodes</span><br>NAME               STATUS   ROLES           AGE    VERSION<br>k8s-master01.org   Ready    control-plane   80m    v1.26.3<br>k8s-node01.org     Ready    &lt;none&gt;          15m    v1.26.3<br>k8s-node2.org      Ready    &lt;none&gt;          114s   v1.26.3<br>k8s-node3.org      Ready    &lt;none&gt;          11m    v1.26.3<br>root@k8s-master01:~<span class="hljs-comment"># </span><br></code></pre></td></tr></table></figure><p>root@k8s-master01:<del># kubectl get nodes<br>NAME STATUS ROLES AGE VERSION<br>k8s-master01.org Ready control-plane 80m v1.26.3<br>k8s-node01.org Ready<none>15m v1.26.3<br>k8s-node2.org Ready<none>114s v1.26.3<br>k8s-node3.org Ready<none>11m v1.26.3<br>root@k8s-master01:</none></none></none></del>#</p><h4 id="测试应用编排及服务访问"><a href="#测试应用编排及服务访问" class="headerlink" title="测试应用编排及服务访问"></a>测试应用编排及服务访问</h4><p>到此为止，一个master，并附带有三个worker的kubernetes集群基础设施已经部署完成，用户随后即可测试其核心功能。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sh">root@k8s-master01:~<span class="hljs-comment"># kubectl create deployment test-nginx --image=nginx:latest --replicas=3</span><br>deployment.apps/test-nginx created<br>root@k8s-master01:~<span class="hljs-comment"># </span><br>root@k8s-master01:~<span class="hljs-comment"># kubectl create service nodeport test-nginx --tcp=80:80</span><br>service/test-nginx created<br>root@k8s-master01:~<span class="hljs-comment"># </span><br></code></pre></td></tr></table></figure><p>而后，使用如下命令了解Service对象test-nginx使用的NodePort，以便于在集群外部进行访问：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sh">root@k8s-master01:~<span class="hljs-comment"># kubectl get svc -l app=test-nginx</span><br>NAME         TYPE       CLUSTER-IP       EXTERNAL-IP   PORT(S)        AGE<br>test-nginx   NodePort   10.100.229.239   &lt;none&gt;        80:31888/TCP   50s<br>root@k8s-master01:~<span class="hljs-comment"># </span><br></code></pre></td></tr></table></figure><p>因此，用户可以于集群外部通过“<a href="http://NodeIP:31888”这个URL访问web应用，例如于集群外通过浏览器访问“http://192.168.32.203:31888”。">http://NodeIP:31888”这个URL访问web应用，例如于集群外通过浏览器访问“http://192.168.32.203:31888”。</a></p><p><img src="/../image.assets/1679388005874.png" srcset="/img/loading.gif" lazyload alt="1679388005874"></p><h1 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h1><p>本文给出了部署Kubernetes分布式集群的具体步骤，并在最后测试了将应用部署并运行于Kubernetes系统上的结果。在读者朋友们自行测试时，cri-dockerd、docker-ce、flannel、kubeadm、kubectl和kubelet的版本均可能存在版本上的不同，也因此可能会存在一定程度上的配置差异，具体调整方式请大家自行参考相关的文档进行。</p></div><hr><div><div class="post-metas my-3"><div class="post-meta"><i class="iconfont icon-tags"></i> <a href="/tags/Kubernetes/">#Kubernetes</a></div></div><div class="license-box my-3"><div class="license-title"><div>搭建Kubernetes集群</div><div>https://itshare.work/2023/03/21/搭建Kubernetes集群/</div></div><div class="license-meta"><div class="license-meta-item"><div>作者</div><div>yuankun</div></div><div class="license-meta-item license-meta-date"><div>发布于</div><div>2023年3月21日</div></div><div class="license-meta-item license-meta-date"><div>更新于</div><div>2023年3月21日</div></div><div class="license-meta-item"><div>许可协议</div><div><a target="_blank" href="https://creativecommons.org/licenses/by/4.0/"><span class="hint--top hint--rounded" aria-label="BY - 署名"><i class="iconfont icon-by"></i></span></a></div></div></div><div class="license-icon iconfont"></div></div><div class="post-prevnext my-3"><article class="post-prev col-6"></article><article class="post-next col-6"><a href="/2023/03/18/Zookeeper%E7%A6%BB%E7%BA%BF%E5%AE%89%E8%A3%85%E8%84%9A%E6%9C%AC/" title="Zookeeper离线安装脚本"><span class="hidden-mobile">Zookeeper离线安装脚本</span> <span class="visible-mobile">下一篇</span> <i class="iconfont icon-arrowright"></i></a></article></div></div><article id="comments" lazyload><div id="valine"></div><script type="text/javascript">Fluid.utils.loadComments("#valine",(function(){Fluid.utils.createScript("https://lib.baomitu.com/valine/1.5.1/Valine.min.js",(function(){var i=Object.assign({appId:"hQDROocUhxVs3CipuQjO33sY-gzGzoHsz",appKey:"CHcmi9bz6KRRaChFJVSY14g1",path:"window.location.pathname",placeholder:"请在这里书写你想说的话······",avatar:"retro",meta:["nick","mail","link"],requiredFields:[],pageSize:10,lang:"zh-CN",highlight:!1,recordIP:!1,serverURLs:"",emojiCDN:null,emojiMaps:null,enableQQ:!1},{el:"#valine",path:window.location.pathname});new Valine(i),Fluid.utils.waitElementVisible("#valine .vcontent",()=>{var i="#valine .vcontent img:not(.vemoji)";Fluid.plugins.imageCaption(i),Fluid.plugins.fancyBox(i)})}))}))</script><noscript>Please enable JavaScript to view the comments</noscript></article></article></div></div></div><div class="side-col d-none d-lg-block col-lg-2"><aside class="sidebar" style="margin-left:-1rem"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p><div class="toc-body" id="toc-body"></div></div></aside></div></div></div><a id="scroll-top-button" aria-label="TOP" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">搜索</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">关键词</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div></main><footer><div class="footer-inner"><div class="footer-content"><span>由<a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a>强力驱动</span> <i class="iconfont icon-love"></i> <span>主题</span> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> <i class="iconfont icon-love"></i> <span>©2022 - 2023</span></div><div class="statistics"><span id="leancloud-site-pv-container" style="display:none">总访问量 <span id="leancloud-site-pv"></span> 次 </span><span id="leancloud-site-uv-container" style="display:none">总访问客数 <span id="leancloud-site-uv"></span> 人</span></div><div class="beian"><span><a href="http://beian.miit.gov.cn/" target="_blank" rel="nofollow noopener">黔ICP备2022006994号-2 </a></span><span><a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=http://beian.miit.gov.cn/" rel="nofollow noopener" class="beian-police" target="_blank"><span style="visibility:hidden;width:0">|</span> <img src="/img/police_beian.png" srcset="/img/loading.gif" lazyload alt="police-icon"> <span>黔公网安备2022006994号</span></a></span></div></div></footer><script src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js"></script><link rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css"><script>NProgress.configure({showSpinner:!1,trickleSpeed:100}),NProgress.start(),window.addEventListener("load",(function(){NProgress.done()}))</script><script src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js"></script><script src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js"></script><script src="/js/events.js"></script><script src="/js/plugins.js"></script><script src="/js/img-lazyload.js"></script><script>Fluid.utils.createScript("https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js",(function(){var t=jQuery("#toc");if(0!==t.length&&window.tocbot){var i=jQuery("#board-ctn").offset().top;window.tocbot.init(Object.assign({tocSelector:"#toc-body",contentSelector:".markdown-body",linkClass:"tocbot-link",activeLinkClass:"tocbot-active-link",listClass:"tocbot-list",isCollapsedClass:"tocbot-is-collapsed",collapsibleClass:"tocbot-is-collapsible",scrollSmooth:!0,includeTitleTags:!0,headingsOffset:-i},CONFIG.toc)),t.find(".toc-list-item").length>0&&t.css("visibility","visible"),Fluid.events.registerRefreshCallback((function(){if("tocbot"in window){tocbot.refresh();var t=jQuery("#toc");if(0===t.length||!tocbot)return;t.find(".toc-list-item").length>0&&t.css("visibility","visible")}}))}}))</script><script src="https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js"></script><script>Fluid.plugins.codeWidget()</script><script>Fluid.utils.createScript("https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js",(function(){window.anchors.options={placement:CONFIG.anchorjs.placement,visible:CONFIG.anchorjs.visible},CONFIG.anchorjs.icon&&(window.anchors.options.icon=CONFIG.anchorjs.icon);var n=(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","),o=[];for(var s of n)o.push(".markdown-body > "+s.trim());"left"===CONFIG.anchorjs.placement&&(window.anchors.options.class="anchorjs-link-left"),window.anchors.add(o.join(", ")),Fluid.events.registerRefreshCallback((function(){if("anchors"in window){anchors.removeAll();var n=(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","),o=[];for(var s of n)o.push(".markdown-body > "+s.trim());"left"===CONFIG.anchorjs.placement&&(anchors.options.class="anchorjs-link-left"),anchors.add(o.join(", "))}}))}))</script><script>Fluid.utils.createScript("https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js",(function(){Fluid.plugins.fancyBox()}))</script><script>Fluid.plugins.imageCaption()</script><script defer src="/js/leancloud.js"></script><script src="/js/local-search.js"></script><script src="/js/caidai.js"></script><script src="/js/love.main.js"></script><script src="/js/boot.js"></script><noscript><div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div></noscript></body></html>